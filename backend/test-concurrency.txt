
> backend@1.0.0 test
> jest edge-cases-concurrency.test.js

[dotenv@17.2.3] injecting env (28) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
15:51:47 [32mðŸ§ª Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

15:51:48 [32mðŸ§ª Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] âœ… Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] âœ… Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] ðŸ“Š Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] ðŸ“Š Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] âœ… Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] ðŸ“‹ Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] ðŸ“Š Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] ðŸŽ¯ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! ðŸš€"}}

      at Object.log (validators/body-validators.js:21:11)

15:51:50 [34mNew database client connected to pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 10ms[39m
15:51:50 [32mCustomer created[39m {"customerId":1}
15:51:50 [33mâš ï¸  PUT /api/customers/1 â†’ 404 (36ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/1 â†’ 404 (4ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/1 â†’ 404 (4ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/1 â†’ 404 (3ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/1 â†’ 404 (3ms)[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 14ms[39m
15:51:50 [33mCustomer permanently deleted[39m {"customerId":1}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 5ms[39m
15:51:50 [32mCustomer created[39m {"customerId":2}
15:51:50 [33mâš ï¸  PUT /api/customers/2 â†’ 404 (3ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/2 â†’ 404 (4ms)[39m
15:51:50 [33mâš ï¸  PUT /api/customers/2 â†’ 404 (3ms)[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 6ms[39m
15:51:50 [33mCustomer permanently deleted[39m {"customerId":2}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 6ms[39m
15:51:50 [32mCustomer created[39m {"customerId":3}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 28ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 29ms[39m
15:51:50 [32mCustomer deactivated[39m {"customerId":3}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 10ms[39m
15:51:50 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
15:51:50 [32mâœ… DELETE /3 â†’ 200 (91ms)[39m
15:51:50 [34mNew database client connected to pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mNew database client connected to pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 101ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 99ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 7ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 8ms[39m
15:51:50 [32mCustomer deactivated[39m {"customerId":3}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 11ms[39m
15:51:50 [32mCustomer deactivated[39m {"customerId":3}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
15:51:50 [32mâœ… DELETE /3 â†’ 200 (140ms)[39m
15:51:50 [34mQuery executed in 15ms[39m
15:51:50 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
15:51:50 [32mâœ… DELETE /3 â†’ 200 (141ms)[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/3","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 31ms[39m
15:51:50 [32mâœ… GET /3 â†’ 200 (51ms)[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 6ms[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 13ms[39m
15:51:50 [32mInventory item created[39m {"inventoryId":1}
15:51:50 [33mâš ï¸  PUT /api/inventory/1 â†’ 404 (8ms)[39m
15:51:50 [33mâš ï¸  PUT /api/inventory/1 â†’ 404 (7ms)[39m
15:51:50 [33mâš ï¸  PUT /api/inventory/1 â†’ 404 (8ms)[39m
15:51:50 [33mâš ï¸  PUT /api/inventory/1 â†’ 404 (7ms)[39m
15:51:50 [33mâš ï¸  PUT /api/inventory/1 â†’ 404 (5ms)[39m
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 25ms[39m
15:51:50 [33mInventory item permanently deleted[39m {"inventoryId":1}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 8ms[39m
15:51:50 [32mCustomer created[39m {"customerId":4}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 9ms[39m
15:51:50 [32mCustomer created[39m {"customerId":5}
15:51:50 [34mClient acquired from pool[39m
15:51:50 [34mQuery executed in 20ms[39m
15:51:50 [32mWork order created[39m {"workOrderId":1}
15:51:51 [33mâš ï¸  PUT /api/work-orders/1 â†’ 404 (7ms)[39m
15:51:51 [33mâš ï¸  PUT /api/work-orders/1 â†’ 404 (15ms)[39m
15:51:51 [33mâš ï¸  PUT /api/work-orders/1 â†’ 404 (9ms)[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 12ms[39m
15:51:51 [33mWork order permanently deleted[39m {"workOrderId":1}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 11ms[39m
15:51:51 [33mCustomer permanently deleted[39m {"customerId":5}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 6ms[39m
15:51:51 [33mCustomer permanently deleted[39m {"customerId":4}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 6ms[39m
15:51:51 [32mCustomer created[39m {"customerId":6}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [33mâš ï¸  PUT /api/customers/6 â†’ 404 (4ms)[39m
15:51:51 [33mâš ï¸  PUT /api/customers/6 â†’ 404 (3ms)[39m
15:51:51 [33mâš ï¸  PUT /api/customers/6 â†’ 404 (4ms)[39m
15:51:51 [33mâš ï¸  PUT /api/customers/6 â†’ 404 (3ms)[39m
15:51:51 [33mâš ï¸  PUT /api/customers/6 â†’ 404 (4ms)[39m
15:51:51 [34mQuery executed in 63ms[39m
15:51:51 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/6","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 63ms[39m
15:51:51 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/6","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 62ms[39m
15:51:51 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/6","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 30ms[39m
15:51:51 [32mâœ… GET /6 â†’ 200 (98ms)[39m
15:51:51 [34mQuery executed in 29ms[39m
15:51:51 [32mâœ… GET /6 â†’ 200 (97ms)[39m
15:51:51 [34mQuery executed in 27ms[39m
15:51:51 [32mâœ… GET /6 â†’ 200 (96ms)[39m
15:51:51 [34mNew database client connected to pool[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mNew database client connected to pool[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 120ms[39m
15:51:51 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/6","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 134ms[39m
15:51:51 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/6","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 11ms[39m
15:51:51 [32mâœ… GET /6 â†’ 200 (138ms)[39m
15:51:51 [34mQuery executed in 11ms[39m
15:51:51 [32mâœ… GET /6 â†’ 200 (150ms)[39m
15:51:51 [34mClient acquired from pool[39m
15:51:51 [34mQuery executed in 12ms[39m
15:51:51 [33mCustomer permanently deleted[39m {"customerId":6}
15:51:51 [34mClient acquired from pool[39m
FAIL integration __tests__/integration/edge-cases-concurrency.test.js
  Race Condition & Concurrency Tests
    Concurrent Updates
      Ã— should handle concurrent updates to same customer (195 ms)
      Ã— should handle concurrent updates to different fields (72 ms)
    Concurrent Deletes
      Ã— should handle multiple deletes of same resource gracefully (259 ms)
    Unique Constraint Races
      Ã— should prevent duplicate email creation in concurrent requests (14 ms)
      Ã— should prevent duplicate email creation in concurrent requests (5 ms)
    Inventory Stock Concurrent Updates
      Ã— should handle concurrent inventory stock updates (164 ms)
    Work Order Status Race Conditions
      Ã— should handle concurrent status updates (176 ms)
    Parallel Read/Write Operations
      âˆš should handle mixed concurrent reads and writes (247 ms)

  â— Race Condition & Concurrency Tests â€º Concurrent Updates â€º should handle concurrent updates to same customer

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 71 |[39m       
     [90m 72 |[39m       [90m// At least one should succeed[39m
    [31m[1m>[22m[39m[90m 73 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m    |[39m                            [31m[1m^[22m[39m
     [90m 74 |[39m       expect(successCount [33m+[39m failCount)[33m.[39mtoBe([35m5[39m)[33m;[39m
     [90m 75 |[39m
     [90m 76 |[39m       [90m// Verify final state if any succeeded[39m[0m

      at Object.toBeGreaterThanOrEqual (__tests__/integration/edge-cases-concurrency.test.js:73:28)

  â— Race Condition & Concurrency Tests â€º Concurrent Updates â€º should handle concurrent updates to different fields

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 109 |[39m       [90m// Most should succeed, some might fail  [39m
     [90m 110 |[39m       [36mconst[39m successCount [33m=[39m responses[33m.[39mfilter(r [33m=>[39m r[33m.[39mstatus [33m===[39m [35m200[39m)[33m.[39mlength[33m;[39m
    [31m[1m>[22m[39m[90m 111 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 112 |[39m
     [90m 113 |[39m       [90m// Final state should be consistent (no partial updates)[39m
     [90m 114 |[39m       [36mconst[39m finalState [33m=[39m [36mawait[39m request(app)[0m

      at Object.toBeGreaterThanOrEqual (__tests__/integration/edge-cases-concurrency.test.js:111:28)

  â— Race Condition & Concurrency Tests â€º Concurrent Deletes â€º should handle multiple deletes of same resource gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 200

    [0m [90m 153 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${adminToken}`[39m)[33m;[39m
     [90m 154 |[39m
    [31m[1m>[22m[39m[90m 155 |[39m       expect(verifyResponse[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 156 |[39m     })[33m;[39m
     [90m 157 |[39m   })[33m;[39m
     [90m 158 |[39m[0m

      at Object.toBe (__tests__/integration/edge-cases-concurrency.test.js:155:37)

  â— Race Condition & Concurrency Tests â€º Unique Constraint Races â€º should prevent duplicate email creation in concurrent requests

    TypeError: customers is not iterable

    [0m [90m 162 |[39m       [90m// Clean up any created customers[39m
     [90m 163 |[39m       [36mconst[39m customers [33m=[39m [36mawait[39m [33mCustomer[39m[33m.[39mfindAll({ email[33m:[39m testEmail })[33m;[39m
    [31m[1m>[22m[39m[90m 164 |[39m       [36mfor[39m ([36mconst[39m customer [36mof[39m customers) {
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 165 |[39m         [36mawait[39m [33mCustomer[39m[33m.[39m[36mdelete[39m(customer[33m.[39mid)[33m;[39m
     [90m 166 |[39m       }
     [90m 167 |[39m     })[33m;[39m[0m

      at Object.customers (__tests__/integration/edge-cases-concurrency.test.js:164:30)

  â— Race Condition & Concurrency Tests â€º Unique Constraint Races â€º should prevent duplicate email creation in concurrent requests

    ReferenceError: testEmail is not defined

    [0m [90m 175 |[39m           [33m.[39msend({
     [90m 176 |[39m             name[33m:[39m [32m`Duplicate Email ${index}`[39m[33m,[39m
    [31m[1m>[22m[39m[90m 177 |[39m             email[33m:[39m testEmail[33m,[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 178 |[39m             phone[33m:[39m [32m'1234567890'[39m[33m,[39m
     [90m 179 |[39m           })
     [90m 180 |[39m       )[33m;[39m[0m

      at testEmail (__tests__/integration/edge-cases-concurrency.test.js:177:20)
          at Array.map (<anonymous>)
      at Object.map (__tests__/integration/edge-cases-concurrency.test.js:171:43)

  â— Race Condition & Concurrency Tests â€º Inventory Stock Concurrent Updates â€º should handle concurrent inventory stock updates

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 231 |[39m       [90m// Most updates should succeed, some might fail[39m
     [90m 232 |[39m       [36mconst[39m successCount [33m=[39m responses[33m.[39mfilter(r [33m=>[39m r[33m.[39mstatus [33m===[39m [35m200[39m)[33m.[39mlength[33m;[39m
    [31m[1m>[22m[39m[90m 233 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 234 |[39m
     [90m 235 |[39m       [90m// Final quantity should match one of the updates[39m
     [90m 236 |[39m       [36mconst[39m finalState [33m=[39m [36mawait[39m request(app)[0m

      at Object.toBeGreaterThanOrEqual (__tests__/integration/edge-cases-concurrency.test.js:233:28)

  â— Race Condition & Concurrency Tests â€º Work Order Status Race Conditions â€º should handle concurrent status updates

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 327 |[39m       [90m// Most should succeed, some might fail[39m
     [90m 328 |[39m       [36mconst[39m successCount [33m=[39m responses[33m.[39mfilter(r [33m=>[39m r[33m.[39mstatus [33m===[39m [35m200[39m)[33m.[39mlength[33m;[39m
    [31m[1m>[22m[39m[90m 329 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 330 |[39m
     [90m 331 |[39m       [90m// Final status should be one of the attempted values[39m
     [90m 332 |[39m       [36mconst[39m finalState [33m=[39m [36mawait[39m request(app)[0m

      at Object.toBeGreaterThanOrEqual (__tests__/integration/edge-cases-concurrency.test.js:329:28)

Test Suites: 1 failed, 1 total
Tests:       7 failed, 1 passed, 8 total
Snapshots:   0 total
Time:        3.919 s
Ran all test suites matching edge-cases-concurrency.test.js.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path C:\Users\zarik\OneDrive\Desktop\TrossApp\backend
npm error workspace backend@1.0.0
npm error location C:\Users\zarik\OneDrive\Desktop\TrossApp\backend
npm error command failed
npm error command C:\WINDOWS\system32\cmd.exe /d /s /c jest edge-cases-concurrency.test.js
