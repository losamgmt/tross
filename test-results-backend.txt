
> backend@1.0.0 test
> jest

[dotenv@17.2.3] injecting env (28) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
13:47:59 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:01 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:02 [32müîß Dev auth: Generated token for admin@trossapp.dev (admin)[39m
13:48:02 [32müîß Dev auth: Generated token for admin@trossapp.dev (admin)[39m
13:48:02 [32m‚úÖ [mi6jaaw1jtisd] GET /token?role=admin ‚Üí 200 (18ms)[39m
13:48:02 [34mNew database client connected to pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 30ms[39m
13:48:02 [32m‚úÖ [mi6jaawylv1nt] GET / ‚Üí 200 (33ms)[39m
13:48:02 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/","userId":null,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 19ms[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 15ms[39m
13:48:02 [32m‚úÖ [mi6jaayaauqot] GET / ‚Üí 200 (47ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 38ms[39m
13:48:02 [32m‚úÖ [mi6jab0j75mvk] GET / ‚Üí 200 (41ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 39ms[39m
13:48:02 [32m‚úÖ [mi6jab1ata6yj] GET / ‚Üí 200 (41ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 44ms[39m
13:48:02 [32m‚úÖ [mi6jab1bmzgr6] GET / ‚Üí 200 (46ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 48ms[39m
13:48:02 [32m‚úÖ [mi6jab1d6uv03] GET / ‚Üí 200 (50ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mQuery executed in 51ms[39m
13:48:02 [32m‚úÖ [mi6jab1fel6cg] GET / ‚Üí 200 (54ms)[39m
13:48:02 [34mQuery executed in 56ms[39m
13:48:02 [32m‚úÖ [mi6jab1gv2pf5] GET / ‚Üí 200 (58ms)[39m
13:48:02 [34mNew database client connected to pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mNew database client connected to pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mNew database client connected to pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [34mNew database client connected to pool[39m
13:48:02 [34mClient acquired from pool[39m
13:48:02 [33müêå Slow query detected[39m {"duration":"112ms","query":"SELECT 1","params":0,"threshold":"100ms"}
13:48:02 [32m‚úÖ [mi6jab0ydxhnp] GET / ‚Üí 200 (114ms)[39m
13:48:02 [33müêå Slow query detected[39m {"duration":"121ms","query":"SELECT 1","params":0,"threshold":"100ms"}
13:48:02 [32m‚úÖ [mi6jab0tdras0] GET / ‚Üí 200 (123ms)[39m
13:48:02 [33müêå Slow query detected[39m {"duration":"132ms","query":"SELECT 1","params":0,"threshold":"100ms"}
13:48:02 [32m‚úÖ [mi6jab0nd0djn] GET / ‚Üí 200 (134ms)[39m
13:48:02 [33müêå Slow query detected[39m {"duration":"119ms","query":"SELECT 1","params":0,"threshold":"100ms"}
13:48:02 [32m‚úÖ [mi6jab1392ypd] GET / ‚Üí 200 (122ms)[39m
13:48:02 [34mClient acquired from pool[39m
13:48:03 [34mClient removed from pool[39m
13:48:03 [34mClient removed from pool[39m
13:48:03 [34mClient removed from pool[39m
13:48:03 [34mClient removed from pool[39m
13:48:12 [31mQuery error:[39m {"error":"canceling statement due to statement timeout","query":"SELECT pg_sleep(30)"}
13:48:12 [34mClient removed from pool[39m
13:48:12 [34mNew database client connected to pool[39m
13:48:12 [34mClient acquired from pool[39m
13:48:12 [34mQuery executed in 17ms[39m
13:48:12 [32m‚úÖ [mi6jaivu122gl] GET / ‚Üí 200 (19ms)[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/","userId":null,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:13 [34mQuery executed in 30ms[39m
13:48:13 [32m‚úÖ [mi6jaix5bdxbb] GET / ‚Üí 200 (32ms)[39m
13:48:13 [34mNew database client connected to pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mNew database client connected to pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 33ms[39m
13:48:13 [32m‚úÖ [mi6jaixlhi2ua] GET / ‚Üí 200 (35ms)[39m
13:48:13 [34mQuery executed in 45ms[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 6ms[39m
13:48:13 [32m‚úÖ [mi6jaix9cu852] GET / ‚Üí 200 (60ms)[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 5ms[39m
13:48:13 [32m‚úÖ [mi6jaiz6pl6tn] GET / ‚Üí 200 (7ms)[39m
PASS integration __tests__/integration/timeout.test.js (12.713 s)
  Timeout Architecture
    Request Timeout Middleware
      ‚àö should timeout long-running requests (47 ms)
      ‚àö should add request timing metadata (59 ms)
      ‚àö should handle concurrent requests without timeout issues (203 ms)
    Database Query Timeouts
      ‚àö should have query timeouts configured (1 ms)
      ‚àö should prevent hanging on database connection failure (1 ms)
      ‚àö should timeout long-running queries (10008 ms)
    Timeout Hierarchy Validation
      ‚àö should have proper timeout hierarchy (1 ms)
      ‚àö should have health check timeout less than request timeout (1 ms)
      ‚àö should have monitoring thresholds configured (1 ms)
    Timeout Error Responses
      ‚àö should return proper error format on timeout
      ‚àö should include timeout metadata in error response (1 ms)
    Slow Request Detection
      ‚àö should track request duration (29 ms)
      ‚àö should identify slow requests (1 ms)
    Production Timeout Configuration
      ‚àö should have reasonable production timeouts
      ‚àö should have faster test timeouts (1 ms)
    Graceful Timeout Handling
      ‚àö should not leak resources on timeout (88 ms)
      ‚àö should cleanup on request completion (15 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:13 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
13:48:13 [34mClient removed from pool[39m
13:48:13 [34mClient removed from pool[39m
13:48:13 [34mClient removed from pool[39m
13:48:13 [34mNew database client connected to pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 8ms[39m
13:48:13 [32mToken pair generated[39m {"userId":1,"tokenId":"b6939757-03ee-4f56-96f8-839a79a65d03","ipAddress":"127.0.0.1"}
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [31mQuery error:[39m {"error":"insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_fkey\"","query":"INSERT INTO refresh_tokens \n         (token_id, user_id, token_hash, expires_at, ip_address, user_agent)\n         VALUES ($1, $2, $3, $4, $5, $6)"}
13:48:13 [31mError generating token pair[39m {"error":"insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_fkey\"","userId":99999}
13:48:13 [34mClient removed from pool[39m
13:48:13 [34mNew database client connected to pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 7ms[39m
13:48:13 [32mToken pair generated[39m {"userId":1,"tokenId":"87859d58-637a-4825-82ba-553000d37700","ipAddress":null}
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mClient acquired from pool[39m
13:48:13 [34mQuery executed in 6ms[39m
13:48:13 [32mToken pair generated[39m {"userId":1,"tokenId":"5415f3ca-b7fb-4543-b071-93737140f318","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 5ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"af299757-7a89-43db-8fdd-d1c714c154f0","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"50bdef0c-da79-475b-a1ec-8d4c25b18b45","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 5ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"6148acf9-3299-4d33-add3-7398f1414285","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 6ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"5f747e7c-0306-4e2c-9bed-5a917a7b31a8","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 6ms[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 5ms[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"da5c883c-4258-4f27-8dec-b842b6388a1c","ipAddress":"192.168.1.1"}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 3ms[39m
13:48:14 [32mRefresh token revoked[39m {"tokenId":"5f747e7c-0306-4e2c-9bed-5a917a7b31a8","reason":"rotated"}
13:48:14 [32mAccess token refreshed[39m {"userId":1,"oldTokenId":"5f747e7c-0306-4e2c-9bed-5a917a7b31a8","ipAddress":"192.168.1.1"}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 5ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"1605bfa3-a325-4605-a70f-558b6998ec0f","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"9de76a22-2b19-4304-b64f-cb31b781a662","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 3ms[39m
13:48:14 [32mRefresh token revoked[39m {"tokenId":"1605bfa3-a325-4605-a70f-558b6998ec0f","reason":"rotated"}
13:48:14 [32mAccess token refreshed[39m {"userId":1,"oldTokenId":"1605bfa3-a325-4605-a70f-558b6998ec0f","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 6ms[39m
13:48:14 [32mToken pair generated[39m {"userId":1,"tokenId":"33bdcb43-89d2-4398-a972-73e1331e5054","ipAddress":null}
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mClient acquired from pool[39m
13:48:14 [34mQuery executed in 4ms[39m
13:48:14 [33mRefresh token not found or invalid[39m {"tokenId":"33bdcb43-89d2-4398-a972-73e1331e5054","userId":1}
13:48:14 [31mError refreshing token[39m {"error":"Invalid refresh token"}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 4ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"1a49d5e7-b807-4b30-bbad-39cf303b117d","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 4ms[39m
13:48:15 [33mRefresh token not found or invalid[39m {"tokenId":"1a49d5e7-b807-4b30-bbad-39cf303b117d","userId":1}
13:48:15 [31mError refreshing token[39m {"error":"Invalid refresh token"}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 5ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"10b2e24f-023e-4755-b23e-7433e424ba80","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 4ms[39m
13:48:15 [31mRefresh token hash mismatch[39m {"tokenId":"10b2e24f-023e-4755-b23e-7433e424ba80","userId":1}
13:48:15 [31mError refreshing token[39m {"error":"Invalid refresh token"}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 5ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"7a618add-38d3-4a3f-8e40-0ce1b3f02277","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 18ms[39m
13:48:15 [32mRefresh token revoked[39m {"tokenId":"7a618add-38d3-4a3f-8e40-0ce1b3f02277","reason":"user_logout"}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 4ms[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 5ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"38e9f827-a555-4445-b7c7-1c11738dcacc","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 5ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"c3e5d0ab-ec2b-46a0-a028-6c9e62209752","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 6ms[39m
13:48:15 [32mToken pair generated[39m {"userId":1,"tokenId":"d4f7fc44-8d32-4d19-9f08-eaa61f43258e","ipAddress":null}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 3ms[39m
13:48:15 [32mAll user tokens revoked[39m {"userId":1,"reason":"security_breach","count":3}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mQuery executed in 5ms[39m
13:48:15 [32mAll user tokens revoked[39m {"userId":1,"reason":"logout_all","count":0}
13:48:15 [34mClient acquired from pool[39m
13:48:15 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 5ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"648f8a25-fc17-4802-bfa4-5c53219bf646","ipAddress":null}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 4ms[39m
13:48:16 [32mExpired tokens cleaned up[39m {"count":1}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 5ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"95a6c791-0bc1-468d-a7dd-bd244fe1b79f","ipAddress":null}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 3ms[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 6ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"d2639d83-da02-4872-b2e6-4fa1f0a6d601","ipAddress":"127.0.0.1"}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 5ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"6550326e-3da2-49b6-a2a1-7a8dd1ac0f0b","ipAddress":"192.168.1.1"}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 4ms[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 4ms[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 7ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"14bd8c79-0d2f-4174-8832-60ca959e72b3","ipAddress":null}
13:48:16 [34mNew database client connected to pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mNew database client connected to pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mNew database client connected to pool[39m
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 22ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"65af08ba-f0e2-4a73-8332-faec15eb859e","ipAddress":null}
13:48:16 [34mQuery executed in 27ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"9bcdeb5a-0cf2-45be-919a-59919e2017d1","ipAddress":null}
13:48:16 [34mQuery executed in 26ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"7019d2df-4191-4df2-8734-eeb0cc0d6afc","ipAddress":null}
13:48:16 [34mClient acquired from pool[39m
13:48:16 [34mQuery executed in 5ms[39m
13:48:16 [32mToken pair generated[39m {"userId":1,"tokenId":"36182a65-6563-4342-ae24-aef3c4837980","ipAddress":null}
13:48:16 [34mClient acquired from pool[39m
PASS integration __tests__/integration/db/token-service-db.test.js
  TokenService - Integration Tests (Real DB)
    generateTokenPair()
      ‚àö should store refresh token in REAL database (246 ms)
      ‚àö should enforce foreign key constraint on user_id (146 ms)
      ‚àö should set correct expiration timestamp in database (169 ms)
      ‚àö should create unique token_id for each token (269 ms)
      ‚àö should handle NULL ip_address and user_agent (149 ms)
    refreshAccessToken()
      ‚àö should generate new token with REAL database verification (281 ms)
      ‚àö should update last_used_at timestamp (295 ms)
      ‚àö should reject expired token (database-level check) (139 ms)
      ‚àö should reject revoked token (database-level check) (134 ms)
      ‚àö should reject if token hash does not match (257 ms)
    revokeToken()
      ‚àö should set revoked_at timestamp in database (146 ms)
      ‚àö should handle non-existent token gracefully (61 ms)
    revokeAllUserTokens()
      ‚àö should revoke multiple tokens for a user (272 ms)
      ‚àö should return 0 for user with no tokens (72 ms)
    cleanupExpiredTokens()
      ‚àö should delete expired tokens from database (147 ms)
      ‚àö should not delete unexpired tokens (131 ms)
    getUserTokens()
      ‚àö should return all tokens for a user from database (202 ms)
      ‚àö should return empty array for user with no tokens (66 ms)
    Concurrent Operations
      ‚àö should handle concurrent token generation without conflicts (202 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:16 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:17 [34mNew database client connected to pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 10ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 5ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 19ms[39m
13:48:17 [32mAudit event[39m {"userId":2,"action":"role_create","resourceType":"role","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:17 [32m‚úÖ [mi6jama7wc1fq] POST / ‚Üí 201 (67ms)[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 20ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 7ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 6ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 4ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 6ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 5ms[39m
13:48:17 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:17 [32m‚úÖ [mi6jamehcq6z5] POST / ‚Üí 201 (59ms)[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient removed from pool[39m
13:48:17 [34mQuery executed in 6ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient removed from pool[39m
13:48:17 [34mQuery executed in 4ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient removed from pool[39m
13:48:17 [34mQuery executed in 4ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 3ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 3ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 4ms[39m
13:48:17 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:17 [32m‚úÖ [mi6jamhxtnctx] POST / ‚Üí 201 (35ms)[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 5ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"roles_name_key\"","query":"\n        INSERT INTO roles (name, priority)\n        VALUES ($1, $2)\n        RETURNING *\n      "}
13:48:17 [31mError creating role[39m {"error":"Role name already exists","roleName":"test_analyst_1763588897633_a99gw"}
13:48:17 [33m‚ö†Ô∏è  [mi6jamj3bet9u] POST / ‚Üí 409 (15ms)[39m
13:48:17 [34mClient removed from pool[39m
13:48:17 [34mClient removed from pool[39m
13:48:17 [34mNew database client connected to pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 13ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 5ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 7ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 5ms[39m
13:48:17 [33m‚ö†Ô∏è  [mi6jamm7j94nr] POST / ‚Üí 400 (40ms)[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 7ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 3ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 4ms[39m
13:48:17 [34mClient acquired from pool[39m
13:48:17 [34mQuery executed in 3ms[39m
13:48:17 [33m‚ö†Ô∏è  [mi6jampjnh5oo] POST / ‚Üí 400 (26ms)[39m
13:48:17 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":1,"userRole":"client","resource":"roles","operation":"create"}
13:48:18 [33m‚ö†Ô∏è  [mi6jams5xvyw9] POST / ‚Üí 403 (24ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:18 [33m‚ö†Ô∏è  [mi6jamuj8mbz4] POST / ‚Üí 401 (5ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:18 [32m‚úÖ [mi6jamwhewlex] PUT /6 ‚Üí 200 (53ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 9ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:18 [32m‚úÖ [mi6jan032cvha] PUT /6 ‚Üí 200 (54ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 9ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":10,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:18 [32m‚úÖ [mi6jan3vkdxdt] POST / ‚Üí 201 (55ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"roles_name_key\"","query":"\n        UPDATE roles \n        SET name = $1\n        WHERE id = $2\n        RETURNING *\n      "}
13:48:18 [31mError updating role[39m {"error":"Role name already exists","roleId":"6"}
13:48:18 [33m‚ö†Ô∏è  [mi6jan6051xis] PUT /6 ‚Üí 409 (37ms)[39m
13:48:18 [34mClient removed from pool[39m
13:48:18 [34mNew database client connected to pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 13ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 6ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [33m‚ö†Ô∏è  [mi6janatzkwvt] PUT /6 ‚Üí 400 (33ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 9ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [33m‚ö†Ô∏è  [mi6jandpdzexp] PUT /99999 ‚Üí 404 (34ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 7ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 5ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 3ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [31mError updating role[39m {"error":"Cannot modify protected role","roleId":"1"}
13:48:18 [33m‚ö†Ô∏è  [mi6jangmzd4fa] PUT /1 ‚Üí 400 (35ms)[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 4ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:18 [34mQuery executed in 8ms[39m
13:48:18 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 9ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [31mError updating role[39m {"error":"Cannot modify protected role","roleId":"5"}
13:48:19 [33m‚ö†Ô∏è  [mi6janjfwz4eb] PUT /5 ‚Üí 400 (46ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 10ms[39m
13:48:19 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/6","userId":1,"userRole":"client","resource":"roles","operation":"update"}
13:48:19 [33m‚ö†Ô∏è  [mi6janmgtk58x] PUT /6 ‚Üí 403 (32ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 8ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":11,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6janpg74ryg] POST / ‚Üí 201 (46ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_delete","resourceType":"role","resourceId":11,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6janr1t02y2] DELETE /11 ‚Üí 200 (33ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 11ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":12,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6jantvteec6] POST / ‚Üí 201 (58ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [31mError deleting role[39m {"error":"Role not found","roleId":"99999"}
13:48:19 [33m‚ö†Ô∏è  [mi6janvrhuby9] DELETE /99999 ‚Üí 404 (16ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 10ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":13,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6janyayxxel] POST / ‚Üí 201 (54ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 7ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [31mError deleting role[39m {"error":"Cannot delete protected role","roleId":"1"}
13:48:19 [33m‚ö†Ô∏è  [mi6jao0afjand] DELETE /1 ‚Üí 400 (20ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":14,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6jao2q11p3h] POST / ‚Üí 201 (38ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [31mError deleting role[39m {"error":"Cannot delete protected role","roleId":"5"}
13:48:19 [33m‚ö†Ô∏è  [mi6jao45qg21n] DELETE /5 ‚Üí 400 (13ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 8ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 2ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":15,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6jao64vgs83] POST / ‚Üí 201 (33ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":16,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6jao799iiqc] POST / ‚Üí 201 (18ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 5ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-user-role_1763588899867_zaz1v@test.com",
      "first_name": "User",
      "last_name": "WithRole",
      "role_id": 16
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588897302@test.com

      at log (routes/users.js:339:13)

13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 4ms[39m
13:48:19 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:19 [32m‚úÖ [mi6jao7ypx31b] POST / ‚Üí 201 (27ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 6ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 3ms[39m
13:48:19 [31mError deleting role[39m {"error":"Cannot delete role: 1 user(s) are assigned to this role. Use force=true to proceed and set their role to NULL.","roleId":"16"}
13:48:19 [33m‚ö†Ô∏è  [mi6jao8xuyv4r] DELETE /16 ‚Üí 400 (16ms)[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mClient acquired from pool[39m
13:48:19 [34mQuery executed in 8ms[39m
13:48:19 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":17,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaob2y8g91] POST / ‚Üí 201 (43ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 7ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/17","userId":2,"userRole":"client","resource":"roles","operation":"delete"}
13:48:20 [33m‚ö†Ô∏è  [mi6jaochtioio] DELETE /17 ‚Üí 403 (23ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 6ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":18,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaoetxt1hq] POST / ‚Üí 201 (35ms)[39m
13:48:20 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/18"}
13:48:20 [33m‚ö†Ô∏è  [mi6jaog1w4qd0] DELETE /18 ‚Üí 401 (6ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 6ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":19,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaoi04q4iz] POST / ‚Üí 201 (32ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 7ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 2ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":20,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaokujwjan] POST / ‚Üí 201 (33ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 7ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":20,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaolxttifv] PUT /20 ‚Üí 200 (29ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 6ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":21,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaoomadq0x] POST / ‚Üí 201 (32ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 5ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 2ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [32mAudit event[39m {"userId":1,"action":"role_delete","resourceType":"role","resourceId":21,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:20 [32m‚úÖ [mi6jaopon7w1x] DELETE /21 ‚Üí 200 (25ms)[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 3ms[39m
13:48:20 [34mClient acquired from pool[39m
13:48:20 [34mQuery executed in 4ms[39m
13:48:20 [34mClient acquired from pool[39m
PASS integration __tests__/integration/db/role-crud-db.test.js
  Role CRUD Operations - Integration Tests
    POST /api/roles - Create Role
      ‚àö should create a new role as admin (158 ms)
      ‚àö should normalize role name to lowercase (124 ms)
      ‚àö should reject duplicate role name (152 ms)
      ‚àö should reject request without name (118 ms)
      ‚àö should reject empty role name (97 ms)
      ‚àö should reject non-admin user (84 ms)
      ‚àö should reject unauthenticated request (68 ms)
    PUT /api/roles/:id - Update Role
      ‚àö should update role name as admin (130 ms)
      ‚àö should normalize updated role name to lowercase (134 ms)
      ‚àö should reject update to duplicate name (253 ms)
      ‚àö should reject update without name (101 ms)
      ‚àö should reject update for non-existent role (99 ms)
      ‚àö should reject update for protected role (admin) (105 ms)
      ‚àö should reject update for protected role (customer) (113 ms)
      ‚àö should reject non-admin user (108 ms)
    DELETE /api/roles/:id - Delete Role
      ‚àö should delete role as admin (157 ms)
      ‚àö should reject delete for non-existent role (159 ms)
      ‚àö should reject delete for protected role (admin) (161 ms)
      ‚àö should reject delete for protected role (customer) (122 ms)
      ‚àö should reject delete for role with assigned users (177 ms)
      ‚àö should reject non-admin user (135 ms)
      ‚àö should reject unauthenticated request (113 ms)
    Audit Logging for Role CRUD
      ‚àö should log role creation in audit_logs (103 ms)
      ‚àö should log role updates in audit_logs (136 ms)
      ‚àö should log role deletion in audit_logs (129 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:20 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:21 [34mNew database client connected to pool[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:21 [33m‚ö†Ô∏è  [mi6jap94ozvb6] GET / ‚Üí 401 (5ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 7ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":2,"userRole":"technician","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [32m‚úÖ [mi6jap9iy7a4d] GET /?page=1&limit=10 ‚Üí 200 (21ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [32m‚úÖ [mi6japaq55pmq] GET /?page=1&limit=10 ‚Üí 200 (17ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 2ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32m‚úÖ [mi6japbhhm81e] GET /?page=1&limit=10 ‚Üí 200 (17ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 2ms[39m
13:48:21 [32m‚úÖ [mi6japc62rqqg] GET /?page=1&limit=5 ‚Üí 200 (17ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=undefined","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 10ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32m‚úÖ [mi6japcxlvg20] GET /?page=1&limit=10&search=undefined ‚Üí 200 (23ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=email&sortOrder=ASC","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [32m‚úÖ [mi6japdv7t2l7] GET /?page=1&limit=10&sortBy=email&sortOrder=ASC ‚Üí 200 (19ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 6ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32m‚úÖ [mi6japemt0oi4] GET /?page=1&limit=10 ‚Üí 200 (17ms)[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/undefined"}
13:48:21 [33m‚ö†Ô∏è  [mi6japfcht9jn] GET /undefined ‚Üí 401 (4ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/undefined","userId":2,"userRole":"technician","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"undefined","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:21 [33m‚ö†Ô∏è  [mi6japfp7gkpa] GET /undefined ‚Üí 400 (11ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/undefined","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"undefined","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:21 [33m‚ö†Ô∏è  [mi6japgauwt0x] GET /undefined ‚Üí 400 (11ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 6ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [33m‚ö†Ô∏è  [mi6japgudl4d9] GET /99999 ‚Üí 404 (14ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:21 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:21 [33m‚ö†Ô∏è  [mi6japhi2vg6y] GET /invalid ‚Üí 400 (10ms)[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:21 [33m‚ö†Ô∏è  [mi6japi26x8wd] POST / ‚Üí 401 (8ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":2,"userRole":"technician","resource":"users","operation":"create"}
13:48:21 [33m‚ö†Ô∏è  [mi6japikdgcoo] POST / ‚Üí 403 (8ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588901562@example.com",
      "first_name": "New",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 6ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japj2t5xaf] POST / ‚Üí 201 (30ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588901602@example.com",
      "first_name": "Client",
      "last_name": "User",
      "role_id": 5
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japkbgtk2x] POST / ‚Üí 201 (25ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588901640@example.com",
      "first_name": "First",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 2ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":5,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japl9ztfyv] POST / ‚Üí 201 (27ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588901640@example.com",
      "first_name": "Second",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"users_email_key\"","query":"\n        INSERT INTO users (email, first_name, last_name, role_id, auth0_id, status) \n        VALUES ($1, $2, $3, $4, $5, $6) \n        RETURNING *\n      "}
13:48:21 [31mError creating user[39m {"error":"duplicate key value violates unique constraint \"users_email_key\"","email":"test-1763588901640@example.com"}
13:48:21 [31mError creating user[39m {"error":"Email already exists","email":"test-1763588901640@example.com"}
13:48:21 [33m‚ö†Ô∏è  [mi6japm98t7n7] POST / ‚Üí 409 (20ms)[39m
13:48:21 [34mClient removed from pool[39m
13:48:21 [34mNew database client connected to pool[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 27ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "invalid-email",
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [33m‚ö†Ô∏è  [mi6japn58xiiy] POST / ‚Üí 400 (33ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 6ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [33m‚ö†Ô∏è  [mi6japobyd6iu] POST / ‚Üí 400 (11ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "  test-1763588901770@example.com  ",
      "first_name": "  Whitespace  ",
      "last_name": "  Test  "
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588901169@test.com

      at log (routes/users.js:339:13)

13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 6ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japouzutou] POST / ‚Üí 201 (32ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/8"}
13:48:21 [33m‚ö†Ô∏è  [mi6japqcsdbz2] PUT /8 ‚Üí 401 (5ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/9","userId":2,"userRole":"technician","resource":"users","operation":"update"}
13:48:21 [33m‚ö†Ô∏è  [mi6japr3zm91v] PUT /9 ‚Üí 403 (11ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_update","resourceType":"user","resourceId":10,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japrzbwlbr] PUT /10 ‚Üí 200 (30ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 2ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 2ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [32mAudit event[39m {"userId":1,"action":"user_update","resourceType":"user","resourceId":11,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:21 [32m‚úÖ [mi6japtfdk0ub] PUT /11 ‚Üí 200 (27ms)[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 4ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 5ms[39m
13:48:21 [34mClient acquired from pool[39m
13:48:21 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [32mAudit event[39m {"userId":1,"action":"user_update","resourceType":"user","resourceId":12,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:22 [32m‚úÖ [mi6japurdkade] PUT /12 ‚Üí 200 (28ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [33m‚ö†Ô∏è  [mi6japw549h96] PUT /99999 ‚Üí 404 (14ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [32mAudit event[39m {"userId":1,"action":"user_update","resourceType":"user","resourceId":14,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:22 [32m‚úÖ [mi6japx5ko6md] PUT /14 ‚Üí 200 (28ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/14","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [32m‚úÖ [mi6japy55mf1e] GET /14 ‚Üí 200 (13ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/15/role"}
13:48:22 [33m‚ö†Ô∏è  [mi6japz93alvh] PUT /15/role ‚Üí 401 (5ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/16/role","userId":2,"userRole":"technician","resource":"users","operation":"update"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaq04lmjxk] PUT /16/role ‚Üí 403 (9ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [32mAudit event[39m {"userId":1,"action":"role_assign","resourceType":"user","resourceId":17,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:22 [32m‚úÖ [mi6jaq14fb21v] PUT /17/role ‚Üí 200 (31ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 6ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [31mError setting user role[39m {"error":"User not found","userId":99999,"roleId":2}
13:48:22 [31mError assigning role[39m {"error":"User not found","userId":"99999","roleId":2}
13:48:22 [33m‚ö†Ô∏è  [mi6jaq2n7v2ep] PUT /99999/role ‚Üí 500 (19ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [33m‚ö†Ô∏è  [mi6jaq3v3v8ms] PUT /19/role ‚Üí 404 (13ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33m‚ö†Ô∏è  [mi6jaq4x5xl4l] PUT /20/role ‚Üí 400 (10ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/21"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaq5tlem7k] DELETE /21 ‚Üí 401 (3ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/22","userId":2,"userRole":"technician","resource":"users","operation":"delete"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaq6jmdh4t] DELETE /22 ‚Üí 403 (8ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 7ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 8ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [32mAudit event[39m {"userId":1,"action":"user_delete","resourceType":"user","resourceId":23,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:22 [32m‚úÖ [mi6jaq7dierja] DELETE /23 ‚Üí 200 (30ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33m‚ö†Ô∏è  [mi6jaq8y7z4sx] DELETE /99999 ‚Üí 404 (14ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 4ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 7ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 7ms[39m
13:48:22 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"undefined","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaqa5a2yec] DELETE /undefined ‚Üí 400 (11ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 6ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [32mAudit event[39m {"userId":1,"action":"user_delete","resourceType":"user","resourceId":26,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:22 [32m‚úÖ [mi6jaqb2fa93c] DELETE /26 ‚Üí 200 (23ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 6ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/26","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [33m‚ö†Ô∏è  [mi6jaqbxuf0ae] GET /26 ‚Üí 404 (14ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [32m‚úÖ [mi6jaqcmk9n46] GET /?page=1&limit=10 ‚Üí 200 (19ms)[39m
13:48:22 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaqdfiuya0] GET / ‚Üí 401 (4ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 7ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:22 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{}","valueType":"object","reason":"limit is required","url":"/","method":"GET"}
13:48:22 [33m‚ö†Ô∏è  [mi6jaqdr54idc] GET / ‚Üí 400 (12ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 2ms[39m
13:48:22 [32m‚úÖ [mi6jaqebk8uy8] GET /?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 23ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 3ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 5ms[39m
13:48:22 [32m‚úÖ [mi6jaqfbxg2cv] GET /?page=1&limit=10 ‚Üí 200 (38ms)[39m
13:48:22 [34mNew database client connected to pool[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mNew database client connected to pool[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mNew database client connected to pool[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mNew database client connected to pool[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 43ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 55ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 69ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 11ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 70ms[39m
13:48:22 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"users","policy":"all_records","severity":"DEBUG"}
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 14ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 13ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 13ms[39m
13:48:22 [32m‚úÖ [mi6jaqfur2pgk] GET /?page=1&limit=10 ‚Üí 200 (73ms)[39m
13:48:22 [34mQuery executed in 12ms[39m
13:48:22 [34mClient acquired from pool[39m
13:48:22 [34mQuery executed in 11ms[39m
13:48:22 [32m‚úÖ [mi6jaqfo9qlsa] GET /?page=1&limit=10 ‚Üí 200 (87ms)[39m
13:48:22 [34mQuery executed in 15ms[39m
13:48:22 [32m‚úÖ [mi6jaqff2sny8] GET /?page=1&limit=10 ‚Üí 200 (101ms)[39m
13:48:22 [34mQuery executed in 15ms[39m
13:48:22 [32m‚úÖ [mi6jaqfkn8i7e] GET /?page=1&limit=10 ‚Üí 200 (102ms)[39m
13:48:22 [34mClient acquired from pool[39m
PASS integration __tests__/integration/users-api.test.js
  Users CRUD API - Integration Tests
    GET /api/users - List Users
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should allow technician to read users list (31 ms)
      ‚àö should return paginated user list for admin (39 ms)
      ‚àö should include user data in list (26 ms)
      ‚àö should support pagination parameters (24 ms)
      ‚àö should support search parameter (32 ms)
      ‚àö should support sorting (30 ms)
      ‚àö should include active and inactive users by default (25 ms)
    GET /api/users/:id - Get User by ID
      ‚àö should return 401 without authentication (11 ms)
      ‚àö should allow technician to read user by ID (22 ms)
      ‚àö should return user by ID for admin (19 ms)
      ‚àö should return 404 for non-existent user (23 ms)
      ‚àö should return 400 for invalid ID format (20 ms)
    POST /api/users - Create User
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for non-admin users (19 ms)
      ‚àö should create user with valid data (40 ms)
      ‚àö should create user with role_id (38 ms)
      ‚àö should reject duplicate email (67 ms)
      ‚àö should reject invalid email format (44 ms)
      ‚àö should reject missing required fields (19 ms)
      ‚àö should trim whitespace from names and email (41 ms)
    PUT /api/users/:id - Update User
      ‚àö should return 401 without authentication (26 ms)
      ‚àö should return 403 for non-admin users (33 ms)
      ‚àö should update user first name (52 ms)
      ‚àö should update user last name (48 ms)
      ‚àö should update is_active status (50 ms)
      ‚àö should return 404 for non-existent user (35 ms)
      ‚àö should persist updates to database (73 ms)
    PUT /api/users/:id/role - Assign Role
      ‚àö should return 401 without authentication (30 ms)
      ‚àö should return 403 for non-admin users (36 ms)
      ‚àö should assign role to user (57 ms)
      ‚àö should return error for non-existent user (44 ms)
      ‚àö should return 404 for non-existent role (37 ms)
      ‚àö should reject invalid role_id format (35 ms)
    DELETE /api/users/:id - Delete User
      ‚àö should return 401 without authentication (27 ms)
      ‚àö should return 403 for non-admin users (29 ms)
      ‚àö should delete user (53 ms)
      ‚àö should return 404 for non-existent user (39 ms)
      ‚àö should prevent self-deletion (40 ms)
      ‚àö should remove user from database (67 ms)
    Users API - Response Format
      ‚àö should return consistent success format (30 ms)
      ‚àö should return consistent error format (14 ms)
      ‚àö should include proper content-type (19 ms)
    Users API - Performance
      ‚àö should respond quickly to list requests (27 ms)
      ‚àö should handle concurrent requests (133 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:23 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:23 [34mNew database client connected to pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 7ms[39m
13:48:23 [32mCustomer created[39m {"customerId":1}
13:48:23 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:23 [33m‚ö†Ô∏è  [mi6jar23mymho] GET / ‚Üí 401 (5ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":4,"userRole":"technician","resource":"contracts","policy":"deny_all","severity":"DEBUG"}
13:48:23 [33mRLS deny_all policy for contracts[39m {"userId":4}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [34mNew database client connected to pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 24ms[39m
13:48:23 [32m‚úÖ [mi6jar2jevgks] GET /?page=1&limit=10 ‚Üí 200 (41ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 12ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":5,"userRole":"customer","resource":"contracts","policy":"own_contracts_only","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [34mQuery executed in 7ms[39m
13:48:23 [32m‚úÖ [mi6jar47cgtly] GET /?page=1&limit=10 ‚Üí 200 (26ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 8ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":3,"userRole":"dispatcher","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [32m‚úÖ [mi6jar5638q3n] GET /?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [32m‚úÖ [mi6jar5ya4wz7] GET /?page=1&limit=10 ‚Üí 200 (16ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 7ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [32m‚úÖ [mi6jar6omq8dt] GET /?page=1&limit=5 ‚Üí 200 (18ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 9ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [32m‚úÖ [mi6jar7g518ov] GET /?page=1&limit=10&search=test ‚Üí 200 (19ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient removed from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=contract_number&sortOrder=ASC","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [32m‚úÖ [mi6jar89exp5j] GET /?page=1&limit=10&sortBy=contract_number&sortOrder=ASC ‚Üí 200 (16ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"customer","resource":"contracts","policy":"own_contracts_only","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 3ms[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [32m‚úÖ [mi6jar90v0b7g] GET /?page=1&limit=100 ‚Üí 200 (15ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [32mContract created[39m {"contractId":1}
13:48:23 [34mClient removed from pool[39m
13:48:23 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:23 [33m‚ö†Ô∏è  [mi6jara0hl8ik] GET /1 ‚Üí 401 (4ms)[39m
13:48:23 [34mClient removed from pool[39m
13:48:23 [34mClient removed from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":3,"userRole":"dispatcher","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [32m‚úÖ [mi6jaraiczyam] GET /1 ‚Üí 200 (14ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 7ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 3ms[39m
13:48:23 [33m‚ö†Ô∏è  [mi6jarb699tzn] GET /99999 ‚Üí 404 (13ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 4ms[39m
13:48:23 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:23 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:23 [33m‚ö†Ô∏è  [mi6jarbtdgb9z] GET /invalid ‚Üí 400 (9ms)[39m
13:48:23 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:23 [33m‚ö†Ô∏è  [mi6jarcdosnok] POST / ‚Üí 401 (10ms)[39m
13:48:23 [34mClient removed from pool[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 6ms[39m
13:48:23 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":5,"userRole":"customer","resource":"contracts","operation":"create"}
13:48:23 [33m‚ö†Ô∏è  [mi6jarcxmkfjc] POST / ‚Üí 403 (11ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":4,"userRole":"technician","resource":"contracts","operation":"create"}
13:48:23 [33m‚ö†Ô∏è  [mi6jardiwtk49] POST / ‚Üí 403 (12ms)[39m
13:48:23 [34mClient acquired from pool[39m
13:48:23 [34mQuery executed in 5ms[39m
13:48:23 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":3,"userRole":"dispatcher","resource":"contracts","operation":"create"}
13:48:23 [33m‚ö†Ô∏è  [mi6jare417qll] POST / ‚Üí 403 (9ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":2}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32mAudit event[39m {"userId":2,"action":"create","resourceType":"contract","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarenfje2z] POST / ‚Üí 201 (23ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":3}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mAudit event[39m {"userId":2,"action":"create","resourceType":"contract","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarfjo1hh2] POST / ‚Üí 201 (19ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32mContract created[39m {"contractId":4}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"contracts_contract_number_key\"","query":"\n        INSERT INTO contracts (contract_number, customer_id, start_date, end_date, terms, value, billing_cycle, status)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING *\n      "}
13:48:24 [31mError creating contract[39m {"error":"duplicate key value violates unique constraint \"contracts_contract_number_key\"","code":"23505"}
13:48:24 [31mError creating contract[39m {"error":"duplicate key value violates unique constraint \"contracts_contract_number_key\""}
13:48:24 [33m‚ö†Ô∏è  [mi6jargif4lcl] POST / ‚Üí 409 (16ms)[39m
13:48:24 [34mClient removed from pool[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [33m‚ö†Ô∏è  [mi6jarhan6kcs] POST / ‚Üí 400 (8ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [31mError creating contract[39m {"error":"Contract number, customer_id, and start_date are required"}
13:48:24 [33m‚ö†Ô∏è  [mi6jarhsra5cu] POST / ‚Üí 500 (9ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [32mContract created[39m {"contractId":6}
13:48:24 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/6"}
13:48:24 [33m‚ö†Ô∏è  [mi6jarij6aaam] PATCH /6 ‚Üí 401 (6ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mContract created[39m {"contractId":7}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/7","userId":3,"userRole":"dispatcher","resource":"contracts","operation":"update"}
13:48:24 [33m‚ö†Ô∏è  [mi6jarj3xzmg8] PATCH /7 ‚Üí 403 (9ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":8}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract updated[39m {"contractId":8}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32mAudit event[39m {"userId":2,"action":"update","resourceType":"contract","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarjsbu1q9] PATCH /8 ‚Üí 200 (30ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mContract created[39m {"contractId":9}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 2ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32mContract updated[39m {"contractId":9}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 2ms[39m
13:48:24 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"contract","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarl1gs8m7] PATCH /9 ‚Üí 200 (26ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":10}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [33m‚ö†Ô∏è  [mi6jarm6oozak] PATCH /99999 ‚Üí 404 (13ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":11}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:24 [33m‚ö†Ô∏è  [mi6jarmymyb2c] PATCH /invalid ‚Üí 400 (8ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":12}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [33m‚ö†Ô∏è  [mi6jarnl10k6u] PATCH /12 ‚Üí 400 (9ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mContract created[39m {"contractId":13}
13:48:24 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/13"}
13:48:24 [33m‚ö†Ô∏è  [mi6jaro8u93vo] DELETE /13 ‚Üí 401 (4ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":14}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/14","userId":3,"userRole":"dispatcher","resource":"contracts","operation":"delete"}
13:48:24 [33m‚ö†Ô∏è  [mi6jaroq87a80] DELETE /14 ‚Üí 403 (8ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [32mContract created[39m {"contractId":15}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 2ms[39m
13:48:24 [33mContract permanently deleted[39m {"contractId":15}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mAudit event[39m {"userId":2,"action":"delete","resourceType":"contract","resourceId":15,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarpd6s0jn] DELETE /15 ‚Üí 200 (21ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mContract created[39m {"contractId":16}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [33mContract permanently deleted[39m {"contractId":16}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mAudit event[39m {"userId":1,"action":"delete","resourceType":"contract","resourceId":16,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:24 [32m‚úÖ [mi6jarqc4nn3h] DELETE /16 ‚Üí 200 (22ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [32mContract created[39m {"contractId":17}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 3ms[39m
13:48:24 [33m‚ö†Ô∏è  [mi6jarrbu85lq] DELETE /99999 ‚Üí 404 (14ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32mContract created[39m {"contractId":18}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:24 [33m‚ö†Ô∏è  [mi6jars3nua31] DELETE /invalid ‚Üí 400 (9ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"customer","resource":"contracts","policy":"own_contracts_only","severity":"DEBUG"}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [34mNew database client connected to pool[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 32ms[39m
13:48:24 [32m‚úÖ [mi6jarsneji8n] GET /?page=1&limit=100 ‚Üí 200 (43ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 13ms[39m
13:48:24 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"technician","resource":"contracts","policy":"deny_all","severity":"DEBUG"}
13:48:24 [33mRLS deny_all policy for contracts[39m {"userId":4}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [32m‚úÖ [mi6jaru4q6sme] GET /?page=1&limit=100 ‚Üí 200 (26ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 7ms[39m
13:48:24 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":1,"userRole":"admin","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mQuery executed in 5ms[39m
13:48:24 [32m‚úÖ [mi6jarv2auzbm] GET /?page=1&limit=100 ‚Üí 200 (19ms)[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":3,"userRole":"dispatcher","resource":"contracts","policy":"all_records","severity":"DEBUG"}
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mClient acquired from pool[39m
13:48:24 [34mQuery executed in 4ms[39m
13:48:24 [34mQuery executed in 6ms[39m
13:48:24 [32m‚úÖ [mi6jarvw6vzrg] GET /?page=1&limit=100 ‚Üí 200 (18ms)[39m
13:48:24 [34mClient acquired from pool[39m
PASS integration __tests__/integration/contracts-api.test.js
  Contracts CRUD API - Integration Tests
    GET /api/contracts - List Contracts
      ‚àö should return 401 without authentication (16 ms)
      ‚àö should return 403 for technician role (deny_all RLS) (61 ms)
      ‚àö should allow customer to read contracts list (RLS applies) (35 ms)
      ‚àö should return paginated contract list for dispatcher (28 ms)
      ‚àö should include contract data in list (24 ms)
      ‚àö should support pagination parameters (30 ms)
      ‚àö should support search parameter (28 ms)
      ‚àö should support sorting (25 ms)
      ‚àö should apply RLS filtering for customer role (26 ms)
    GET /api/contracts/:id - Get Contract by ID
      ‚àö should return 401 without authentication (19 ms)
      ‚àö should return contract by ID for dispatcher (26 ms)
      ‚àö should return 404 for non-existent contract (23 ms)
      ‚àö should return 400 for invalid ID format (19 ms)
    POST /api/contracts - Create Contract
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should return 403 for customer role (manager+ required) (21 ms)
      ‚àö should return 403 for technician role (manager+ required) (20 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (20 ms)
      ‚àö should create contract with valid data as manager (33 ms)
      ‚àö should create contract with minimal required data (28 ms)
      ‚àö should reject duplicate contract number (33 ms)
      ‚àö should reject missing required fields (17 ms)
      ‚àö should reject invalid customer_id (19 ms)
    PATCH /api/contracts/:id - Update Contract
      ‚àö should return 401 without authentication (24 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (23 ms)
      ‚àö should update contract with valid data as manager (46 ms)
      ‚àö should update multiple fields (41 ms)
      ‚àö should return 404 for non-existent contract (27 ms)
      ‚àö should return 400 for invalid ID format (24 ms)
      ‚àö should reject update with no fields (22 ms)
    DELETE /api/contracts/:id - Delete Contract
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (22 ms)
      ‚àö should soft delete contract as manager (37 ms)
      ‚àö should delete contract as admin (35 ms)
      ‚àö should return 404 for non-existent contract (26 ms)
      ‚àö should return 400 for invalid ID format (24 ms)
    RLS (Row-Level Security) - Contract Access
      ‚àö should apply RLS filtering for customer role on GET list (53 ms)
      ‚àö should deny access for technician role (deny_all RLS) (35 ms)
      ‚àö should not apply RLS filtering for admin role (29 ms)
      ‚àö should apply RLS filtering for dispatcher role (all_records policy) (30 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:24 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:25 [34mNew database client connected to pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:25 [33m‚ö†Ô∏è  [mi6jasfexriyx] GET / ‚Üí 401 (6ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 8ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":4,"userRole":"customer","resource":"customers","policy":"own_record_only","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 19ms[39m
13:48:25 [34mNew database client connected to pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 35ms[39m
13:48:25 [32m‚úÖ [mi6jasfuppzk4] GET /?page=1&limit=10 ‚Üí 200 (49ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 11ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":2,"userRole":"dispatcher","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32m‚úÖ [mi6jashhd0lvz] GET /?page=1&limit=10 ‚Üí 200 (21ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32m‚úÖ [mi6jasicq5b20] GET /?page=1&limit=10 ‚Üí 200 (16ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32m‚úÖ [mi6jasj1texwx] GET /?page=1&limit=5 ‚Üí 200 (17ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [32m‚úÖ [mi6jasjtrsvjq] GET /?page=1&limit=10&search=test ‚Üí 200 (17ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=email&sortOrder=ASC","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [32m‚úÖ [mi6jaskky8pmg] GET /?page=1&limit=10&sortBy=email&sortOrder=ASC ‚Üí 200 (18ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"customer","resource":"customers","policy":"own_record_only","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32m‚úÖ [mi6jaslbo37wk] GET /?page=1&limit=100 ‚Üí 200 (17ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [32mCustomer created[39m {"customerId":1}
13:48:25 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:25 [33m‚ö†Ô∏è  [mi6jasm9huisf] GET /1 ‚Üí 401 (4ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":2,"userRole":"dispatcher","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32m‚úÖ [mi6jasmnob6qs] GET /1 ‚Üí 200 (15ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 3ms[39m
13:48:25 [33m‚ö†Ô∏è  [mi6jasnazcdiw] GET /99999 ‚Üí 404 (14ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:25 [33m‚ö†Ô∏è  [mi6jasnyugnxj] GET /invalid ‚Üí 400 (9ms)[39m
13:48:25 [34mClient removed from pool[39m
13:48:25 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:25 [33m‚ö†Ô∏è  [mi6jasom8lf6p] POST / ‚Üí 401 (10ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":4,"userRole":"customer","resource":"customers","operation":"create"}
13:48:25 [33m‚ö†Ô∏è  [mi6jasp62hpyx] POST / ‚Üí 403 (12ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":3,"userRole":"technician","resource":"customers","operation":"create"}
13:48:25 [33m‚ö†Ô∏è  [mi6jaspuo16ky] POST / ‚Üí 403 (12ms)[39m
13:48:25 [34mClient removed from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32mCustomer created[39m {"customerId":2}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 7ms[39m
13:48:25 [32mAudit event[39m {"userId":2,"action":"create","resourceType":"customer","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:25 [32m‚úÖ [mi6jasqnrr6z8] POST / ‚Üí 201 (27ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32mCustomer created[39m {"customerId":3}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:25 [32m‚úÖ [mi6jasrpf1tce] POST / ‚Üí 201 (23ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32mCustomer created[39m {"customerId":4}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:25 [32m‚úÖ [mi6jassno8qtp] POST / ‚Üí 201 (22ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"customers_email_key\"","query":"\n        INSERT INTO customers (\n          email, phone, company_name, billing_address, service_address, status\n        ) VALUES ($1, $2, $3, $4, $5, $6)\n        RETURNING *\n      "}
13:48:25 [31mError creating customer[39m {"error":"Customer with this email already exists"}
13:48:25 [33m‚ö†Ô∏è  [mi6jastkacmke] POST / ‚Üí 409 (18ms)[39m
13:48:25 [34mClient removed from pool[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33m‚ö†Ô∏è  [mi6jasuhg7ajb] POST / ‚Üí 400 (12ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 6ms[39m
13:48:25 [33m‚ö†Ô∏è  [mi6jasv3un3y0] POST / ‚Üí 400 (12ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [32mCustomer created[39m {"customerId":6}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:25 [32m‚úÖ [mi6jasvo7dxeu] POST / ‚Üí 201 (24ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [32mCustomer created[39m {"customerId":7}
13:48:25 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/7"}
13:48:25 [33m‚ö†Ô∏è  [mi6jaswusn6gx] PATCH /7 ‚Üí 401 (5ms)[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 5ms[39m
13:48:25 [32mCustomer created[39m {"customerId":8}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 7ms[39m
13:48:25 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/8","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 4ms[39m
13:48:25 [34mClient acquired from pool[39m
13:48:25 [34mQuery executed in 7ms[39m
13:48:25 [32mCustomer updated[39m {"customerId":8}
13:48:25 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:26 [32m‚úÖ [mi6jasxhbm8s3] PATCH /8 ‚Üí 200 (39ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [32mCustomer created[39m {"customerId":9}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer updated[39m {"customerId":9}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:26 [32m‚úÖ [mi6jasz2hs3bt] PATCH /9 ‚Üí 200 (30ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":10}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [33m‚ö†Ô∏è  [mi6jat09as9tn] PATCH /99999 ‚Üí 404 (14ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":11}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:26 [33m‚ö†Ô∏è  [mi6jat11d6660] PATCH /invalid ‚Üí 400 (12ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":12}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/12","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [33m‚ö†Ô∏è  [mi6jat1rqusnj] PATCH /12 ‚Üí 400 (10ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":13}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/13","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 2ms[39m
13:48:26 [32mCustomer updated[39m {"customerId":13}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 2ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":13,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:26 [32m‚úÖ [mi6jat2f4jlyw] PATCH /13 ‚Üí 200 (27ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mCustomer created[39m {"customerId":14}
13:48:26 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/14"}
13:48:26 [33m‚ö†Ô∏è  [mi6jat3lwgcz4] DELETE /14 ‚Üí 401 (5ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":15}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/15","userId":2,"userRole":"dispatcher","resource":"customers","operation":"delete"}
13:48:26 [33m‚ö†Ô∏è  [mi6jat459kftz] DELETE /15 ‚Üí 403 (8ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":16}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer deactivated[39m {"customerId":16}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mAudit event[39m {"userId":5,"action":"deactivate","resourceType":"customer","resourceId":16,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:26 [32m‚úÖ [mi6jat50tegg2] DELETE /16 ‚Üí 200 (24ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [32mCustomer created[39m {"customerId":17}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mCustomer deactivated[39m {"customerId":17}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":17,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:26 [32m‚úÖ [mi6jat63zqw9k] DELETE /17 ‚Üí 200 (22ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mCustomer created[39m {"customerId":18}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 5ms[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [33m‚ö†Ô∏è  [mi6jat74kf2b7] DELETE /99999 ‚Üí 404 (13ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 3ms[39m
13:48:26 [32mCustomer created[39m {"customerId":19}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:26 [33m‚ö†Ô∏è  [mi6jat7uhhoeu] DELETE /invalid ‚Üí 400 (8ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"customer","resource":"customers","policy":"own_record_only","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 4ms[39m
13:48:26 [34mNew database client connected to pool[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 23ms[39m
13:48:26 [32m‚úÖ [mi6jat8cyohh6] GET /?page=1&limit=100 ‚Üí 200 (33ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 13ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [32m‚úÖ [mi6jat9h6kl2c] GET /?page=1&limit=100 ‚Üí 200 (24ms)[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":2,"userRole":"dispatcher","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mClient acquired from pool[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [34mQuery executed in 6ms[39m
13:48:26 [32m‚úÖ [mi6jatadmzyb5] GET /?page=1&limit=100 ‚Üí 200 (18ms)[39m
13:48:26 [34mClient acquired from pool[39m
PASS integration __tests__/integration/customers-api.test.js
  Customers CRUD API - Integration Tests
    GET /api/customers - List Customers
      ‚àö should return 401 without authentication (15 ms)
      ‚àö should allow customer to read customers list (RLS applies) (58 ms)
      ‚àö should return paginated customer list for dispatcher (31 ms)
      ‚àö should include customer data in list (26 ms)
      ‚àö should support pagination parameters (26 ms)
      ‚àö should support search parameter (27 ms)
      ‚àö should support sorting (28 ms)
      ‚àö should apply RLS filtering for customer role (26 ms)
    GET /api/customers/:id - Get Customer by ID
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should return customer by ID for dispatcher (24 ms)
      ‚àö should return 404 for non-existent customer (22 ms)
      ‚àö should return 400 for invalid ID format (21 ms)
    POST /api/customers - Create Customer
      ‚àö should return 401 without authentication (23 ms)
      ‚àö should return 403 for customer role (dispatcher+ required) (21 ms)
      ‚àö should return 403 for technician role (dispatcher+ required) (27 ms)
      ‚àö should create customer with valid data as dispatcher (41 ms)
      ‚àö should create customer with minimal required data (34 ms)
      ‚àö should reject duplicate email (64 ms)
      ‚àö should reject invalid email format (25 ms)
      ‚àö should reject missing required fields (21 ms)
      ‚àö should trim whitespace from email (34 ms)
    PATCH /api/customers/:id - Update Customer
      ‚àö should return 401 without authentication (23 ms)
      ‚àö should update customer with valid data (56 ms)
      ‚àö should update multiple fields (46 ms)
      ‚àö should return 404 for non-existent customer (27 ms)
      ‚àö should return 400 for invalid ID format (25 ms)
      ‚àö should reject update with no fields (25 ms)
      ‚àö should trim whitespace from updated fields (41 ms)
    DELETE /api/customers/:id - Delete Customer
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for non-manager users (manager+ required) (24 ms)
      ‚àö should soft delete customer as manager (46 ms)
      ‚àö should delete customer as admin (38 ms)
      ‚àö should return 404 for non-existent customer (26 ms)
      ‚àö should return 400 for invalid ID format (22 ms)
    RLS (Row-Level Security) - Customer Access
      ‚àö should apply RLS filtering for customer role on GET list (42 ms)
      ‚àö should not apply RLS filtering for admin role (32 ms)
      ‚àö should apply RLS filtering for dispatcher role (all_records policy) (29 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:26 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:27 [34mNew database client connected to pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:27 [33m‚ö†Ô∏è  [mi6jatu58pb0c] GET / ‚Üí 401 (6ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":4,"userRole":"customer","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 24ms[39m
13:48:27 [34mNew database client connected to pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 41ms[39m
13:48:27 [32m‚úÖ [mi6jatulyaab0] GET /?page=1&limit=10 ‚Üí 200 (60ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 14ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":2,"userRole":"dispatcher","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [32m‚úÖ [mi6jatx20jx29] GET /?page=1&limit=10 ‚Üí 200 (27ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 7ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32m‚úÖ [mi6jaty2csf1j] GET /?page=1&limit=10 ‚Üí 200 (16ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [32m‚úÖ [mi6jatytnjnxn] GET /?page=1&limit=5 ‚Üí 200 (18ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [34mQuery executed in 7ms[39m
13:48:27 [32m‚úÖ [mi6jatzmd5b3r] GET /?page=1&limit=10&search=test ‚Üí 200 (19ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=license_number&sortOrder=ASC","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [34mQuery executed in 7ms[39m
13:48:27 [32m‚úÖ [mi6jau0iobkrx] GET /?page=1&limit=10&sortBy=license_number&sortOrder=ASC ‚Üí 200 (18ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 7ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&filters[status]=available","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [32m‚úÖ [mi6jau1aq2nxx] GET /?page=1&limit=10&filters[status]=available ‚Üí 200 (17ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":3,"userRole":"technician","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [32m‚úÖ [mi6jau22p2sor] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":1}
13:48:27 [34mClient removed from pool[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau2z8h1p5] GET /1 ‚Üí 401 (4ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":2,"userRole":"dispatcher","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32m‚úÖ [mi6jau3ea6wy3] GET /1 ‚Üí 200 (15ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":4,"userRole":"customer","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32m‚úÖ [mi6jau42lylb4] GET /1 ‚Üí 200 (14ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient removed from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [33m‚ö†Ô∏è  [mi6jau4r78qq9] GET /99999 ‚Üí 404 (14ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 7ms[39m
13:48:27 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:27 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau5ez5m69] GET /invalid ‚Üí 400 (12ms)[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau60k1ikp] POST / ‚Üí 401 (10ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":4,"userRole":"customer","resource":"technicians","operation":"create"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau6mcon7b] POST / ‚Üí 403 (10ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":3,"userRole":"technician","resource":"technicians","operation":"create"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau75ewgcp] POST / ‚Üí 403 (10ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":2,"userRole":"dispatcher","resource":"technicians","operation":"create"}
13:48:27 [33m‚ö†Ô∏è  [mi6jau7ojnn6i] POST / ‚Üí 403 (11ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":2}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mAudit event[39m {"userId":5,"action":"create","resourceType":"technician","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jau8fpll8d] POST / ‚Üí 201 (24ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":3}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"technician","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jau9dykw7n] POST / ‚Üí 201 (19ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":4}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"technician","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jaua5ow4kv] POST / ‚Üí 201 (19ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"technicians_license_number_key\"","query":"\n        INSERT INTO technicians (license_number, certifications, skills, hourly_rate, status)\n        VALUES ($1, $2, $3, $4, $5) RETURNING *\n      "}
13:48:27 [31mError creating technician[39m {"error":"Technician with this license number already exists"}
13:48:27 [33m‚ö†Ô∏è  [mi6jauavp0ftz] POST / ‚Üí 409 (16ms)[39m
13:48:27 [34mClient removed from pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [33m‚ö†Ô∏è  [mi6jaubnaafhq] POST / ‚Üí 400 (9ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [31mQuery error:[39m {"error":"new row for relation \"technicians\" violates check constraint \"technicians_status_check\"","query":"\n        INSERT INTO technicians (license_number, certifications, skills, hourly_rate, status)\n        VALUES ($1, $2, $3, $4, $5) RETURNING *\n      "}
13:48:27 [31mError creating technician[39m {"error":"Invalid field value"}
13:48:27 [33m‚ö†Ô∏è  [mi6jauc7r4bxk] POST / ‚Üí 400 (20ms)[39m
13:48:27 [34mClient removed from pool[39m
13:48:27 [34mNew database client connected to pool[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 29ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":7}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"technician","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jaud4qtoot] POST / ‚Üí 201 (50ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":8}
13:48:27 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/8"}
13:48:27 [33m‚ö†Ô∏è  [mi6jauf0qlvwx] PATCH /8 ‚Üí 401 (5ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":9}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 6ms[39m
13:48:27 [32mTechnician updated[39m {"technicianId":9}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 2ms[39m
13:48:27 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"technician","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jaufq3tdlt] PATCH /9 ‚Üí 200 (31ms)[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mTechnician created[39m {"technicianId":10}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 5ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [32mTechnician updated[39m {"technicianId":10}
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 3ms[39m
13:48:27 [34mClient acquired from pool[39m
13:48:27 [34mQuery executed in 4ms[39m
13:48:27 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"technician","resourceId":10,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:27 [32m‚úÖ [mi6jaugzf45mr] PATCH /10 ‚Üí 200 (27ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":11}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [32mTechnician updated[39m {"technicianId":11}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"technician","resourceId":11,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:28 [32m‚úÖ [mi6jaui4e6wbl] PATCH /11 ‚Üí 200 (28ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":12}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [33m‚ö†Ô∏è  [mi6jaujcuxdu8] PATCH /99999 ‚Üí 404 (13ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":13}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:28 [33m‚ö†Ô∏è  [mi6jauk34oy8h] PATCH /invalid ‚Üí 400 (10ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":14}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [33m‚ö†Ô∏è  [mi6jauks4oszp] PATCH /14 ‚Üí 400 (11ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":15}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [31mQuery error:[39m {"error":"new row for relation \"technicians\" violates check constraint \"technicians_status_check\"","query":"UPDATE technicians SET status = $1 WHERE id = $2 RETURNING *"}
13:48:28 [31mError updating technician[39m {"error":"Invalid field value","technicianId":"15"}
13:48:28 [33m‚ö†Ô∏è  [mi6jaulhyk618] PATCH /15 ‚Üí 400 (19ms)[39m
13:48:28 [34mClient removed from pool[39m
13:48:28 [34mNew database client connected to pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 20ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":16}
13:48:28 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/16"}
13:48:28 [33m‚ö†Ô∏è  [mi6jaumuvb5es] DELETE /16 ‚Üí 401 (4ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":17}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 12ms[39m
13:48:28 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/17","userId":2,"userRole":"dispatcher","resource":"technicians","operation":"delete"}
13:48:28 [33m‚ö†Ô∏è  [mi6jauncr801o] DELETE /17 ‚Üí 403 (16ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":18}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 6ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician deactivated[39m {"technicianId":18}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mAudit event[39m {"userId":6,"action":"deactivate","resourceType":"technician","resourceId":18,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:28 [32m‚úÖ [mi6jauoffw5yu] DELETE /18 ‚Üí 200 (25ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":19}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [32mTechnician deactivated[39m {"technicianId":19}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"technician","resourceId":19,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:28 [32m‚úÖ [mi6jaupipwegi] DELETE /19 ‚Üí 200 (22ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":20}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [33m‚ö†Ô∏è  [mi6jauqjdicam] DELETE /99999 ‚Üí 404 (12ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 3ms[39m
13:48:28 [32mTechnician created[39m {"technicianId":21}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 6ms[39m
13:48:28 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:28 [33m‚ö†Ô∏è  [mi6jaur8p0xoe] DELETE /invalid ‚Üí 400 (10ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":3,"userRole":"technician","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 4ms[39m
13:48:28 [34mNew database client connected to pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 22ms[39m
13:48:28 [32m‚úÖ [mi6jaurrauvw3] GET /?page=1&limit=100 ‚Üí 200 (34ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 12ms[39m
13:48:28 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":1,"userRole":"admin","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [32m‚úÖ [mi6jausxker3h] GET /?page=1&limit=100 ‚Üí 200 (23ms)[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 6ms[39m
13:48:28 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":2,"userRole":"dispatcher","resource":"technicians","policy":"all_records","severity":"DEBUG"}
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mClient acquired from pool[39m
13:48:28 [34mQuery executed in 5ms[39m
13:48:28 [34mQuery executed in 6ms[39m
13:48:28 [32m‚úÖ [mi6jauttaozln] GET /?page=1&limit=100 ‚Üí 200 (19ms)[39m
13:48:28 [34mClient acquired from pool[39m
PASS integration __tests__/integration/technicians-api.test.js
  Technicians CRUD API - Integration Tests
    GET /api/technicians - List Technicians
      ‚àö should return 401 without authentication (17 ms)
      ‚àö should allow customer to read technicians list (sanitized) (72 ms)
      ‚àö should return paginated technician list for dispatcher (53 ms)
      ‚àö should include technician data in list (27 ms)
      ‚àö should support pagination parameters (27 ms)
      ‚àö should support search parameter (30 ms)
      ‚àö should support sorting (31 ms)
      ‚àö should support status filtering (28 ms)
      ‚àö should apply RLS filtering for technician role (all_records) (24 ms)
    GET /api/technicians/:id - Get Technician by ID
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should return technician by ID for dispatcher (26 ms)
      ‚àö should return sanitized data for customer role (22 ms)
      ‚àö should return 404 for non-existent technician (25 ms)
      ‚àö should return 400 for invalid ID format (20 ms)
    POST /api/technicians - Create Technician
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should return 403 for customer role (manager+ required) (22 ms)
      ‚àö should return 403 for technician role (manager+ required) (19 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (19 ms)
      ‚àö should create technician with valid data as manager (39 ms)
      ‚àö should create technician with minimal required data (29 ms)
      ‚àö should reject duplicate license_number (53 ms)
      ‚àö should reject missing required fields (19 ms)
      ‚àö should reject invalid status value (32 ms)
      ‚àö should default to available status if not provided (62 ms)
    PATCH /api/technicians/:id - Update Technician
      ‚àö should return 401 without authentication (27 ms)
      ‚àö should update technician with valid data (47 ms)
      ‚àö should update technician status (40 ms)
      ‚àö should update multiple fields (44 ms)
      ‚àö should return 404 for non-existent technician (27 ms)
      ‚àö should return 400 for invalid ID format (25 ms)
      ‚àö should reject update with no fields (25 ms)
      ‚àö should reject invalid status value (34 ms)
    DELETE /api/technicians/:id - Delete Technician
      ‚àö should return 401 without authentication (34 ms)
      ‚àö should return 403 for non-manager users (manager+ required) (30 ms)
      ‚àö should soft delete technician as manager (48 ms)
      ‚àö should delete technician as admin (36 ms)
      ‚àö should return 404 for non-existent technician (27 ms)
      ‚àö should return 400 for invalid ID format (23 ms)
    RLS (Row-Level Security) - Technician Access
      ‚àö should apply RLS filtering for technician role on GET list (43 ms)
      ‚àö should not apply RLS filtering for admin role (32 ms)
      ‚àö should apply RLS filtering for dispatcher role (all_records policy) (26 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:28 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:29 [34mNew database client connected to pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:29 [33m‚ö†Ô∏è  [mi6javcwudkl1] GET / ‚Üí 401 (5ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 6ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":2,"userRole":"technician","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32m‚úÖ [mi6javda6n722] GET /?page=1&limit=10 ‚Üí 200 (21ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [32m‚úÖ [mi6javejxozn2] GET /?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 6ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32m‚úÖ [mi6javfb7c206] GET /?page=1&limit=10 ‚Üí 200 (16ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=3","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32m‚úÖ [mi6javg27niap] GET /?page=1&limit=3 ‚Üí 200 (17ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=name&sortOrder=ASC","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [32m‚úÖ [mi6javgtqphdk] GET /?page=1&limit=10&sortBy=name&sortOrder=ASC ‚Üí 200 (18ms)[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:29 [33m‚ö†Ô∏è  [mi6javhkf0cot] GET /1 ‚Üí 401 (5ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=1","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 2ms[39m
13:48:29 [32m‚úÖ [mi6javhy1h2kq] GET /?page=1&limit=1 ‚Üí 200 (16ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/7","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32m‚úÖ [mi6javim4joq4] GET /7 ‚Üí 200 (13ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [33m‚ö†Ô∏è  [mi6javj8e6trj] GET /99999 ‚Üí 404 (14ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:29 [33m‚ö†Ô∏è  [mi6javjuw1939] GET /invalid ‚Üí 400 (10ms)[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1/users"}
13:48:29 [33m‚ö†Ô∏è  [mi6javke97cqi] GET /1/users ‚Üí 401 (5ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 6ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=1","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32m‚úÖ [mi6javksflbz9] GET /?page=1&limit=1 ‚Üí 200 (17ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [32m‚úÖ [mi6javlicnye6] GET /7/users?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:29 [34mClient removed from pool[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:29 [33m‚ö†Ô∏è  [mi6javmdto9ja] POST / ‚Üí 401 (9ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":2,"userRole":"technician","resource":"roles","operation":"create"}
13:48:29 [33m‚ö†Ô∏è  [mi6javmw2q2wh] POST / ‚Üí 403 (9ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":22,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javng2k9m1] POST / ‚Üí 201 (30ms)[39m
13:48:29 [34mClient removed from pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 2ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_create","resourceType":"role","resourceId":23,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javokzvpkq] POST / ‚Üí 201 (18ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"roles_name_key\"","query":"\n        INSERT INTO roles (name, priority)\n        VALUES ($1, $2)\n        RETURNING *\n      "}
13:48:29 [31mError creating role[39m {"error":"Role name already exists","roleName":"test-role-1763588909534"}
13:48:29 [33m‚ö†Ô∏è  [mi6javp9jqpdc] POST / ‚Üí 409 (15ms)[39m
13:48:29 [34mClient removed from pool[39m
13:48:29 [34mNew database client connected to pool[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 26ms[39m
13:48:29 [33m‚ö†Ô∏è  [mi6javq0o2815] POST / ‚Üí 400 (31ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33m‚ö†Ô∏è  [mi6javr62fow8] POST / ‚Üí 400 (9ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/25"}
13:48:29 [33m‚ö†Ô∏è  [mi6javruim3ec] PUT /25 ‚Üí 401 (5ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/26","userId":2,"userRole":"technician","resource":"roles","operation":"update"}
13:48:29 [33m‚ö†Ô∏è  [mi6javsdc4v1x] PUT /26 ‚Üí 403 (9ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 6ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 2ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":27,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javt1ej1qa] PUT /27 ‚Üí 200 (34ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 2ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":28,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javuecxqp2] PUT /28 ‚Üí 200 (24ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [33m‚ö†Ô∏è  [mi6javvgnlqas] PUT /99999 ‚Üí 404 (13ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 2ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_update","resourceType":"role","resourceId":30,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javw7sb6fs] PUT /30 ‚Üí 200 (25ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/30","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [32m‚úÖ [mi6javx4eswil] GET /30 ‚Üí 200 (14ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/31"}
13:48:29 [33m‚ö†Ô∏è  [mi6javxwhpu44] DELETE /31 ‚Üí 401 (4ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/32","userId":2,"userRole":"technician","resource":"roles","operation":"delete"}
13:48:29 [33m‚ö†Ô∏è  [mi6javyeg5903] DELETE /32 ‚Üí 403 (9ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 3ms[39m
13:48:29 [32mAudit event[39m {"userId":1,"action":"role_delete","resourceType":"role","resourceId":33,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:29 [32m‚úÖ [mi6javz17d191] DELETE /33 ‚Üí 200 (25ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 8ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 4ms[39m
13:48:29 [31mError deleting role[39m {"error":"Role not found","roleId":"99999"}
13:48:29 [33m‚ö†Ô∏è  [mi6jaw0424jbq] DELETE /99999 ‚Üí 404 (17ms)[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 5ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:29 [34mQuery executed in 6ms[39m
13:48:29 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 4ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 4ms[39m
13:48:30 [32mAudit event[39m {"userId":1,"action":"role_delete","resourceType":"role","resourceId":35,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:30 [32m‚úÖ [mi6jaw120ku4i] DELETE /35 ‚Üí 200 (29ms)[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/35","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [33m‚ö†Ô∏è  [mi6jaw23z7jdz] GET /35 ‚Üí 404 (13ms)[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 4ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [32m‚úÖ [mi6jaw2ruervw] GET /?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:30 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:30 [33m‚ö†Ô∏è  [mi6jaw3j2mrp5] GET / ‚Üí 401 (4ms)[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 4ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [32m‚úÖ [mi6jaw3we1zly] GET /?page=1&limit=10 ‚Üí 200 (21ms)[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 6ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 3ms[39m
13:48:30 [32m‚úÖ [mi6jaw4rw71a4] GET /?page=1&limit=10 ‚Üí 200 (18ms)[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 25ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [32m‚úÖ [mi6jaw5tyyhz3] GET /?page=1&limit=10 ‚Üí 200 (40ms)[39m
13:48:30 [34mNew database client connected to pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mNew database client connected to pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mNew database client connected to pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mNew database client connected to pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 50ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 72ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 71ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 12ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 73ms[39m
13:48:30 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"roles","policy":"public_resource","severity":"DEBUG"}
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 14ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 12ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 14ms[39m
13:48:30 [32m‚úÖ [mi6jaw6d81j8p] GET /?page=1&limit=10 ‚Üí 200 (82ms)[39m
13:48:30 [34mQuery executed in 14ms[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 13ms[39m
13:48:30 [32m‚úÖ [mi6jaw5xpww75] GET /?page=1&limit=10 ‚Üí 200 (104ms)[39m
13:48:30 [34mQuery executed in 14ms[39m
13:48:30 [32m‚úÖ [mi6jaw62e6xag] GET /?page=1&limit=10 ‚Üí 200 (103ms)[39m
13:48:30 [34mQuery executed in 14ms[39m
13:48:30 [32m‚úÖ [mi6jaw674wi3z] GET /?page=1&limit=10 ‚Üí 200 (107ms)[39m
13:48:30 [34mClient acquired from pool[39m
PASS integration __tests__/integration/roles-api.test.js
  Roles CRUD API - Integration Tests
    GET /api/roles - List Roles
      ‚àö should return 401 without authentication (15 ms)
      ‚àö should allow authenticated users to read roles (31 ms)
      ‚àö should return paginated role list (41 ms)
      ‚àö should include role data in list (27 ms)
      ‚àö should support pagination parameters (25 ms)
      ‚àö should support sorting (27 ms)
    GET /api/roles/:id - Get Role by ID
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should return role by ID (46 ms)
      ‚àö should return 404 for non-existent role (22 ms)
      ‚àö should return 400 for invalid ID format (19 ms)
    GET /api/roles/:id/users - Get Users by Role
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should return users for a role (53 ms)
    POST /api/roles - Create Role
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should return 403 for non-admin users (20 ms)
      ‚àö should create role with valid data (39 ms)
      ‚àö should reject duplicate role name (52 ms)
      ‚àö should reject missing required fields (41 ms)
      ‚àö should validate priority range (20 ms)
    PUT /api/roles/:id - Update Role
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should return 403 for non-admin users (23 ms)
      ‚àö should update role description (49 ms)
      ‚àö should update role priority (39 ms)
      ‚àö should return 404 for non-existent role (26 ms)
      ‚àö should persist updates to database (61 ms)
    DELETE /api/roles/:id - Delete Role
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for non-admin users (23 ms)
      ‚àö should delete role (39 ms)
      ‚àö should return 404 for non-existent role (33 ms)
      ‚àö should remove role from database (66 ms)
    Roles API - Response Format
      ‚àö should return consistent success format (26 ms)
      ‚àö should return consistent error format (13 ms)
      ‚àö should include proper content-type (31 ms)
    Roles API - Performance
      ‚àö should respond quickly to list requests (28 ms)
      ‚àö should handle concurrent requests (143 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:30 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:30 [34mNew database client connected to pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mClient acquired from pool[39m
13:48:30 [34mQuery executed in 5ms[39m
13:48:30 [32mCustomer created[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 27ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawt5dlevr] PATCH /1 ‚Üí 200 (77ms)[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 62ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 64ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 81ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 92ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 19ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 16ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawtttklkk] PATCH /1 ‚Üí 200 (131ms)[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawtz0lluo] PATCH /1 ‚Üí 200 (130ms)[39m
13:48:31 [34mQuery executed in 15ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawtnmvlms] PATCH /1 ‚Üí 200 (147ms)[39m
13:48:31 [34mQuery executed in 17ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawthbljvg] PATCH /1 ‚Üí 200 (158ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32m‚úÖ [mi6jawy99wr7l] GET /1 ‚Üí 200 (15ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [33mCustomer permanently deleted[39m {"customerId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32mCustomer created[39m {"customerId":2}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/2","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/2","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/2","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":2}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":2}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [32mCustomer updated[39m {"customerId":2}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawzm3g3uo] PATCH /2 ‚Üí 200 (68ms)[39m
13:48:31 [34mQuery executed in 9ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawzrtioin] PATCH /2 ‚Üí 200 (66ms)[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jawzx1ohtk] PATCH /2 ‚Üí 200 (65ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/2","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32m‚úÖ [mi6jax21kznom] GET /2 ‚Üí 200 (14ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [33mCustomer permanently deleted[39m {"customerId":2}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32mCustomer created[39m {"customerId":3}
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 9ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [32mCustomer deactivated[39m {"customerId":3}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mCustomer deactivated[39m {"customerId":3}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mCustomer deactivated[39m {"customerId":3}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax3dckjug] DELETE /3 ‚Üí 200 (48ms)[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax3hs7o58] DELETE /3 ‚Üí 200 (49ms)[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"deactivate","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax3mz2oxe] DELETE /3 ‚Üí 200 (49ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/3","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 3ms[39m
13:48:31 [32m‚úÖ [mi6jax5ab3l0s] GET /3 ‚Üí 200 (15ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mCustomer created[39m {"customerId":4}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"customers_email_key\"","query":"\n        INSERT INTO customers (\n          email, phone, company_name, billing_address, service_address, status\n        ) VALUES ($1, $2, $3, $4, $5, $6)\n        RETURNING *\n      "}
13:48:31 [31mError creating customer[39m {"error":"Customer with this email already exists"}
13:48:31 [33m‚ö†Ô∏è  [mi6jax67nw9dp] POST / ‚Üí 409 (29ms)[39m
13:48:31 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"customers_email_key\"","query":"\n        INSERT INTO customers (\n          email, phone, company_name, billing_address, service_address, status\n        ) VALUES ($1, $2, $3, $4, $5, $6)\n        RETURNING *\n      "}
13:48:31 [31mError creating customer[39m {"error":"Customer with this email already exists"}
13:48:31 [33m‚ö†Ô∏è  [mi6jax6dt0wyx] POST / ‚Üí 409 (27ms)[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax63tbjpl] POST / ‚Üí 201 (42ms)[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mClient removed from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [33mCustomer permanently deleted[39m {"customerId":4}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mInventory item created[39m {"inventoryId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 23ms[39m
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 26ms[39m
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 26ms[39m
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 12ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mInventory item updated[39m {"inventoryId":1}
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 9ms[39m
13:48:31 [32mInventory item updated[39m {"inventoryId":1}
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [32mInventory item updated[39m {"inventoryId":1}
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"inventory","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax8stzdxp] PATCH /1 ‚Üí 200 (76ms)[39m
13:48:31 [34mQuery executed in 9ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"inventory","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax8x2vle8] PATCH /1 ‚Üí 200 (76ms)[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"inventory","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax9168y0l] PATCH /1 ‚Üí 200 (76ms)[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mNew database client connected to pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 88ms[39m
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 99ms[39m
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32mInventory item updated[39m {"inventoryId":1}
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [32mInventory item updated[39m {"inventoryId":1}
13:48:31 [34mInventory RLS: No req or RLS context[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 6ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"inventory","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax9cigf1t] PATCH /1 ‚Üí 200 (123ms)[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"inventory","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jax97nac9j] PATCH /1 ‚Üí 200 (135ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:31 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32m‚úÖ [mi6jaxd5hn20y] GET /1 ‚Üí 200 (15ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [33mInventory item permanently deleted[39m {"inventoryId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [32mCustomer created[39m {"customerId":7}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 3ms[39m
13:48:31 [32mCustomer created[39m {"customerId":8}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mWork order created[39m {"workOrderId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 14ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 15ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 13ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 9ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [32mWork order updated[39m {"workOrderId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [32mWork order updated[39m {"workOrderId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mWork order updated[39m {"workOrderId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 8ms[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"work_order","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jaxeudn5x2] PATCH /1 ‚Üí 200 (62ms)[39m
13:48:31 [34mQuery executed in 10ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"work_order","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jaxeyyv937] PATCH /1 ‚Üí 200 (62ms)[39m
13:48:31 [34mQuery executed in 11ms[39m
13:48:31 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"work_order","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:31 [32m‚úÖ [mi6jaxf3hngx9] PATCH /1 ‚Üí 200 (61ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [32m‚úÖ [mi6jaxh4n1dp5] GET /1 ‚Üí 200 (15ms)[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [33mWork order permanently deleted[39m {"workOrderId":1}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 7ms[39m
13:48:31 [33mCustomer permanently deleted[39m {"customerId":8}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 4ms[39m
13:48:31 [33mCustomer permanently deleted[39m {"customerId":7}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 5ms[39m
13:48:31 [32mCustomer created[39m {"customerId":9}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 35ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 37ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 36ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 37ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 38ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 39ms[39m
13:48:31 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:31 [34mClient acquired from pool[39m
13:48:31 [34mQuery executed in 39ms[39m
13:48:32 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 40ms[39m
13:48:32 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 43ms[39m
13:48:32 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 46ms[39m
13:48:32 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/9","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 45ms[39m
13:48:32 [32m‚úÖ [mi6jaxj42wbpu] GET /9 ‚Üí 200 (84ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 40ms[39m
13:48:32 [32m‚úÖ [mi6jaxjcgpt6p] GET /9 ‚Üí 200 (83ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 44ms[39m
13:48:32 [32m‚úÖ [mi6jaxjgwu7en] GET /9 ‚Üí 200 (84ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 43ms[39m
13:48:32 [32m‚úÖ [mi6jaxjjsx78t] GET /9 ‚Üí 200 (86ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 44ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 44ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 43ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 39ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 38ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 78ms[39m
13:48:32 [32m‚úÖ [mi6jaxj8fand9] GET /9 ‚Üí 200 (120ms)[39m
13:48:32 [34mQuery executed in 26ms[39m
13:48:32 [32mCustomer updated[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 26ms[39m
13:48:32 [32mCustomer updated[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 27ms[39m
13:48:32 [32mCustomer updated[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 28ms[39m
13:48:32 [32mCustomer updated[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 29ms[39m
13:48:32 [32mCustomer updated[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 23ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 22ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 20ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 20ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 18ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 14ms[39m
13:48:32 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:32 [32m‚úÖ [mi6jaxjmb4tp6] PATCH /9 ‚Üí 200 (158ms)[39m
13:48:32 [34mQuery executed in 16ms[39m
13:48:32 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:32 [32m‚úÖ [mi6jaxjpuf4t2] PATCH /9 ‚Üí 200 (159ms)[39m
13:48:32 [34mQuery executed in 17ms[39m
13:48:32 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:32 [32m‚úÖ [mi6jaxjt764ae] PATCH /9 ‚Üí 200 (158ms)[39m
13:48:32 [34mQuery executed in 17ms[39m
13:48:32 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:32 [32m‚úÖ [mi6jaxjw1fjhc] PATCH /9 ‚Üí 200 (158ms)[39m
13:48:32 [34mQuery executed in 21ms[39m
13:48:32 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"customer","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:32 [32m‚úÖ [mi6jaxjyq3abh] PATCH /9 ‚Üí 200 (163ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 9ms[39m
13:48:32 [33mCustomer permanently deleted[39m {"customerId":9}
13:48:32 [34mClient acquired from pool[39m
PASS integration __tests__/integration/edge-cases-concurrency.test.js
  Race Condition & Concurrency Tests
    Concurrent Updates
      ‚àö should handle concurrent updates to same customer (243 ms)
      ‚àö should handle concurrent updates to different fields (134 ms)
    Concurrent Deletes
      ‚àö should handle multiple deletes of same resource gracefully (105 ms)
    Unique Constraint Races
      ‚àö should prevent duplicate email creation in concurrent requests (79 ms)
    Inventory Stock Concurrent Updates
      ‚àö should handle concurrent inventory stock updates (210 ms)
    Work Order Status Race Conditions
      ‚àö should handle concurrent status updates (156 ms)
    Parallel Read/Write Operations
      ‚àö should handle mixed concurrent reads and writes (246 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:32 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:32 [34mNew database client connected to pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 7ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 21ms[39m
13:48:32 [32m‚úÖ [mi6jay79buw2v] GET / ‚Üí 200 (32ms)[39m
13:48:32 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:32 [33m‚ö†Ô∏è  [mi6jay8ij24mu] GET / ‚Üí 401 (4ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 6ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 4ms[39m
13:48:32 [32m‚úÖ [mi6jay9ap0cb4] GET / ‚Üí 200 (14ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 5ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 5ms[39m
13:48:32 [32m‚úÖ [mi6jay9yij42o] GET / ‚Üí 200 (14ms)[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 31ms[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mQuery executed in 10ms[39m
13:48:32 [32m‚úÖ [mi6jayayvvwno] GET / ‚Üí 200 (45ms)[39m
13:48:32 [34mNew database client connected to pool[39m
13:48:32 [34mClient acquired from pool[39m
13:48:32 [34mNew database client connected to pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mNew database client connected to pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mNew database client connected to pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 48ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 57ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 73ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 71ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 16ms[39m
13:48:33 [32m‚úÖ [mi6jayboj1l2b] GET / ‚Üí 200 (67ms)[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [32m‚úÖ [mi6jaybhail95] GET / ‚Üí 200 (81ms)[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [32m‚úÖ [mi6jayb4tsy1p] GET / ‚Üí 200 (97ms)[39m
13:48:33 [34mQuery executed in 23ms[39m
13:48:33 [32m‚úÖ [mi6jayba4iunn] GET / ‚Üí 200 (97ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 14ms[39m
13:48:33 [34mQuery executed in 18ms[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [34mQuery executed in 31ms[39m
13:48:33 [32m‚úÖ [mi6jayee8a6r2] GET /users ‚Üí 200 (42ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient removed from pool[39m
13:48:33 [34mClient removed from pool[39m
13:48:33 [34mClient removed from pool[39m
13:48:33 [34mQuery executed in 14ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient removed from pool[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 16ms[39m
13:48:33 [34mQuery executed in 18ms[39m
13:48:33 [34mQuery executed in 23ms[39m
13:48:33 [32m‚úÖ [mi6jayg0bfkns] GET /roles ‚Üí 200 (42ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 17ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [32m‚úÖ [mi6jayhfpy97x] GET /nonexistent_table ‚Üí 200 (30ms)[39m
13:48:33 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/users"}
13:48:33 [33m‚ö†Ô∏è  [mi6jayiklkrza] GET /users ‚Üí 401 (4ms)[39m
13:48:33 [34mClient removed from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 15ms[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [32m‚úÖ [mi6jayj0nhf7o] GET /users ‚Üí 200 (32ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 7ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 8ms[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [32m‚úÖ [mi6jayk55wud4] GET /users ‚Üí 200 (31ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [32m‚úÖ [mi6jayl9azvw1] GET /users ‚Üí 200 (30ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [32m‚úÖ [mi6jaymdhs0yy] GET /users ‚Üí 200 (30ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 8ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [32m‚úÖ [mi6jaynhcvrll] GET /users ‚Üí 200 (31ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 14ms[39m
13:48:33 [34mQuery executed in 19ms[39m
13:48:33 [32m‚úÖ [mi6jayomr89a1] GET /roles ‚Üí 200 (29ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 8ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 16ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 4ms[39m
13:48:33 [32m‚úÖ [mi6jaypopy533] GET /users/options/role_id ‚Üí 200 (54ms)[39m
13:48:33 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/users/options/role_id"}
13:48:33 [33m‚ö†Ô∏è  [mi6jayrf04vkf] GET /users/options/role_id ‚Üí 401 (5ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [33m‚ö†Ô∏è  [mi6jayru0ifhh] GET /users/options/email ‚Üí 400 (29ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 15ms[39m
13:48:33 [33m‚ö†Ô∏è  [mi6jaysxc1364] GET /nonexistent/options/column ‚Üí 400 (26ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 29ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 17ms[39m
13:48:33 [34mQuery executed in 18ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 4ms[39m
13:48:33 [32m‚úÖ [mi6jaytv8dyhn] GET /users/options/role_id ‚Üí 200 (64ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 19ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 17ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [32m‚úÖ [mi6jayvy6bjrg] GET /users/options/role_id ‚Üí 200 (55ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [32m‚úÖ [mi6jayxq3rjdx] GET / ‚Üí 200 (15ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 7ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 7ms[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [32m‚úÖ [mi6jayyivn54v] GET /users ‚Üí 200 (30ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 20ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 10ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 13ms[39m
13:48:33 [34mQuery executed in 17ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 4ms[39m
13:48:33 [32m‚úÖ [mi6jayzlah64g] GET /users/options/role_id ‚Üí 200 (53ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 6ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [32m‚úÖ [mi6jaz1a0oay9] GET / ‚Üí 200 (15ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 11ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 15ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 15ms[39m
13:48:33 [32m‚úÖ [mi6jaz246en1m] GET / ‚Üí 200 (31ms)[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 19ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 21ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 24ms[39m
13:48:33 [34mQuery executed in 23ms[39m
13:48:33 [34mQuery executed in 24ms[39m
13:48:33 [34mQuery executed in 26ms[39m
13:48:33 [34mQuery executed in 34ms[39m
13:48:33 [32m‚úÖ [mi6jaz28rk3tr] GET /users ‚Üí 200 (49ms)[39m
13:48:33 [34mQuery executed in 33ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 9ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 12ms[39m
13:48:33 [34mQuery executed in 16ms[39m
13:48:33 [34mClient acquired from pool[39m
13:48:33 [34mQuery executed in 5ms[39m
13:48:33 [32m‚úÖ [mi6jaz2cviwn4] GET /users/options/role_id ‚Üí 200 (74ms)[39m
PASS integration __tests__/integration/schema-api.test.js
  Schema Endpoints - Integration Tests
    GET /api/schema - List All Tables
      ‚àö should return 200 with list of tables (45 ms)
      ‚àö should return 401 without authentication (27 ms)
      ‚àö should include expected tables (26 ms)
      ‚àö should include table metadata (24 ms)
      ‚àö should handle concurrent requests (134 ms)
    GET /api/schema/:tableName - Get Table Schema
      ‚àö should return schema for users table (55 ms)
      ‚àö should return schema for roles table (56 ms)
      ‚àö should return error for non-existent table (39 ms)
      ‚àö should return 401 without authentication (15 ms)
      ‚àö should include column metadata (44 ms)
      ‚àö should include primary key column (40 ms)
      ‚àö should identify foreign key relationships (39 ms)
      ‚àö should include UI metadata (labels, types) (41 ms)
      ‚àö should identify searchable columns (40 ms)
      ‚àö should identify readonly columns (38 ms)
    GET /api/schema/:tableName/options/:column - Get FK Options
      ‚àö should return role options for users.role_id (63 ms)
      ‚àö should return 401 without authentication (12 ms)
      ‚àö should return 400 for non-FK column (40 ms)
      ‚àö should return error for non-existent table (34 ms)
      ‚àö should return options with value and label (74 ms)
      ‚àö should return actual role data (65 ms)
    Schema Endpoints - Performance
      ‚àö should respond quickly for table list (26 ms)
      ‚àö should respond quickly for table schema (39 ms)
      ‚àö should respond quickly for FK options (62 ms)
    Schema Endpoints - Response Format
      ‚àö should return proper content-type (23 ms)
      ‚àö should include timestamp in all responses (97 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:34 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:34 [34mNew database client connected to pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazllpavdo] GET / ‚Üí 401 (5ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/?page=1&limit=10","userId":7,"userRole":"customer","resource":"inventory","operation":"read"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazm0oeztb] GET /?page=1&limit=10 ‚Üí 403 (11ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":6,"userRole":"technician","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 11ms[39m
13:48:34 [34mNew database client connected to pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 28ms[39m
13:48:34 [32m‚úÖ [mi6jazmkidrl8] GET /?page=1&limit=10 ‚Üí 200 (41ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 12ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":5,"userRole":"dispatcher","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 4ms[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [32m‚úÖ [mi6jazny8h7a4] GET /?page=1&limit=10 ‚Üí 200 (24ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 4ms[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [32m‚úÖ [mi6jazowwnwxx] GET /?page=1&limit=10 ‚Üí 200 (17ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [32m‚úÖ [mi6jazpnxlnvn] GET /?page=1&limit=5 ‚Üí 200 (17ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [32m‚úÖ [mi6jazqcr86c3] GET /?page=1&limit=10&search=test ‚Üí 200 (18ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 6ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=name&sortOrder=ASC","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [32m‚úÖ [mi6jazr4zs0ah] GET /?page=1&limit=10&sortBy=name&sortOrder=ASC ‚Üí 200 (17ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [32mInventory item created[39m {"inventoryId":1}
13:48:34 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazs1yloi7] GET /1 ‚Üí 401 (4ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":6,"userRole":"technician","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 4ms[39m
13:48:34 [32m‚úÖ [mi6jazsfcjb6c] GET /1 ‚Üí 200 (15ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 7ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 3ms[39m
13:48:34 [33m‚ö†Ô∏è  [mi6jazt3wlgpj] GET /99999 ‚Üí 404 (15ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":3,"userRole":"admin","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:34 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:34 [33m‚ö†Ô∏è  [mi6jaztt09bfy] GET /invalid ‚Üí 400 (9ms)[39m
13:48:34 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazuc9s5mh] POST / ‚Üí 401 (10ms)[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 7ms[39m
13:48:34 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":7,"userRole":"customer","resource":"inventory","operation":"create"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazuwsgbr7] POST / ‚Üí 403 (13ms)[39m
13:48:34 [34mClient removed from pool[39m
13:48:34 [34mClient acquired from pool[39m
13:48:34 [34mQuery executed in 5ms[39m
13:48:34 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":6,"userRole":"technician","resource":"inventory","operation":"create"}
13:48:34 [33m‚ö†Ô∏è  [mi6jazvn1z8f0] POST / ‚Üí 403 (10ms)[39m
13:48:34 [34mClient removed from pool[39m
13:48:35 [34mClient removed from pool[39m
13:48:35 [34mClient removed from pool[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mClient removed from pool[39m
13:48:35 [34mQuery executed in 8ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":2}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [32mAudit event[39m {"userId":5,"action":"create","resourceType":"inventory","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jazwei67h4] POST / ‚Üí 201 (28ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":3}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mAudit event[39m {"userId":3,"action":"create","resourceType":"inventory","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jazxjly1at] POST / ‚Üí 201 (22ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":4}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mAudit event[39m {"userId":3,"action":"create","resourceType":"inventory","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jazyht85r4] POST / ‚Üí 201 (21ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"inventory_sku_key\"","query":"\n        INSERT INTO inventory (name, sku, description, quantity, reorder_level, unit_cost, location, supplier, status)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) RETURNING *\n      "}
13:48:35 [31mError creating inventory item[39m {"error":"duplicate key value violates unique constraint \"inventory_sku_key\"","code":"23505"}
13:48:35 [31mError creating inventory item[39m {"error":"duplicate key value violates unique constraint \"inventory_sku_key\""}
13:48:35 [33m‚ö†Ô∏è  [mi6jazzb4vq55] POST / ‚Üí 409 (18ms)[39m
13:48:35 [34mClient removed from pool[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33m‚ö†Ô∏è  [mi6jb004xzio9] POST / ‚Üí 400 (9ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":6}
13:48:35 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/6"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb00suajg9] PATCH /6 ‚Üí 401 (5ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":7}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32mInventory item updated[39m {"inventoryId":7}
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32mAudit event[39m {"userId":6,"action":"update","resourceType":"inventory","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jb01bhdg4w] PATCH /7 ‚Üí 200 (31ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":8}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 2ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item updated[39m {"inventoryId":8}
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mAudit event[39m {"userId":3,"action":"update","resourceType":"inventory","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jb02jqg9ly] PATCH /8 ‚Üí 200 (28ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":9}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [33m‚ö†Ô∏è  [mi6jb03o8ayms] PATCH /99999 ‚Üí 404 (14ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":10}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb04g78tdz] PATCH /invalid ‚Üí 400 (9ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":11}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33m‚ö†Ô∏è  [mi6jb0539tgpx] PATCH /11 ‚Üí 400 (10ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":12}
13:48:35 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/12"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb05qxkcym] DELETE /12 ‚Üí 401 (5ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":13}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/13","userId":6,"userRole":"technician","resource":"inventory","operation":"delete"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb06au6atk] DELETE /13 ‚Üí 403 (8ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":14}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/14","userId":5,"userRole":"dispatcher","resource":"inventory","operation":"delete"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb06wm6dbb] DELETE /14 ‚Üí 403 (8ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":15}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [33mInventory item permanently deleted[39m {"inventoryId":15}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [32mAudit event[39m {"userId":4,"action":"delete","resourceType":"inventory","resourceId":15,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jb07ipiry0] DELETE /15 ‚Üí 200 (23ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":16}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [33mInventory item permanently deleted[39m {"inventoryId":16}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mAudit event[39m {"userId":3,"action":"delete","resourceType":"inventory","resourceId":16,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:35 [32m‚úÖ [mi6jb08j16snd] DELETE /16 ‚Üí 200 (22ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":17}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [34mInventory RLS: No req or RLS context[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 2ms[39m
13:48:35 [33m‚ö†Ô∏è  [mi6jb09jfrord] DELETE /99999 ‚Üí 404 (12ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 3ms[39m
13:48:35 [32mInventory item created[39m {"inventoryId":18}
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:35 [33m‚ö†Ô∏è  [mi6jb0a9g2wvm] DELETE /invalid ‚Üí 400 (9ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":6,"userRole":"technician","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:35 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mNew database client connected to pool[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 22ms[39m
13:48:35 [32m‚úÖ [mi6jb0arsbasa] GET /?page=1&limit=100 ‚Üí 200 (34ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 12ms[39m
13:48:35 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"manager","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:35 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 4ms[39m
13:48:35 [34mQuery executed in 6ms[39m
13:48:35 [32m‚úÖ [mi6jb0bye8wni] GET /?page=1&limit=100 ‚Üí 200 (23ms)[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"dispatcher","resource":"inventory","policy":"public_resource","severity":"DEBUG"}
13:48:35 [34mInventory RLS: public_resource policy - no filtering[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mClient acquired from pool[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [34mQuery executed in 5ms[39m
13:48:35 [32m‚úÖ [mi6jb0cvy409o] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:35 [34mClient acquired from pool[39m
PASS integration __tests__/integration/inventory-api.test.js
  Inventory CRUD API - Integration Tests
    GET /api/inventory - List Inventory
      ‚àö should return 401 without authentication (15 ms)
      ‚àö should return 403 for customer role (technician+ required) (20 ms)
      ‚àö should allow technician to read inventory list (51 ms)
      ‚àö should return paginated inventory list for dispatcher (33 ms)
      ‚àö should include inventory data in list (26 ms)
      ‚àö should support pagination parameters (26 ms)
      ‚àö should support search parameter (26 ms)
      ‚àö should support sorting (26 ms)
    GET /api/inventory/:id - Get Inventory Item by ID
      ‚àö should return 401 without authentication (13 ms)
      ‚àö should return inventory item by ID for technician (25 ms)
      ‚àö should return 404 for non-existent item (24 ms)
      ‚àö should return 400 for invalid ID format (21 ms)
    POST /api/inventory - Create Inventory Item
      ‚àö should return 401 without authentication (19 ms)
      ‚àö should return 403 for customer role (dispatcher+ required) (24 ms)
      ‚àö should return 403 for technician role (dispatcher+ required) (23 ms)
      ‚àö should create inventory item with valid data as dispatcher (44 ms)
      ‚àö should create inventory item with minimal required data (34 ms)
      ‚àö should reject duplicate SKU (61 ms)
      ‚àö should reject missing required fields (19 ms)
    PATCH /api/inventory/:id - Update Inventory Item
      ‚àö should return 401 without authentication (19 ms)
      ‚àö should update inventory item as technician (45 ms)
      ‚àö should update multiple fields (41 ms)
      ‚àö should return 404 for non-existent item (28 ms)
      ‚àö should return 400 for invalid ID format (23 ms)
      ‚àö should reject update with no fields (23 ms)
    DELETE /api/inventory/:id - Delete Inventory Item
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for technician role (manager+ required) (22 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (22 ms)
      ‚àö should soft delete inventory item as manager (37 ms)
      ‚àö should delete inventory item as admin (36 ms)
      ‚àö should return 404 for non-existent item (27 ms)
      ‚àö should return 400 for invalid ID format (22 ms)
    RLS (Row-Level Security) - Inventory Access
      ‚àö should not apply RLS filtering (public_resource) (43 ms)
      ‚àö should not apply RLS filtering for manager role (33 ms)
      ‚àö should not apply RLS filtering for dispatcher role (24 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:35 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:36 [34mNew database client connected to pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [32mCustomer created[39m {"customerId":1}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [32mWork order created[39m {"workOrderId":1}
13:48:36 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb0xhb9x1t] GET / ‚Üí 401 (6ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":4,"userRole":"technician","resource":"invoices","policy":"deny_all","severity":"DEBUG"}
13:48:36 [33mRLS deny_all policy for invoices[39m {"userId":4}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 8ms[39m
13:48:36 [34mNew database client connected to pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 29ms[39m
13:48:36 [32m‚úÖ [mi6jb0xwsv8i0] GET /?page=1&limit=10 ‚Üí 200 (47ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 17ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":5,"userRole":"customer","resource":"invoices","policy":"own_invoices_only","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [34mQuery executed in 9ms[39m
13:48:36 [32m‚úÖ [mi6jb0zmqq4az] GET /?page=1&limit=10 ‚Üí 200 (34ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":3,"userRole":"dispatcher","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [34mQuery executed in 8ms[39m
13:48:36 [32m‚úÖ [mi6jb10zu8flx] GET /?page=1&limit=10 ‚Üí 200 (21ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 17ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 16ms[39m
13:48:36 [34mQuery executed in 22ms[39m
13:48:36 [32m‚úÖ [mi6jb11zer00z] GET /?page=1&limit=10 ‚Üí 200 (53ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [32m‚úÖ [mi6jb146o7bu9] GET /?page=1&limit=5 ‚Üí 200 (20ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient removed from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [32m‚úÖ [mi6jb1531sis9] GET /?page=1&limit=10&search=test ‚Üí 200 (18ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=total&sortOrder=DESC","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [32m‚úÖ [mi6jb15wwnb7n] GET /?page=1&limit=10&sortBy=total&sortOrder=DESC ‚Üí 200 (19ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"customer","resource":"invoices","policy":"own_invoices_only","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [32m‚úÖ [mi6jb16okgob3] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mClient removed from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [32mInvoice created[39m {"invoiceId":1}
13:48:36 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb17lm60d1] GET /1 ‚Üí 401 (5ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":3,"userRole":"dispatcher","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [32m‚úÖ [mi6jb17z0z0vs] GET /1 ‚Üí 200 (15ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 3ms[39m
13:48:36 [33m‚ö†Ô∏è  [mi6jb18nb2230] GET /99999 ‚Üí 404 (13ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:36 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb19bv7vwq] GET /invalid ‚Üí 400 (13ms)[39m
13:48:36 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb1a2gaktl] POST / ‚Üí 401 (12ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":5,"userRole":"customer","resource":"invoices","operation":"create"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb1aorhph6] POST / ‚Üí 403 (12ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":4,"userRole":"technician","resource":"invoices","operation":"create"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb1b8k815f] POST / ‚Üí 403 (10ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [32mInvoice created[39m {"invoiceId":2}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 5ms[39m
13:48:36 [32mAudit event[39m {"userId":3,"action":"create","resourceType":"invoice","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:36 [32m‚úÖ [mi6jb1br26lrc] POST / ‚Üí 201 (23ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [32mInvoice created[39m {"invoiceId":3}
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 3ms[39m
13:48:36 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"invoice","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:36 [32m‚úÖ [mi6jb1cnh2ttw] POST / ‚Üí 201 (19ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [33m‚ö†Ô∏è  [mi6jb1dgpvcex] POST / ‚Üí 400 (9ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33m‚ö†Ô∏è  [mi6jb1e1h7yvk] POST / ‚Üí 400 (10ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 6ms[39m
13:48:36 [33m‚ö†Ô∏è  [mi6jb1ek6ssif] POST / ‚Üí 400 (10ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 4ms[39m
13:48:36 [32mInvoice created[39m {"invoiceId":4}
13:48:36 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/4"}
13:48:36 [33m‚ö†Ô∏è  [mi6jb1f8iz34u] PATCH /4 ‚Üí 401 (5ms)[39m
13:48:36 [34mClient acquired from pool[39m
13:48:36 [34mQuery executed in 7ms[39m
13:48:36 [32mInvoice created[39m {"invoiceId":5}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/5","userId":5,"userRole":"customer","resource":"invoices","operation":"update"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1fskytpd] PATCH /5 ‚Üí 403 (10ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":6}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/6","userId":4,"userRole":"technician","resource":"invoices","operation":"update"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1gfh1a9c] PATCH /6 ‚Üí 403 (11ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":7}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [32mInvoice updated[39m {"invoiceId":7}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [32mAudit event[39m {"userId":3,"action":"update","resourceType":"invoice","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:37 [32m‚úÖ [mi6jb1h5nyaxb] PATCH /7 ‚Üí 200 (30ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":8}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [32mInvoice updated[39m {"invoiceId":8}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [32mAudit event[39m {"userId":1,"action":"update","resourceType":"invoice","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:37 [32m‚úÖ [mi6jb1ie5l8y5] PATCH /8 ‚Üí 200 (28ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":9}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [33m‚ö†Ô∏è  [mi6jb1jlysbbn] PATCH /99999 ‚Üí 404 (16ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":10}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1kiprtrb] PATCH /invalid ‚Üí 400 (11ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":11}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33m‚ö†Ô∏è  [mi6jb1l8nvfg1] PATCH /11 ‚Üí 400 (11ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":12}
13:48:37 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/12"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1m1uh3b7] DELETE /12 ‚Üí 401 (5ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":13}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/13","userId":3,"userRole":"dispatcher","resource":"invoices","operation":"delete"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1mmed778] DELETE /13 ‚Üí 403 (9ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":14}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [33mInvoice permanently deleted[39m {"invoiceId":14}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 2ms[39m
13:48:37 [32mAudit event[39m {"userId":2,"action":"delete","resourceType":"invoice","resourceId":14,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:37 [32m‚úÖ [mi6jb1n9eyjqd] DELETE /14 ‚Üí 200 (24ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":15}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 3ms[39m
13:48:37 [33mInvoice permanently deleted[39m {"invoiceId":15}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mAudit event[39m {"userId":1,"action":"delete","resourceType":"invoice","resourceId":15,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:37 [32m‚úÖ [mi6jb1ocsdzf7] DELETE /15 ‚Üí 200 (24ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":16}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [33m‚ö†Ô∏è  [mi6jb1pfb9s6j] DELETE /99999 ‚Üí 404 (14ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 4ms[39m
13:48:37 [32mInvoice created[39m {"invoiceId":17}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:37 [33m‚ö†Ô∏è  [mi6jb1qa234nx] DELETE /invalid ‚Üí 400 (9ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"customer","resource":"invoices","policy":"own_invoices_only","severity":"DEBUG"}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mQuery executed in 7ms[39m
13:48:37 [32m‚úÖ [mi6jb1qu9yr20] GET /?page=1&limit=100 ‚Üí 200 (18ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"technician","resource":"invoices","policy":"deny_all","severity":"DEBUG"}
13:48:37 [33mRLS deny_all policy for invoices[39m {"userId":4}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mQuery executed in 7ms[39m
13:48:37 [32m‚úÖ [mi6jb1rmjaum1] GET /?page=1&limit=100 ‚Üí 200 (20ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":1,"userRole":"admin","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [32m‚úÖ [mi6jb1sfash3j] GET /?page=1&limit=100 ‚Üí 200 (18ms)[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":3,"userRole":"dispatcher","resource":"invoices","policy":"all_records","severity":"DEBUG"}
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mClient acquired from pool[39m
13:48:37 [34mQuery executed in 5ms[39m
13:48:37 [34mQuery executed in 6ms[39m
13:48:37 [32m‚úÖ [mi6jb1t7w49gr] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:37 [34mClient acquired from pool[39m
PASS integration __tests__/integration/invoices-api.test.js
  Invoices CRUD API - Integration Tests
    GET /api/invoices - List Invoices
      ‚àö should return 401 without authentication (25 ms)
      ‚àö should return 403 for technician role (deny_all RLS) (58 ms)
      ‚àö should allow customer to read invoices list (RLS applies) (48 ms)
      ‚àö should return paginated invoice list for dispatcher (39 ms)
      ‚àö should include invoice data in list (72 ms)
      ‚àö should support pagination parameters (37 ms)
      ‚àö should support search parameter (30 ms)
      ‚àö should support sorting (30 ms)
      ‚àö should apply RLS filtering for customer role (26 ms)
    GET /api/invoices/:id - Get Invoice by ID
      ‚àö should return 401 without authentication (13 ms)
      ‚àö should return invoice by ID for dispatcher (24 ms)
      ‚àö should return 404 for non-existent invoice (22 ms)
      ‚àö should return 400 for invalid ID format (25 ms)
    POST /api/invoices - Create Invoice
      ‚àö should return 401 without authentication (26 ms)
      ‚àö should return 403 for customer role (dispatcher+ required) (19 ms)
      ‚àö should return 403 for technician role (dispatcher+ required) (18 ms)
      ‚àö should create invoice with valid data as dispatcher (32 ms)
      ‚àö should create invoice with minimal required data (29 ms)
      ‚àö should reject missing required fields (18 ms)
      ‚àö should reject invalid customer_id (22 ms)
      ‚àö should reject negative total (18 ms)
    PATCH /api/invoices/:id - Update Invoice
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return 403 for customer role (dispatcher+ required) (26 ms)
      ‚àö should return 403 for technician role (dispatcher+ required) (23 ms)
      ‚àö should update invoice with valid data as dispatcher (45 ms)
      ‚àö should update multiple fields (43 ms)
      ‚àö should return 404 for non-existent invoice (30 ms)
      ‚àö should return 400 for invalid ID format (28 ms)
      ‚àö should reject update with no fields (28 ms)
    DELETE /api/invoices/:id - Delete Invoice
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (25 ms)
      ‚àö should soft delete invoice as manager (37 ms)
      ‚àö should delete invoice as admin (38 ms)
      ‚àö should return 404 for non-existent invoice (29 ms)
      ‚àö should return 400 for invalid ID format (27 ms)
    RLS (Row-Level Security) - Invoice Access
      ‚àö should apply RLS filtering for customer role on GET list (27 ms)
      ‚àö should deny access for technician role (deny_all RLS) (30 ms)
      ‚àö should not apply RLS filtering for admin role (27 ms)
      ‚àö should apply RLS filtering for dispatcher role (all_records policy) (25 ms)

13:48:38 [34mClient removed from pool[39m
13:48:38 [34mClient removed from pool[39m
PASS unit __tests__/unit/services/token-service.test.js
  TokenService
    generateTokenPair()
      ‚àö should generate valid access and refresh tokens (73 ms)
      ‚àö should store refresh token hash in database (65 ms)
      ‚àö should set correct token expiration times (64 ms)
      ‚àö should include user metadata in access token (64 ms)
      ‚àö should handle database errors gracefully (66 ms)
      ‚àö should work without optional IP and user agent (65 ms)
    refreshAccessToken()
      ‚àö should generate new access token with valid refresh token (254 ms)
      ‚àö should update refresh token last_used_at timestamp (252 ms)
      ‚àö should reject expired refresh token (66 ms)
      ‚àö should reject revoked refresh token (64 ms)
      ‚àö should reject invalid refresh token signature (65 ms)
      ‚àö should reject if refresh token not found in database (65 ms)
    revokeToken()
      ‚àö should mark token as revoked in database (2 ms)
      ‚àö should handle non-existent token gracefully (1 ms)
      ‚àö should allow custom revocation reason (2 ms)
    revokeAllUserTokens()
      ‚àö should revoke all tokens for a user (1 ms)
      ‚àö should return zero if user has no tokens (1 ms)
    cleanupExpiredTokens()
      ‚àö should delete expired tokens from database (2 ms)
      ‚àö should return zero if no expired tokens (1 ms)
      ‚àö should handle database errors during cleanup (1 ms)
    getUserTokens()
      ‚àö should return all active tokens for a user (1 ms)
      ‚àö should return empty array if user has no tokens (2 ms)
    Error Handling
      ‚àö should throw descriptive errors (64 ms)
      ‚àö should handle malformed JWT tokens (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:39 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:39 [34mNew database client connected to pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [32mCustomer created[39m {"customerId":1}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [32mTechnician created[39m {"technicianId":1}
13:48:39 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:39 [33m‚ö†Ô∏è  [mi6jb3k8k7pto] GET / ‚Üí 401 (4ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 6ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":5,"userRole":"customer","resource":"work_orders","policy":"own_work_orders_only","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 6ms[39m
13:48:39 [34mNew database client connected to pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 23ms[39m
13:48:39 [32m‚úÖ [mi6jb3kn0fpi7] GET /?page=1&limit=10 ‚Üí 200 (37ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 11ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":4,"userRole":"technician","resource":"work_orders","policy":"assigned_work_orders_only","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [32m‚úÖ [mi6jb3lymovhh] GET /?page=1&limit=10 ‚Üí 200 (22ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":3,"userRole":"dispatcher","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [32m‚úÖ [mi6jb3mylp0cg] GET /?page=1&limit=10 ‚Üí 200 (16ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 3ms[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [32m‚úÖ [mi6jb3nojmp2x] GET /?page=1&limit=10 ‚Üí 200 (14ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=5","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [32m‚úÖ [mi6jb3ocghdt8] GET /?page=1&limit=5 ‚Üí 200 (16ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 6ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&search=test","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [34mQuery executed in 5ms[39m
13:48:39 [32m‚úÖ [mi6jb3p2jwry0] GET /?page=1&limit=10&search=test ‚Üí 200 (18ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 6ms[39m
13:48:39 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=10&sortBy=created_at&sortOrder=DESC","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 4ms[39m
13:48:39 [34mQuery executed in 6ms[39m
13:48:39 [32m‚úÖ [mi6jb3pt2bdgg] GET /?page=1&limit=10&sortBy=created_at&sortOrder=DESC ‚Üí 200 (18ms)[39m
13:48:39 [34mClient acquired from pool[39m
13:48:39 [34mQuery executed in 10ms[39m
13:48:39 [32mWork order created[39m {"workOrderId":1}
13:48:39 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/1"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb3r2iksyf] GET /1 ‚Üí 401 (5ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1","userId":3,"userRole":"dispatcher","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32m‚úÖ [mi6jb3rizg9m8] GET /1 ‚Üí 200 (16ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 7ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/99999","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 3ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb3s7y7g7r] GET /99999 ‚Üí 404 (15ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/invalid","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:40 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb3swjd8hh] GET /invalid ‚Üí 400 (10ms)[39m
13:48:40 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb3th4kfq8] POST / ‚Üí 401 (11ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 7ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb3u0sehj2] POST / ‚Üí 400 (11ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":2}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [32mAudit event[39m {"userId":3,"action":"create","resourceType":"work_order","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:40 [32m‚úÖ [mi6jb3uk2pd9x] POST / ‚Üí 201 (24ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb3vh5p5zo] POST / ‚Üí 400 (10ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":3}
13:48:40 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/3"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb3w6a9c0k] PATCH /3 ‚Üí 401 (4ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":4}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 7ms[39m
13:48:40 [32mWork order updated[39m {"workOrderId":4}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 3ms[39m
13:48:40 [32mAudit event[39m {"userId":3,"action":"update","resourceType":"work_order","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:40 [32m‚úÖ [mi6jb3wqhl523] PATCH /4 ‚Üí 200 (34ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":5}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb3y3h97iw] PATCH /99999 ‚Üí 404 (14ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":6}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb3yvnl5nk] PATCH /6 ‚Üí 400 (9ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":7}
13:48:40 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/7"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb3zj5q92o] DELETE /7 ‚Üí 401 (4ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":8}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 7ms[39m
13:48:40 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/8","userId":3,"userRole":"dispatcher","resource":"work_orders","operation":"delete"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb403sali6] DELETE /8 ‚Üí 403 (11ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":9}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [33mWork order permanently deleted[39m {"workOrderId":9}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 3ms[39m
13:48:40 [32mAudit event[39m {"userId":2,"action":"delete","resourceType":"work_order","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:40 [32m‚úÖ [mi6jb40tskjhv] DELETE /9 ‚Üí 200 (26ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":10}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 3ms[39m
13:48:40 [33m‚ö†Ô∏è  [mi6jb41yakqf6] DELETE /99999 ‚Üí 404 (13ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32mWork order created[39m {"workOrderId":11}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"id","value":"invalid","valueType":"string","reason":"Cannot convert to integer (parsed as NaN)"}
13:48:40 [33m‚ö†Ô∏è  [mi6jb42qddbbq] DELETE /invalid ‚Üí 400 (9ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":5,"userRole":"customer","resource":"work_orders","policy":"own_work_orders_only","severity":"DEBUG"}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [32m‚úÖ [mi6jb437m199m] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":4,"userRole":"technician","resource":"work_orders","policy":"assigned_work_orders_only","severity":"DEBUG"}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 4ms[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32m‚úÖ [mi6jb43x6xjsr] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 6ms[39m
13:48:40 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=1&limit=100","userId":1,"userRole":"admin","resource":"work_orders","policy":"all_records","severity":"DEBUG"}
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mClient acquired from pool[39m
13:48:40 [34mQuery executed in 3ms[39m
13:48:40 [34mQuery executed in 5ms[39m
13:48:40 [32m‚úÖ [mi6jb44m5bc2l] GET /?page=1&limit=100 ‚Üí 200 (16ms)[39m
13:48:40 [34mClient acquired from pool[39m
PASS integration __tests__/integration/work-orders-api.test.js
  Work Orders CRUD API - Integration Tests
    GET /api/work_orders - List Work Orders
      ‚àö should return 401 without authentication (16 ms)
      ‚àö should allow customer to read work orders list (RLS applies) (46 ms)
      ‚àö should allow technician to read assigned work orders (RLS applies) (31 ms)
      ‚àö should return paginated work order list for dispatcher (29 ms)
      ‚àö should include work order data in list (25 ms)
      ‚àö should support pagination parameters (25 ms)
      ‚àö should support search parameter (27 ms)
      ‚àö should support sorting (28 ms)
    GET /api/work_orders/:id - Get Work Order by ID
      ‚àö should return 401 without authentication (18 ms)
      ‚àö should return work order by ID for dispatcher (26 ms)
      ‚àö should return 404 for non-existent work order (24 ms)
      ‚àö should return 400 for invalid ID format (22 ms)
    POST /api/work_orders - Create Work Order
      ‚àö should return 401 without authentication (19 ms)
      ‚àö should allow customer to create work order (self-service) (19 ms)
      ‚àö should create work order with valid data as dispatcher (33 ms)
      ‚àö should reject missing required fields (18 ms)
    PATCH /api/work_orders/:id - Update Work Order
      ‚àö should return 401 without authentication (20 ms)
      ‚àö should update work order as dispatcher (50 ms)
      ‚àö should return 404 for non-existent work order (28 ms)
      ‚àö should reject update with no fields (23 ms)
    DELETE /api/work_orders/:id - Delete Work Order
      ‚àö should return 401 without authentication (21 ms)
      ‚àö should return 403 for dispatcher role (manager+ required) (24 ms)
      ‚àö should soft delete work order as manager (41 ms)
      ‚àö should return 404 for non-existent work order (26 ms)
      ‚àö should return 400 for invalid ID format (24 ms)
    RLS (Row-Level Security) - Work Order Access
      ‚àö should apply RLS filtering for customer role (24 ms)
      ‚àö should apply RLS filtering for technician role (26 ms)
      ‚àö should not apply RLS filtering for admin role (24 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:40 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:41 [34mNew database client connected to pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb4o3etcyp] GET /me ‚Üí 401 (6ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 7ms[39m
13:48:41 [32m‚úÖ [mi6jb4oie99cw] GET /me ‚Üí 200 (11ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 6ms[39m
13:48:41 [32m‚úÖ [mi6jb4p3les6s] GET /me ‚Üí 200 (8ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 6ms[39m
13:48:41 [32m‚úÖ [mi6jb4pksyt8y] GET /me ‚Üí 200 (10ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [32m‚úÖ [mi6jb4qaeowyk] GET /me ‚Üí 200 (8ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [32m‚úÖ [mi6jb4qrk2akf] GET /me ‚Üí 200 (7ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_INVALID_TOKEN","url":"/me","error":"invalid token"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb4r8p4dnf] GET /me ‚Üí 403 (5ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb4rnkrijh] PUT /me ‚Üí 401 (9ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [32m‚úÖ [mi6jb4s64b4bv] PUT /me ‚Üí 200 (31ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [32m‚úÖ [mi6jb4tah28m1] PUT /me ‚Üí 200 (28ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [32m‚úÖ [mi6jb4uc4ow6q] PUT /me ‚Üí 200 (24ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [33m‚ö†Ô∏è  [mi6jb4vax5xw5] PUT /me ‚Üí 400 (8ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [33m‚ö†Ô∏è  [mi6jb4vt7l04u] PUT /me ‚Üí 400 (13ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [33m‚ö†Ô∏è  [mi6jb4we2lhjt] PUT /me ‚Üí 400 (10ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mClient removed from pool[39m
13:48:41 [34mQuery executed in 6ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [32m‚úÖ [mi6jb4wys5k2q] PUT /me ‚Üí 200 (26ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 7ms[39m
13:48:41 [32m‚úÖ [mi6jb4xvdugby] GET /me ‚Üí 200 (9ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mClient removed from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [32m‚úÖ [mi6jb4ydnlgev] PUT /me ‚Üí 200 (28ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [33m‚ö†Ô∏è  [mi6jb4ze5hdka] PUT /me ‚Üí 400 (8ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 2ms[39m
13:48:41 [32m‚úÖ [mi6jb4zvxe1o5] PUT /me ‚Üí 200 (26ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [32m‚úÖ [mi6jb50vd0gqv] GET /me ‚Üí 200 (7ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [32m‚úÖ [mi6jb51ceydqc] GET /me ‚Üí 200 (7ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb51t15al0] GET /me ‚Üí 401 (4ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb527yz2sy] GET /me ‚Üí 401 (4ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 6ms[39m
13:48:41 [32m‚úÖ [mi6jb52kld2zo] GET /me ‚Üí 200 (9ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 26ms[39m
13:48:41 [32m‚úÖ [mi6jb53etl5hb] GET /me ‚Üí 200 (28ms)[39m
13:48:41 [34mNew database client connected to pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mNew database client connected to pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mNew database client connected to pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mNew database client connected to pool[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 43ms[39m
13:48:41 [32m‚úÖ [mi6jb53o3lrds] GET /me ‚Üí 200 (47ms)[39m
13:48:41 [34mQuery executed in 41ms[39m
13:48:41 [32m‚úÖ [mi6jb53y1qn1x] GET /me ‚Üí 200 (43ms)[39m
13:48:41 [34mQuery executed in 49ms[39m
13:48:41 [32m‚úÖ [mi6jb53tuf9ca] GET /me ‚Üí 200 (51ms)[39m
13:48:41 [34mQuery executed in 64ms[39m
13:48:41 [32m‚úÖ [mi6jb53jf4fz2] GET /me ‚Üí 200 (66ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 6ms[39m
13:48:41 [32m‚úÖ [mi6jb55q4wexg] GET /me ‚Üí 200 (9ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 5ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 7ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [32m‚úÖ [mi6jb568ifr4r] PUT /me ‚Üí 200 (33ms)[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 4ms[39m
13:48:41 [34mClient acquired from pool[39m
13:48:41 [34mQuery executed in 3ms[39m
13:48:41 [32m‚úÖ [mi6jb57en3icu] PUT /me ‚Üí 200 (28ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb58i7oqap] GET /me ‚Üí 401 (6ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb58qbj1mu] GET /me ‚Üí 401 (4ms)[39m
13:48:41 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/me"}
13:48:41 [33m‚ö†Ô∏è  [mi6jb58wy59qd] GET /me ‚Üí 401 (3ms)[39m
13:48:41 [34mClient acquired from pool[39m
PASS integration __tests__/integration/auth-api.test.js
  Auth API Endpoints - Integration Tests
    GET /api/auth/me - Get Current User Profile
      ‚àö should return 401 without authentication (15 ms)
      ‚àö should return user profile with valid token (20 ms)
      ‚àö should include user name in response (18 ms)
      ‚àö should include role information (17 ms)
      ‚àö should return correct data for different user roles (41 ms)
      ‚àö should return 403 with invalid token format (13 ms)
    PUT /api/auth/me - Update User Profile
      ‚àö should return 401 without authentication (19 ms)
      ‚àö should update first name (39 ms)
      ‚àö should update last name (36 ms)
      ‚àö should update both first and last name (35 ms)
      ‚àö should return 400 with no valid fields (18 ms)
      ‚àö should reject disallowed field updates (22 ms)
      ‚àö should validate first_name length (18 ms)
      ‚àö should persist updates to database (53 ms)
    Profile Update Validation
      ‚àö should trim whitespace from names (36 ms)
      ‚àö should reject empty string names (17 ms)
      ‚àö should handle special characters in names (36 ms)
    Auth Endpoints - Response Format
      ‚àö should return proper content-type (17 ms)
      ‚àö should include timestamp in success responses (17 ms)
      ‚àö should include timestamp in error responses (12 ms)
      ‚àö should return consistent error format (14 ms)
    Auth Endpoints - Performance
      ‚àö should respond quickly to profile requests (18 ms)
      ‚àö should handle concurrent profile requests (97 ms)
    Auth Endpoints - Security
      ‚àö should not leak sensitive data in responses (17 ms)
      ‚àö should not allow updating other users profiles (78 ms)
      ‚àö should validate authorization header format (36 ms)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.177Z SETUP: Loading modules

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.180Z MOCK: Creating db connection mock

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.184Z MOCK: Creating auth middleware mock

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.185Z MOCK: Creating logger mock

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.186Z SETUP: Modules loaded successfully

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.188Z SUITE: beforeAll - Starting health routes test suite

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.190Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.191Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.192Z TEST START: healthy status test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.193Z ARRANGE: db.query mocked

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.193Z ACT: Sending GET /api/health

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.202Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.203Z TEST END: healthy status test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.204Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.204Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.206Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.207Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.209Z TEST START: unhealthy status test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.209Z ARRANGE: db.query mocked to reject

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.210Z ACT: Sending GET /api/health

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.219Z ACT: Response received, status: 503

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.219Z TEST END: unhealthy status test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.220Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.220Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.222Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.223Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.224Z TEST START: timestamp format test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.233Z TEST END: timestamp format test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.234Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.234Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.236Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.237Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.238Z TEST START: uptime test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.248Z TEST END: uptime test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.248Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.249Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.251Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.252Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.252Z TEST START: timestamp in databases response test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.253Z ARRANGE: db.query and pool configured

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.253Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.258Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.260Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.266Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.266Z TEST END: timestamp in databases response test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.267Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.267Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.269Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.270Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.270Z TEST START: missing pool options test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.271Z ARRANGE: db.query and pool configured with missing options

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.271Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.277Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.278Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.296Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.297Z TEST END: missing pool options test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.297Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.298Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.299Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.300Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.301Z TEST START: healthy status for fast DB test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.302Z ARRANGE: db.query and pool configured

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.302Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.307Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.308Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.313Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.314Z TEST END: healthy status for fast DB test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.315Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.315Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.317Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.318Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.318Z TEST START: high connection usage test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.319Z ARRANGE: db.query and pool configured with 90% usage

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.319Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.324Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.325Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.330Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.331Z TEST END: high connection usage test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.331Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.332Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.334Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.334Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.335Z TEST START: very high connection usage test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.336Z ARRANGE: db.query and pool configured with 100% usage

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.336Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.341Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.343Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.348Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.348Z TEST END: very high connection usage test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.349Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.349Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.351Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.352Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.352Z TEST START: DB query failure test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.353Z ARRANGE: db.query mocked to reject with error

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.353Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.359Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.361Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.366Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.366Z TEST END: DB query failure test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.367Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.368Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.369Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.370Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.371Z TEST START: slow DB test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.371Z ARRANGE: db.query mocked with 250ms delay

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.372Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.378Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.379Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.646Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.647Z TEST END: slow DB test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.647Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.648Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.649Z TEST: beforeEach - Setting up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.650Z TEST: beforeEach - Setup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.651Z TEST START: very slow DB test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.652Z ARRANGE: db.query mocked with 600ms delay

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.652Z ACT: Sending GET /api/health/databases

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.675Z AUTH: authenticateToken called - passing through

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:42.676Z AUTH: requireMinimumRole called

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

13:48:42 [34mClient removed from pool[39m
13:48:42 [34mClient removed from pool[39m
13:48:42 [34mClient removed from pool[39m
13:48:42 [34mClient removed from pool[39m
13:48:43 [34mClient removed from pool[39m
  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.295Z ACT: Response received, status: 200

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.295Z TEST END: very slow DB test - PASSED

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.296Z TEST: afterEach - Cleaning up test

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.296Z TEST: afterEach - Cleanup complete

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.297Z SUITE: afterAll - Cleaning up health routes test suite

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

  console.log
    [HEALTH-TEST] 2025-11-19T21:48:43.298Z MOCK: Creating db connection mock

      at originalLog (__tests__/unit/routes/health.test.js:21:30)

PASS unit __tests__/unit/routes/health.test.js
  Health Routes
    GET /api/health
      ‚àö should return healthy status when DB is connected (16 ms)
      ‚àö should return unhealthy status when DB connection fails (16 ms)
      ‚àö should return valid timestamp in ISO format (14 ms)
      ‚àö should return positive uptime (15 ms)
    GET /api/health/databases
      ‚àö should include timestamp in response (18 ms)
      ‚àö should handle missing pool options gracefully (30 ms)
      ‚àö should return healthy status for fast DB with low connection usage (17 ms)
      ‚àö should return degraded status for high connection usage (80-95%) (17 ms)
      ‚àö should return critical status for very high connection usage (>95%) (17 ms)
      ‚àö should return critical status when DB query fails (18 ms)
      ‚àö should return degraded status for slow DB (100-500ms) (280 ms)
      ‚àö should return critical status for very slow DB (>500ms) (648 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:43 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:43 [34mNew database client connected to pool[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 20ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588923890-4mhngo724@test.com",
      "first_name": "Lifecycle",
      "last_name": "Test"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 4ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 3ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 2ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 6ms[39m
13:48:43 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:43 [32m‚úÖ [mi6jb6rcexft8] POST / ‚Üí 201 (53ms)[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 3ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 4ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 5ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 5ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 2ms[39m
13:48:43 [34mClient acquired from pool[39m
13:48:43 [34mQuery executed in 3ms[39m
13:48:43 [32mAudit event[39m {"userId":1,"action":"user_update","resourceType":"user","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:43 [32m‚úÖ [mi6jb6t94g2w2] PUT /3 ‚Üí 200 (29ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 11ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_delete","resourceType":"user","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb6uab931j] DELETE /3 ‚Üí 200 (32ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924055-6dr7bfpec@test.com",
      "first_name": "First",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 24ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":4,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb6vy99zju] POST / ‚Üí 201 (59ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924055-6dr7bfpec@test.com",
      "first_name": "Second",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [31mQuery error:[39m {"error":"duplicate key value violates unique constraint \"users_email_key\"","query":"\n        INSERT INTO users (email, first_name, last_name, role_id, auth0_id, status) \n        VALUES ($1, $2, $3, $4, $5, $6) \n        RETURNING *\n      "}
13:48:44 [31mError creating user[39m {"error":"duplicate key value violates unique constraint \"users_email_key\"","email":"test-1763588924055-6dr7bfpec@test.com"}
13:48:44 [31mError creating user[39m {"error":"Email already exists","email":"test-1763588924055-6dr7bfpec@test.com"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb6xx4zng9] POST / ‚Üí 409 (24ms)[39m
13:48:44 [34mClient removed from pool[39m
13:48:44 [34mNew database client connected to pool[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 26ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "first_name": "No",
      "last_name": "Email"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [33m‚ö†Ô∏è  [mi6jb6yxq65xk] POST / ‚Üí 400 (31ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924206-qmaishiot@test.com",
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 2ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb702bcu3o] POST / ‚Üí 201 (29ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 10ms[39m
13:48:44 [33m‚ö†Ô∏è  [mi6jb714gjt3m] PUT /6 ‚Üí 400 (14ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [33m‚ö†Ô∏è  [mi6jb71qgihxn] PUT /99999 ‚Üí 404 (14ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [33m‚ö†Ô∏è  [mi6jb72ekreit] DELETE /99999 ‚Üí 404 (11ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [33m‚ö†Ô∏è  [mi6jb734cs7n9] DELETE /1 ‚Üí 400 (9ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/","userId":2,"userRole":"client","resource":"users","operation":"create"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb73m4jl69] POST / ‚Üí 403 (10ms)[39m
13:48:44 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb74c787ar] POST / ‚Üí 401 (5ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924377-6apa7ea9w@test.com",
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb74s1ugbr] POST / ‚Üí 201 (28ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/7","userId":2,"userRole":"client","resource":"users","operation":"update"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb75ueoqii] PUT /7 ‚Üí 403 (12ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924436-j949qj0jf@test.com",
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":8,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb76gikznc] POST / ‚Üí 201 (33ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
13:48:44 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/8","userId":2,"userRole":"client","resource":"users","operation":"delete"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb77pzih56] DELETE /8 ‚Üí 403 (12ms)[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 6ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-1763588924503-uk6vb1ikg@test.com",
      "first_name": "Test",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588923852@test.com

      at log (routes/users.js:339:13)

13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 3ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 5ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [34mClient acquired from pool[39m
13:48:44 [34mQuery executed in 4ms[39m
13:48:44 [32mAudit event[39m {"userId":1,"action":"user_create","resourceType":"user","resourceId":9,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:44 [32m‚úÖ [mi6jb78a63fc5] POST / ‚Üí 201 (34ms)[39m
13:48:44 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/9"}
13:48:44 [33m‚ö†Ô∏è  [mi6jb79hkha4s] DELETE /9 ‚Üí 401 (4ms)[39m
13:48:44 [34mClient acquired from pool[39m
PASS integration __tests__/integration/db/user-crud-lifecycle.test.js
  User CRUD Lifecycle Tests
    Complete User Lifecycle: CREATE ‚Üí READ ‚Üí UPDATE ‚Üí DELETE
      ‚àö 1. CREATE: Should create a new user (63 ms)
      ‚àö 2. READ: Should retrieve the created user (6 ms)
      ‚àö 3. UPDATE: Should update the user details (38 ms)
      ‚àö 4. DELETE: Should permanently delete the user (49 ms)
      ‚àö 5. AUDIT: Should have logged all lifecycle operations (8 ms)
    Validation Tests (Using Fresh Entities)
      ‚àö CREATE: Should reject duplicate email (109 ms)
      ‚àö CREATE: Should reject missing email (40 ms)
      ‚àö UPDATE: Should reject empty updates (61 ms)
      ‚àö UPDATE: Should reject non-existent user (21 ms)
      ‚àö DELETE: Should reject non-existent user (22 ms)
      ‚àö DELETE: Should prevent admin from deleting themselves (23 ms)
    Authorization Tests
      ‚àö CREATE: Should reject non-admin user (24 ms)
      ‚àö CREATE: Should reject unauthenticated request (16 ms)
      ‚àö UPDATE: Should reject non-admin user (61 ms)
      ‚àö DELETE: Should reject non-admin user (67 ms)
      ‚àö DELETE: Should reject unauthenticated request (56 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:44 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:45 [34mNew database client connected to pool[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=0","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"page","value":"0","valueType":"string","reason":"Value 0 is below minimum 1"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"page\":\"0\"}","valueType":"object","reason":"page must be at least 1","url":"/?page=0","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb7srelaqz] GET /?page=0 ‚Üí 400 (13ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=-5","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"page","value":"-5","valueType":"string","reason":"Value -5 is below minimum 1"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"page\":\"-5\"}","valueType":"object","reason":"page must be at least 1","url":"/?page=-5","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb7tqptfp2] GET /?page=-5 ‚Üí 400 (10ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 5ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?limit=0","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","value":"0","valueType":"string","reason":"Value 0 is below minimum 1"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"limit\":\"0\"}","valueType":"object","reason":"limit must be at least 1","url":"/?limit=0","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb7ucwsma6] GET /?limit=0 ‚Üí 400 (11ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?page=999999","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"page\":\"999999\"}","valueType":"object","reason":"limit is required","url":"/?page=999999","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb7uwz97ld] GET /?page=999999 ‚Üí 400 (12ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?limit=999999","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","value":"999999","valueType":"string","reason":"Value 999999 exceeds maximum 200"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"limit\":\"999999\"}","valueType":"object","reason":"limit must be at most 200","url":"/?limit=999999","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb7vih4vn6] GET /?limit=999999 ‚Üí 400 (11ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 5ms[39m
13:48:45 [32mCustomer created[39m {"customerId":1}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 5ms[39m
13:48:45 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:45 [32m‚úÖ [mi6jb7w63khwj] POST / ‚Üí 201 (30ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 12ms[39m
13:48:45 [33mCustomer permanently deleted[39m {"customerId":1}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [32mCustomer created[39m {"customerId":2}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 2ms[39m
13:48:45 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:45 [32m‚úÖ [mi6jb7xl4v5ma] POST / ‚Üí 201 (19ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mCustomer permanently deleted[39m {"customerId":2}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 3ms[39m
13:48:45 [32mCustomer created[39m {"customerId":3}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 2ms[39m
13:48:45 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"customer","resourceId":3,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:45 [32m‚úÖ [mi6jb7yja2kqb] POST / ‚Üí 201 (19ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mCustomer permanently deleted[39m {"customerId":3}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 3ms[39m
13:48:45 [32mCustomer created[39m {"customerId":4}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [33m‚ö†Ô∏è  [mi6jb7zmm3u64] POST / ‚Üí 400 (10ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [31mError creating invoice[39m {"error":"Invoice number, customer_id, amount, and total are required"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb807zopwj] POST / ‚Üí 500 (9ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [31mQuery error:[39m {"error":"numeric field overflow","query":"\n        INSERT INTO invoices (invoice_number, work_order_id, customer_id, amount, tax, total, due_date, status)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING *\n      "}
13:48:45 [31mError creating invoice[39m {"error":"numeric field overflow","code":"22003"}
13:48:45 [31mError creating invoice[39m {"error":"Failed to create invoice"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb80r5ojsn] POST / ‚Üí 500 (17ms)[39m
13:48:45 [34mClient removed from pool[39m
13:48:45 [34mNew database client connected to pool[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 29ms[39m
13:48:45 [33mCustomer permanently deleted[39m {"customerId":4}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [32mCustomer created[39m {"customerId":5}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 9ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [31mQuery error:[39m {"error":"invalid input syntax for type date: \"not-a-date\"","query":"\n        INSERT INTO contracts (contract_number, customer_id, start_date, end_date, terms, value, billing_cycle, status)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING *\n      "}
13:48:45 [31mError creating contract[39m {"error":"invalid input syntax for type date: \"not-a-date\"","code":"22007"}
13:48:45 [31mError creating contract[39m {"error":"Failed to create contract"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb82kj4jp5] POST / ‚Üí 500 (19ms)[39m
13:48:45 [34mClient removed from pool[39m
13:48:45 [34mNew database client connected to pool[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 25ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 8ms[39m
13:48:45 [32mContract created[39m {"contractId":1}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 4ms[39m
13:48:45 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"contract","resourceId":1,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:45 [32m‚úÖ [mi6jb83ey1jso] POST / ‚Üí 201 (45ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 5ms[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 5ms[39m
13:48:45 [32mContract created[39m {"contractId":2}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 3ms[39m
13:48:45 [32mAudit event[39m {"userId":1,"action":"create","resourceType":"contract","resourceId":2,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:45 [32m‚úÖ [mi6jb84x4tkvl] POST / ‚Üí 201 (21ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mContract permanently deleted[39m {"contractId":1}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 3ms[39m
13:48:45 [33mContract permanently deleted[39m {"contractId":2}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 8ms[39m
13:48:45 [33mCustomer permanently deleted[39m {"customerId":5}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 10ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?search=NONEXISTENT_CUSTOMER_XYZ123","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"search\":\"NONEXISTENT_CUSTOMER_XYZ123\"}","valueType":"object","reason":"limit is required","url":"/?search=NONEXISTENT_CUSTOMER_XYZ123","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb86f6toyb] GET /?search=NONEXISTENT_CUSTOMER_XYZ123 ‚Üí 400 (15ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?search=%27%22%3B--","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"search\":\"'\\\";--\"}","valueType":"object","reason":"limit is required","url":"/?search=%27%22%3B--","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb875enq3a] GET /?search=%27%22%3B-- ‚Üí 400 (11ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/?search=%27%3B%20DROP%20TABLE%20customers%3B%20--","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{\"search\":\"'; DROP TABLE customers; --\"}","valueType":"object","reason":"limit is required","url":"/?search=%27%3B%20DROP%20TABLE%20customers%3B%20--","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb87s2yzzg] GET /?search=%27%3B%20DROP%20TABLE%20customers%3B%20-- ‚Üí 400 (13ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 7ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeInteger","field":"limit","valueType":"undefined","reason":"Field is required but received undefined"}
13:48:45 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"validatePagination","field":"pagination","value":"{}","valueType":"object","reason":"limit is required","url":"/","method":"GET"}
13:48:45 [33m‚ö†Ô∏è  [mi6jb88cvjgcn] GET / ‚Üí 400 (14ms)[39m
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33mSecurity Event[39m {"event":"RLS_POLICY_APPLIED","url":"/1'%20OR%20'1'='1","userId":1,"userRole":"admin","resource":"customers","policy":"all_records","severity":"DEBUG"}
13:48:45 [34mClient acquired from pool[39m
13:48:45 [34mQuery executed in 6ms[39m
13:48:45 [33m‚ö†Ô∏è  [mi6jb892fk7gs] GET /1'%20OR%20'1'='1 ‚Üí 404 (17ms)[39m
13:48:45 [34mClient acquired from pool[39m
PASS integration __tests__/integration/edge-cases-boundaries.test.js
  Boundary Condition Tests
    Pagination Boundaries
      ‚àö should handle page=0 gracefully (treat as page 1) (34 ms)
      ‚àö should handle negative page numbers (treat as page 1) (23 ms)
      ‚àö should handle limit=0 gracefully (21 ms)
      ‚àö should handle extremely large page numbers (21 ms)
      ‚àö should handle extremely large limit values (20 ms)
    String Length Boundaries
      ‚àö should reject empty string for required name field (56 ms)
      ‚àö should reject extremely long strings (SQL injection attempt) (34 ms)
      ‚àö should handle single character names (35 ms)
    Numeric Boundaries
      ‚àö should reject negative amounts for invoices (18 ms)
      ‚àö should handle zero amounts (20 ms)
      ‚àö should handle very large decimal values (29 ms)
    Date Boundaries
      ‚àö should reject invalid date formats (30 ms)
      ‚àö should reject end_date before start_date (55 ms)
      ‚àö should handle same start and end dates (31 ms)
    Empty Data Set Handling
      ‚àö should return empty array when filtering returns no results (25 ms)
      ‚àö should handle searches with special characters gracefully (24 ms)
    SQL Injection Prevention
      ‚àö should prevent SQL injection in search parameters (43 ms)
      ‚àö should prevent SQL injection in ID parameters (29 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:46 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:46 [34mNew database client connected to pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 17ms[39m
13:48:46 [32m‚úÖ [mi6jb8qs62cjx] GET / ‚Üí 200 (20ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 14ms[39m
13:48:46 [32m‚úÖ [mi6jb8rmt5fk3] GET / ‚Üí 200 (16ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [32m‚úÖ [mi6jb8sbdanl0] GET / ‚Üí 200 (7ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [32m‚úÖ [mi6jb8sq3ael6] GET / ‚Üí 200 (8ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 8ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 2ms[39m
13:48:46 [32m‚úÖ [mi6jb8toerc7p] GET /databases ‚Üí 200 (14ms)[39m
13:48:46 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/databases"}
13:48:46 [33m‚ö†Ô∏è  [mi6jb8ud4urij] GET /databases ‚Üí 401 (4ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [32m‚úÖ [mi6jb8uqqfh1d] GET /databases ‚Üí 200 (14ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 4ms[39m
13:48:46 [32m‚úÖ [mi6jb8vexlwk1] GET /databases ‚Üí 200 (12ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 6ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 2ms[39m
13:48:46 [32m‚úÖ [mi6jb8vz33756] GET /databases ‚Üí 200 (12ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 5ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 2ms[39m
13:48:46 [32m‚úÖ [mi6jb8wlsygnn] GET /databases ‚Üí 200 (11ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 34ms[39m
13:48:46 [32m‚úÖ [mi6jb8y2n0l6g] GET / ‚Üí 200 (36ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 16ms[39m
13:48:46 [32m‚úÖ [mi6jb8yq7n9yo] GET / ‚Üí 200 (17ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 22ms[39m
13:48:46 [32m‚úÖ [mi6jb8yrqlj5c] GET / ‚Üí 200 (24ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 25ms[39m
13:48:46 [32m‚úÖ [mi6jb8ytqu1lj] GET / ‚Üí 200 (27ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 28ms[39m
13:48:46 [32m‚úÖ [mi6jb8yvumpdm] GET / ‚Üí 200 (30ms)[39m
13:48:46 [34mQuery executed in 31ms[39m
13:48:46 [32m‚úÖ [mi6jb8yxnwg9p] GET / ‚Üí 200 (33ms)[39m
13:48:46 [34mNew database client connected to pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mNew database client connected to pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mNew database client connected to pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mNew database client connected to pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 80ms[39m
13:48:46 [32m‚úÖ [mi6jb8ykvt11k] GET / ‚Üí 200 (82ms)[39m
13:48:46 [34mQuery executed in 98ms[39m
13:48:46 [32m‚úÖ [mi6jb8y5qk6un] GET / ‚Üí 200 (100ms)[39m
13:48:46 [34mQuery executed in 92ms[39m
13:48:46 [32m‚úÖ [mi6jb8yfcfocz] GET / ‚Üí 200 (94ms)[39m
13:48:46 [33müêå Slow query detected[39m {"duration":"100ms","query":"SELECT 1","params":0,"threshold":"100ms"}
13:48:46 [32m‚úÖ [mi6jb8y9yfy5g] GET / ‚Üí 200 (103ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 20ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 20ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 12ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 22ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 13ms[39m
13:48:46 [32m‚úÖ [mi6jb91x1kxk4] GET /databases ‚Üí 200 (35ms)[39m
13:48:46 [34mQuery executed in 24ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 16ms[39m
13:48:46 [32m‚úÖ [mi6jb920llwij] GET /databases ‚Üí 200 (41ms)[39m
13:48:46 [34mQuery executed in 17ms[39m
13:48:46 [32m‚úÖ [mi6jb92dfcqc2] GET /databases ‚Üí 200 (32ms)[39m
13:48:46 [34mQuery executed in 17ms[39m
13:48:46 [32m‚úÖ [mi6jb926hd9vk] GET /databases ‚Üí 200 (42ms)[39m
13:48:46 [34mQuery executed in 18ms[39m
13:48:46 [32m‚úÖ [mi6jb929k2nom] GET /databases ‚Üí 200 (47ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 4ms[39m
13:48:46 [32m‚úÖ [mi6jb949aadix] GET / ‚Üí 200 (8ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 7ms[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 3ms[39m
13:48:46 [32m‚úÖ [mi6jb94rjjwt2] GET /databases ‚Üí 200 (13ms)[39m
13:48:46 [34mClient acquired from pool[39m
13:48:46 [34mQuery executed in 4ms[39m
13:48:47 [32m‚úÖ [mi6jb95ehtmwn] GET / ‚Üí 200 (6ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [32m‚úÖ [mi6jb95u9yegm] GET / ‚Üí 200 (7ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [32m‚úÖ [mi6jb96amxde6] GET / ‚Üí 200 (7ms)[39m
PASS integration __tests__/integration/health-api.test.js
  Health Endpoints - Integration Tests
    GET /api/health - Basic Health Check
      ‚àö should return 200 and healthy status (30 ms)
      ‚àö should include uptime greater than or equal to 0 (25 ms)
      ‚àö should have valid timestamp (16 ms)
      ‚àö should verify database connectivity (15 ms)
    GET /api/health/databases - Database Health Check
      ‚àö should return 200 when database is healthy (23 ms)
      ‚àö should return 401 without authentication (14 ms)
      ‚àö should include database metrics (25 ms)
      ‚àö should have fast response time (21 ms)
      ‚àö should have reasonable connection usage (21 ms)
      ‚àö should determine status based on metrics (21 ms)
    Health Check - Error Scenarios
      ‚àö should handle concurrent health checks (153 ms)
      ‚àö should handle concurrent database health checks (86 ms)
    Health Check - Performance
      ‚àö basic health check should respond quickly (16 ms)
      ‚àö database health check should respond within timeout (23 ms)
    Health Check - Response Format
      ‚àö should return proper content-type headers (16 ms)
      ‚àö should not expose sensitive information (17 ms)
      ‚àö should include all required fields (17 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:47 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:47 [34mNew database client connected to pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 3ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 7ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "test-user_1763588927641_ss870@test.com",
      "first_name": "Role",
      "last_name": "Test"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588927589@test.com

      at log (routes/users.js:339:13)

13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 3ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [32mAudit event[39m {"userId":4,"action":"user_create","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:47 [32m‚úÖ [mi6jb9ngr9mal] POST / ‚Üí 201 (41ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 8ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 12ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 7ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:47 [32m‚úÖ [mi6jb9ozbml1b] PUT /6/role ‚Üí 200 (59ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 14ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 7ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 6ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:47 [32m‚úÖ [mi6jb9rel4qvt] PUT /6/role ‚Üí 200 (45ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:47 [32m‚úÖ [mi6jb9t4rdhwq] PUT /6/role ‚Üí 200 (39ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 5ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 7ms[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mClient removed from pool[39m
13:48:47 [34mQuery executed in 10ms[39m
13:48:47 [33m‚ö†Ô∏è  [mi6jb9urqrea7] PUT /6/role ‚Üí 404 (26ms)[39m
13:48:47 [34mClient removed from pool[39m
13:48:47 [34mClient removed from pool[39m
13:48:47 [34mClient removed from pool[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 4ms[39m
13:48:47 [33m‚ö†Ô∏è  [mi6jb9vzkprtw] PUT /6/role ‚Üí 400 (10ms)[39m
13:48:47 [34mClient acquired from pool[39m
13:48:47 [34mQuery executed in 6ms[39m
13:48:47 [33mSecurity Event[39m {"event":"AUTH_INSUFFICIENT_PERMISSION","url":"/6/role","userId":5,"userRole":"client","resource":"users","operation":"update"}
13:48:47 [33m‚ö†Ô∏è  [mi6jb9wibwz7c] PUT /6/role ‚Üí 403 (11ms)[39m
13:48:47 [33mSecurity Event[39m {"event":"AUTH_MISSING_TOKEN","url":"/6/role"}
13:48:47 [33m‚ö†Ô∏è  [mi6jb9x2eiaxs] PUT /6/role ‚Üí 401 (6ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 2ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":6,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:48 [32m‚úÖ [mi6jb9xh1rheu] PUT /6/role ‚Üí 200 (31ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mClient removed from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "workflow_1763588928049_m28h5@test.com",
      "first_name": "Workflow",
      "last_name": "Test"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: test-1763588927589@test.com

      at log (routes/users.js:339:13)

13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [32mAudit event[39m {"userId":4,"action":"user_create","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:48 [32m‚úÖ [mi6jb9ytqdede] POST / ‚Üí 201 (29ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:48 [32m‚úÖ [mi6jb9zz2lnpc] PUT /7/role ‚Üí 200 (30ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 2ms[39m
13:48:48 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:48 [32m‚úÖ [mi6jba15hx2gh] PUT /7/role ‚Üí 200 (31ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 4ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 2ms[39m
13:48:48 [32mAudit event[39m {"userId":4,"action":"role_assign","resourceType":"user","resourceId":7,"result":"success","ipAddress":"::ffff:127.0.0.1"}
13:48:48 [32m‚úÖ [mi6jba2c1v426] PUT /7/role ‚Üí 200 (29ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 2ms[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 3ms[39m
13:48:48 [31mError setting user role[39m {"error":"User not found","userId":99999,"roleId":2}
13:48:48 [31mError assigning role[39m {"error":"User not found","userId":"99999","roleId":2}
13:48:48 [33m‚ö†Ô∏è  [mi6jba3i995j7] PUT /99999/role ‚Üí 500 (18ms)[39m
13:48:48 [34mClient acquired from pool[39m
13:48:48 [34mQuery executed in 5ms[39m
13:48:48 [33m‚ö†Ô∏è  [mi6jba49s4hch] PUT /6/role ‚Üí 400 (9ms)[39m
13:48:48 [34mClient acquired from pool[39m
PASS integration __tests__/integration/db/user-role-assignment.test.js
  User Role Assignment - Integration Tests
    PUT /api/users/:id/role - Set/Change User Role
      ‚àö should assign initial role to user as admin (92 ms)
      ‚àö should REPLACE role when assigning different role (one role per user) (61 ms)
      ‚àö should allow reassigning same role (idempotent) (57 ms)
      ‚àö should reject assigning non-existent role (41 ms)
      ‚àö should reject request without role_id (24 ms)
      ‚àö should reject non-admin user (19 ms)
      ‚àö should reject unauthenticated request (14 ms)
      ‚àö should log role assignment in audit_logs (46 ms)
    Complete User Role Workflow
      ‚àö should handle full workflow: create user ‚Üí assign role ‚Üí change role ‚Üí change again (170 ms)
    Role Assignment Error Handling
      ‚àö should handle assignment to non-existent user gracefully (27 ms)
      ‚àö should validate role_id is a number (19 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:48 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:49 [34mNew database client connected to pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mNew database client connected to pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mNew database client connected to pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mNew database client connected to pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mNew database client connected to pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 36ms[39m
13:48:49 [32m‚úÖ [mi6jbaop5gzdt] GET / ‚Üí 200 (38ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 60ms[39m
13:48:49 [32m‚úÖ [mi6jbao6c44tr] GET / ‚Üí 200 (62ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 50ms[39m
13:48:49 [32m‚úÖ [mi6jbaokmpvp8] GET / ‚Üí 200 (53ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 66ms[39m
13:48:49 [32m‚úÖ [mi6jbaoak6to6] GET / ‚Üí 200 (68ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 60ms[39m
13:48:49 [32m‚úÖ [mi6jbaot0rjd5] GET / ‚Üí 200 (62ms)[39m
13:48:49 [34mQuery executed in 62ms[39m
13:48:49 [32m‚úÖ [mi6jbaovrfbe5] GET / ‚Üí 200 (63ms)[39m
13:48:49 [34mQuery executed in 64ms[39m
13:48:49 [32m‚úÖ [mi6jbaowxiaao] GET / ‚Üí 200 (66ms)[39m
13:48:49 [34mQuery executed in 66ms[39m
13:48:49 [32m‚úÖ [mi6jbaoyfcdxa] GET / ‚Üí 200 (68ms)[39m
13:48:49 [34mQuery executed in 69ms[39m
13:48:49 [32m‚úÖ [mi6jbaoz92w0z] GET / ‚Üí 200 (71ms)[39m
13:48:49 [34mQuery executed in 93ms[39m
13:48:49 [32m‚úÖ [mi6jbaogwrsjh] GET / ‚Üí 200 (94ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 28ms[39m
13:48:49 [32m‚úÖ [mi6jbasiln32y] GET / ‚Üí 200 (30ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 28ms[39m
13:48:49 [32m‚úÖ [mi6jbasn2ei27] GET / ‚Üí 200 (29ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 31ms[39m
13:48:49 [32m‚úÖ [mi6jbasqli70o] GET / ‚Üí 200 (33ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 33ms[39m
13:48:49 [32m‚úÖ [mi6jbastbwebz] GET / ‚Üí 200 (34ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 34ms[39m
13:48:49 [32m‚úÖ [mi6jbaswxn5j0] GET / ‚Üí 200 (36ms)[39m
13:48:49 [34mQuery executed in 36ms[39m
13:48:49 [32m‚úÖ [mi6jbasz35t43] GET / ‚Üí 200 (38ms)[39m
13:48:49 [34mQuery executed in 38ms[39m
13:48:49 [32m‚úÖ [mi6jbat13i57k] GET / ‚Üí 200 (40ms)[39m
13:48:49 [34mQuery executed in 40ms[39m
13:48:49 [32m‚úÖ [mi6jbat39tvgi] GET / ‚Üí 200 (41ms)[39m
13:48:49 [34mQuery executed in 42ms[39m
13:48:49 [32m‚úÖ [mi6jbat4yhu45] GET / ‚Üí 200 (44ms)[39m
13:48:49 [34mQuery executed in 43ms[39m
13:48:49 [32m‚úÖ [mi6jbat69c23e] GET / ‚Üí 200 (45ms)[39m
13:48:49 [34mClient acquired from pool[39m
13:48:49 [34mQuery executed in 5ms[39m
13:48:49 [32m‚úÖ [mi6jbave59fb7] GET / ‚Üí 200 (6ms)[39m
PASS integration __tests__/integration/rate-limiting.test.js
  Rate Limiting (P1-6)
    Test Environment Rate Limiting
      ‚àö should bypass rate limiting in test environment (169 ms)
      ‚àö should bypass rate limiting in development environment (117 ms)
    Production Rate Limiting - API Limiter
      ‚àö should enforce 100 requests per 15 minutes limit (2 ms)
      ‚àö should return 429 status with proper error message when rate limit exceeded (1 ms)
      ‚àö should include rate limit headers in response (20 ms)
    Production Rate Limiting - Auth Limiter
      ‚àö should have stricter limits for authentication endpoints (1 ms)
      ‚àö should not count successful authentication attempts against limit (2 ms)
    Production Rate Limiting - Refresh Token Limiter
      ‚àö should enforce 10 refreshes per hour limit (1 ms)
      ‚àö should have 1 hour window for refresh token limits (2 ms)
    Production Rate Limiting - Password Reset Limiter
      ‚àö should enforce 3 password resets per hour limit (2 ms)
      ‚àö should have strictest limits to prevent email spam (1 ms)
    Rate Limit Error Responses
      ‚àö should return standardized error format for rate limit violations (1 ms)
      ‚àö should use HTTP 429 status code for rate limit errors (1 ms)
    Rate Limiting Logging
      ‚àö should log rate limit violations for security monitoring
      ‚àö should log security-relevant information for brute force detection (1 ms)
    Rate Limit Headers
      ‚àö should enable standardHeaders for rate limit information (1 ms)
      ‚àö should disable legacy X-RateLimit headers (1 ms)
    Rate Limiter Configuration Validation
      ‚àö apiLimiter should have 15-minute window and 100 request limit (1 ms)
      ‚àö authLimiter should have 15-minute window and 5 request limit (1 ms)
      ‚àö refreshLimiter should have 1-hour window and 10 request limit (3 ms)
      ‚àö passwordResetLimiter should have 1-hour window and 3 request limit (1 ms)
    Environment-Based Rate Limiter Export
      ‚àö should export bypass limiter in test/dev environments (1 ms)
      ‚àö should export actual rate limiters in production (1 ms)
    Rate Limiting Security Considerations
      ‚àö should protect against brute force attacks with auth limiter (1 ms)
      ‚àö should protect against DoS attacks with general API limiter
      ‚àö should prevent email spam with password reset limiter (1 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/auth.crud.test.js
  routes/auth.js - Profile Operations
    GET /api/auth/me
      ‚àö should return authenticated user profile (21 ms)
      ‚àö should return formatted name when first_name and last_name are present (12 ms)
      ‚àö should return "User" as default name when name fields are missing (11 ms)
    PUT /api/auth/me
      ‚àö should update user profile successfully (17 ms)
      ‚àö should update single field successfully (10 ms)
      ‚àö should filter out disallowed fields (11 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:50 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
13:48:50 [34mNew database client connected to pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîÑ Starting migration check...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ Migration tracking table ready[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müìã Found 8 pending migration(s):[39m
13:48:50 [32m   - 001: add_system_level_fields[39m
13:48:50 [32m   - 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   - 003: add_role_priority[39m
13:48:50 [32m   - 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   - 005: add_deactivation_audit_fields[39m
13:48:50 [32m   - 006: add_performance_indexes[39m
13:48:50 [32m   - 007: add_user_status_field[39m
13:48:50 [32m   - 008: add_work_order_schema[39m
13:48:50 [32m[39m
[32müîç DRY RUN - No changes will be made[39m
[32m[39m
13:48:50 [32müìÑ Migration 001: add_system_level_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 003: add_role_priority[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 005: add_deactivation_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 006: add_performance_indexes[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 007: add_user_status_field[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 008: add_work_order_schema[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîÑ Starting migration check...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ Migration tracking table ready[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müìã Found 8 pending migration(s):[39m
13:48:50 [32m   - 001: add_system_level_fields[39m
13:48:50 [32m   - 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   - 003: add_role_priority[39m
13:48:50 [32m   - 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   - 005: add_deactivation_audit_fields[39m
13:48:50 [32m   - 006: add_performance_indexes[39m
13:48:50 [32m   - 007: add_user_status_field[39m
13:48:50 [32m   - 008: add_work_order_schema[39m
13:48:50 [32m[39m
[32müîç DRY RUN - No changes will be made[39m
[32m[39m
13:48:50 [34mClient removed from pool[39m
13:48:50 [34mClient removed from pool[39m
13:48:50 [34mClient removed from pool[39m
13:48:50 [34mClient removed from pool[39m
13:48:50 [32müìÑ Migration 001: add_system_level_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 003: add_role_priority[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 005: add_deactivation_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 006: add_performance_indexes[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 007: add_user_status_field[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient removed from pool[39m
13:48:50 [32müìÑ Migration 008: add_work_order_schema[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîÑ Starting migration check...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ Migration tracking table ready[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müìã Found 8 pending migration(s):[39m
13:48:50 [32m   - 001: add_system_level_fields[39m
13:48:50 [32m   - 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   - 003: add_role_priority[39m
13:48:50 [32m   - 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   - 005: add_deactivation_audit_fields[39m
13:48:50 [32m   - 006: add_performance_indexes[39m
13:48:50 [32m   - 007: add_user_status_field[39m
13:48:50 [32m   - 008: add_work_order_schema[39m
13:48:50 [32m[39m
[32müîç DRY RUN - No changes will be made[39m
[32m[39m
13:48:50 [32müìÑ Migration 001: add_system_level_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 003: add_role_priority[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 005: add_deactivation_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 006: add_performance_indexes[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 007: add_user_status_field[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 008: add_work_order_schema[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîÑ Starting migration check...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ Migration tracking table ready[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müìã Found 8 pending migration(s):[39m
13:48:50 [32m   - 001: add_system_level_fields[39m
13:48:50 [32m   - 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   - 003: add_role_priority[39m
13:48:50 [32m   - 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   - 005: add_deactivation_audit_fields[39m
13:48:50 [32m   - 006: add_performance_indexes[39m
13:48:50 [32m   - 007: add_user_status_field[39m
13:48:50 [32m   - 008: add_work_order_schema[39m
13:48:50 [32m[39m
[32müîç DRY RUN - No changes will be made[39m
[32m[39m
13:48:50 [32müìÑ Migration 001: add_system_level_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 003: add_role_priority[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 005: add_deactivation_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 006: add_performance_indexes[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 007: add_user_status_field[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 008: add_work_order_schema[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîç Verifying migration integrity...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ All migrations verified - integrity intact[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîç Verifying migration integrity...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [33m‚ö†Ô∏è  Migration integrity issues found:[39m
13:48:50 [33m   - 999_nonexistent: Migration file deleted from disk[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müîÑ Starting migration check...[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32m‚úÖ Migration tracking table ready[39m
13:48:50 [34mClient acquired from pool[39m
13:48:50 [32müìã Found 8 pending migration(s):[39m
13:48:50 [32m   - 001: add_system_level_fields[39m
13:48:50 [32m   - 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   - 003: add_role_priority[39m
13:48:50 [32m   - 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   - 005: add_deactivation_audit_fields[39m
13:48:50 [32m   - 006: add_performance_indexes[39m
13:48:50 [32m   - 007: add_user_status_field[39m
13:48:50 [32m   - 008: add_work_order_schema[39m
13:48:50 [32m[39m
[32müîç DRY RUN - No changes will be made[39m
[32m[39m
13:48:50 [32müìÑ Migration 001: add_system_level_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 001: contract_v2_remove_deprecated_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 003: add_role_priority[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 004: make_audit_logs_user_id_nullable[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 005: add_deactivation_audit_fields[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 006: add_performance_indexes[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 007: add_user_status_field[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [32müìÑ Migration 008: add_work_order_schema[39m
13:48:50 [32m   [DRY RUN] Would execute migration[39m
13:48:50 [34mClient acquired from pool[39m
PASS integration __tests__/integration/migrations.test.js
  Database Migration System
    Migration Tracking Table
      ‚àö should create schema_migrations table on first run (62 ms)
      ‚àö schema_migrations should have required columns (16 ms)
      ‚àö version column should have unique constraint (9 ms)
    Migration Execution
      ‚àö should detect pending migrations (76 ms)
      ‚àö dry run should not modify database (60 ms)
      ‚àö should record migration metadata (11 ms)
    Migration Idempotency
      ‚àö should not reapply already applied migrations (49 ms)
    Migration Integrity
      ‚àö should verify migration checksums (6 ms)
      ‚àö should detect missing migration files (19 ms)
    Migration Ordering
      ‚àö should apply migrations in version order (12 ms)
    Error Handling
      ‚àö should handle database connection errors gracefully (36 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/auth.validation.test.js
  routes/auth.js - Validation & Error Handling
    GET /api/auth/me - Error Handling
      ‚àö should handle errors gracefully (23 ms)
    PUT /api/auth/me - Validation
      ‚àö should return 404 when user not found (16 ms)
      ‚àö should return 400 when no valid fields to update (13 ms)
      ‚àö should handle update errors gracefully (11 ms)
    POST /api/auth/refresh - Validation
      ‚àö should return 400 when refresh token is missing (11 ms)
      ‚àö should return 401 when token is expired (11 ms)
      ‚àö should return 400 for invalid token (9 ms)
    POST /api/auth/logout - Error Handling
      ‚àö should handle missing tokenId in decoded token (11 ms)
      ‚àö should handle invalid refresh token gracefully (10 ms)
      ‚àö should handle errors gracefully (15 ms)
    POST /api/auth/logout-all - Error Handling
      ‚àö should handle errors gracefully (11 ms)
    GET /api/auth/sessions - Error Handling
      ‚àö should handle errors gracefully (11 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:51 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

PASS integration __tests__/integration/api-documentation.test.js
  API Documentation Verification
    Swagger Specification
      ‚àö should have valid OpenAPI 3.0 specification (1 ms)
      ‚àö should have API metadata (1 ms)
      ‚àö should have server configuration (1 ms)
      ‚àö should define security schemes (1 ms)
    API Path Coverage
      ‚àö should document core API paths (1 ms)
      ‚àö should document HTTP methods for each path (2 ms)
    Authentication Documentation
      ‚àö should define Bearer authentication scheme (1 ms)
      ‚àö protected endpoints should reference security (1 ms)
    Response Schema Documentation
      ‚àö should define core response schemas (1 ms)
      ‚àö response schemas should have required properties (1 ms)
    Error Response Documentation
      ‚àö should document error responses (1 ms)
    Request Body Documentation
      ‚àö POST endpoints should document request bodies (1 ms)
      ‚àö PUT/PATCH endpoints should document request bodies (1 ms)
    Documentation Completeness
      ‚àö all paths should have operation descriptions or summaries (2 ms)
      ‚àö all paths should have tags for organization (5 ms)
    Swagger UI Endpoint
      ‚àö should have Swagger specification available (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:51 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:52 [32müîß Using Development Authentication Strategy (JWT with test users)[39m
13:48:52 [33müîÑ AUTH_MODE changed: development ‚Üí auth0[39m
13:48:52 [32müîê Using Auth0 Production Authentication Strategy (OAuth2/OIDC)[39m
PASS integration __tests__/integration/auth-flow.test.js
  Authentication Flow Integration
    Public Endpoints
      ‚àö should access public endpoint without authentication (20 ms)
      ‚àö should access health endpoint (12 ms)
    Protected Endpoints
      ‚àö should reject access without token (11 ms)
      ‚àö should reject invalid token format (11 ms)
      ‚àö should allow access with valid token (12 ms)
    Role-Based Access Control
      ‚àö should allow admin access to admin endpoint (20 ms)
      ‚àö should deny non-admin access to admin endpoint (10 ms)
    Authentication Provider Integration
      ‚àö should use development authentication in test environment (3 ms)
      ‚àö should switch auth providers based on environment (4 ms)
    Token Validation
      ‚àö should validate token expiration (11 ms)
      ‚àö should validate different user roles (40 ms)
    Error Handling
      ‚àö should handle malformed JWT gracefully (10 ms)
      ‚àö should include timestamps in all error responses (11 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/auth.sessions.test.js
  routes/auth.js - Session Management
    POST /api/auth/refresh
      ‚àö should refresh token successfully (17 ms)
      ‚àö should use request helpers for IP and user agent (9 ms)
    POST /api/auth/logout
      ‚àö should logout successfully with refresh token (10 ms)
      ‚àö should logout successfully without refresh token (9 ms)
      ‚àö should use request helpers for IP and user agent (10 ms)
    POST /api/auth/logout-all
      ‚àö should logout from all devices successfully (18 ms)
      ‚àö should handle zero tokens revoked (9 ms)
      ‚àö should use request helpers for IP and user agent (8 ms)
    GET /api/auth/sessions
      ‚àö should return active sessions successfully (9 ms)
      ‚àö should return empty array when no sessions (9 ms)
      ‚àö should hide sensitive token data in response (9 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/roles.validation.test.js
  routes/roles.js - Validation & Error Handling
    GET /api/roles - Error Handling
      ‚àö should return 500 when database error occurs (12 ms)
    GET /api/roles/:id - Error Handling
      ‚àö should return 404 when role not found (18 ms)
      ‚àö should return 500 when database error occurs (10 ms)
    POST /api/roles - Validation
      ‚àö should return 400 when name is missing (17 ms)
      ‚àö should return 400 when name is null (9 ms)
      ‚àö should return 409 when role name already exists (11 ms)
      ‚àö should return 500 when database error occurs during creation (10 ms)
      ‚àö should handle audit logging failure gracefully (8 ms)
      ‚àö should handle Role.create returning undefined (9 ms)
    PUT /api/roles/:id - Validation
      ‚àö should return 404 when role not found before update (8 ms)
      ‚àö should return 400 when attempting to modify protected role (9 ms)
      ‚àö should return 409 when new name already exists (13 ms)
      ‚àö should return 404 when role deleted during update (race condition) (9 ms)
      ‚àö should return 500 when unexpected database error occurs (9 ms)
      ‚àö should handle Role.update returning undefined (9 ms)
    DELETE /api/roles/:id - Validation
      ‚àö should return 400 when attempting to delete protected role (8 ms)
      ‚àö should return 400 when role has assigned users (8 ms)
      ‚àö should return 404 when role not found (9 ms)
      ‚àö should return 500 when unexpected database error occurs (9 ms)
      ‚àö should handle NaN ID gracefully (9 ms)
    Middleware Integration
      ‚àö POST /api/roles should require authentication (8 ms)
      ‚àö PUT /api/roles/:id should validate ID param (9 ms)
      ‚àö DELETE /api/roles/:id should require authentication (11 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:53 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
PASS integration __tests__/integration/error-response-security.test.js
  Error Response Security Audit
    Production Error Sanitization
      ‚àö should NOT expose stack traces in production (14 ms)
      ‚àö should NOT expose database error details (11 ms)
      ‚àö should NOT expose file paths in errors (8 ms)
      ‚àö should NOT expose Auth0 configuration details (11 ms)
      ‚àö should NOT expose JWT secrets or tokens (9 ms)
      ‚àö should NOT expose internal module names (9 ms)
      ‚àö should use generic error message for validation errors (9 ms)
      ‚àö should NOT expose environment variables (14 ms)
    Development vs Production Error Details
      ‚àö should provide detailed errors in development mode (8 ms)
      ‚àö should sanitize errors in production mode (8 ms)
    Sensitive Data Patterns
      ‚àö should NOT expose Email addresses in production errors (8 ms)
      ‚àö should NOT expose IP addresses in production errors (9 ms)
      ‚àö should NOT expose File paths (Unix) in production errors (8 ms)
      ‚àö should NOT expose File paths (Windows) in production errors (9 ms)
      ‚àö should NOT expose Database connection strings in production errors (8 ms)
      ‚àö should NOT expose Auth0 domains in production errors (8 ms)
    HTTP Status Code Consistency
      ‚àö should return 500 for internal errors (8 ms)
      ‚àö should preserve custom status codes (14 ms)
      ‚àö should preserve validation errors (400) (10 ms)
    Error Response Structure
      ‚àö should always return JSON error responses (9 ms)
      ‚àö should include timestamp in error response (10 ms)
      ‚àö should NOT include request details in error response (8 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "newuser@example.com",
      "first_name": "New",
      "last_name": "User",
      "role_id": 2
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "newuser@example.com",
      "first_name": "New",
      "last_name": "User"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "existing@example.com"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "user@example.com"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "user@example.com"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/users.crud.test.js
  Users Routes - CRUD Operations
    GET /api/users
      ‚àö should return all users successfully (12 ms)
      ‚àö should handle database errors gracefully (9 ms)
      ‚àö should return empty array when no users exist (11 ms)
    GET /api/users/:id
      ‚àö should return user by id successfully (15 ms)
      ‚àö should return 404 when user not found (9 ms)
      ‚àö should handle database errors gracefully (9 ms)
      ‚àö should use validatedId from validateIdParam middleware (9 ms)
    POST /api/users
      ‚àö should create a new user successfully (18 ms)
      ‚àö should create user without role_id (defaults to client) (12 ms)
      ‚àö should return 409 for duplicate email (12 ms)
      ‚àö should handle database errors during creation (13 ms)
      ‚àö should handle audit logging failure gracefully (12 ms)
    PUT /api/users/:id
      ‚àö should update user successfully (14 ms)
      ‚àö should return 404 when user not found (10 ms)
      ‚àö should return 400 for no valid fields to update (9 ms)
      ‚àö should handle database errors during update (9 ms)
      ‚àö should update only provided fields (10 ms)
    DELETE /api/users/:id
      ‚àö should delete user successfully (9 ms)
      ‚àö should prevent self-deletion (10 ms)
      ‚àö should return 404 when user not found (9 ms)
      ‚àö should handle database errors during deletion (9 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "existing@example.com"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [USERS POST] Reached validator stage

      at log (routes/users.js:337:13)

  console.log
    [USERS POST] Body: {
      "email": "user@example.com"
    }

      at log (routes/users.js:338:13)

  console.log
    [USERS POST] User: admin@example.com

      at log (routes/users.js:339:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/users.validation.test.js
  Users Routes - Validation & Error Handling
    GET /api/users - Error Handling
      ‚àö should handle database errors gracefully (17 ms)
    GET /api/users/:id - Validation
      ‚àö should return 404 when user not found (10 ms)
      ‚àö should handle database errors gracefully (11 ms)
    POST /api/users - Validation
      ‚àö should return 409 for duplicate email (20 ms)
      ‚àö should handle database errors during creation (14 ms)
    PUT /api/users/:id - Validation
      ‚àö should return 404 when user not found (9 ms)
      ‚àö should return 400 for no valid fields to update (10 ms)
      ‚àö should handle database errors during update (12 ms)
    DELETE /api/users/:id - Validation
      ‚àö should prevent self-deletion (14 ms)
      ‚àö should return 404 when user not found (10 ms)
      ‚àö should handle database errors during deletion (15 ms)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/services/auth.test.js
  Authentication Factory Service
    Factory Pattern Implementation
      ‚àö should be a singleton (3 ms)
      ‚àö should return DevAuthStrategy for development mode (2 ms)
      ‚àö should return Auth0Strategy for auth0 mode (5 ms)
      ‚àö should default to development mode when AUTH_MODE is not set (2 ms)
      ‚àö should handle invalid AUTH_MODE by defaulting to development (2 ms)
    Provider Interface Consistency
      ‚àö DevAuth should implement required methods (1 ms)
      ‚àö Auth0Auth should implement required methods (2 ms)
    Environment-based Configuration
      ‚àö should use constants for provider identification (2 ms)
      ‚àö should handle environment transitions correctly (2 ms)
    Error Handling
      ‚àö should not throw when creating instances (3 ms)
      ‚àö should handle missing environment gracefully (2 ms)
    Factory Reset
      ‚àö should return same strategy instance when mode unchanged (2 ms)
    Production Readiness
      ‚àö should support production configuration (2 ms)
      ‚àö should maintain singleton pattern across different calls (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

13:48:54 [32müß™ Using TEST database[39m {"host":"127.0.0.1","port":5433,"database":"trossapp_test"}
  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

13:48:54 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:54 [32müîê Auth0: Retrieved user info[39m {"email":"test@example.com"}
13:48:54 [32müîê Auth0: Authentication successful[39m {"userId":1,"email":"test@example.com","role":"technician"}
13:48:54 [31müîê Auth0: Authentication failed[39m {"error":"Authorization code is required"}
13:48:54 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:54 [31müîê Auth0: Authentication failed[39m {"error":"Invalid authorization code"}
13:48:54 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:54 [31müîê Auth0: Authentication failed[39m {"error":"Failed to get user info"}
13:48:54 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:54 [32müîê Auth0: Retrieved user info[39m {"email":"test@example.com"}
13:48:54 [31müîê Auth0: Authentication failed[39m {"error":"Database error"}
13:48:54 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:54 [32müîê Auth0: Retrieved user info[39m {"email":"test@example.com"}
13:48:54 [32müîê Auth0: Authentication successful[39m {"userId":1,"email":"test@example.com","role":"technician"}
13:48:55 [31müîê Auth0: Token verification failed[39m {"error":"jwt expired"}
13:48:55 [31müîê Auth0: Token verification failed[39m {"error":"invalid signature"}
13:48:55 [31müîê Auth0: Token verification failed[39m {"error":"jwt audience invalid"}
13:48:55 [32müîê Auth0: Token refreshed successfully[39m
13:48:55 [31müîê Auth0: Token refresh failed[39m {"error":"Invalid refresh token"}
13:48:55 [32müîê Auth0: Logout URL generated[39m {"returnToUrl":"http://localhost:3000"}
13:48:55 [32müîê Auth0: Logout URL generated[39m {"returnToUrl":"http://localhost:8080"}
13:48:55 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:55 [31müîê Auth0: Authentication failed[39m {"error":"Network error"}
13:48:55 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:55 [31müîê Auth0: Authentication failed[39m {"error":"Cannot read properties of null (reading 'access_token')"}
13:48:55 [32müîê Auth0: Exchanging authorization code for tokens[39m
13:48:55 [32müîê Auth0: Retrieved user info[39m {"email":"not-an-email"}
13:48:55 [33m‚ö†Ô∏è  Validation failure[39m {"validator":"toSafeEmail","field":"auth0.email","value":"not-an-email","valueType":"string","reason":"Invalid email format"}
13:48:55 [31müîê Auth0: Authentication failed[39m {"error":"auth0.email must be a valid email address"}
PASS integration __tests__/integration/auth0-integration.test.js
  Auth0Strategy Integration Tests
    Provider Identification
      ‚àö should return "auth0" as provider name (2 ms)
      ‚àö should initialize with Auth0 config (2 ms)
    Authentication Flow
      ‚àö should authenticate with valid authorization code (5 ms)
      ‚àö should throw error when authorization code is missing (16 ms)
      ‚àö should handle token exchange failure (3 ms)
      ‚àö should handle user info retrieval failure (4 ms)
      ‚àö should handle local user creation failure (5 ms)
      ‚àö should use default callback URL when not provided (4 ms)
    Token Verification
      ‚àö should verify valid Auth0 token (2 ms)
      ‚àö should reject expired token (4 ms)
      ‚àö should reject token with invalid signature (4 ms)
      ‚àö should reject token with wrong audience (3 ms)
    User Profile Mapping
      ‚àö should map Auth0 user profile to local format (2 ms)
      ‚àö should handle missing optional fields (1 ms)
      ‚àö should split name when given_name and family_name missing (1 ms)
    Token Refresh
      ‚àö should refresh access token with refresh token (2 ms)
      ‚àö should throw error when refresh token is invalid (18 ms)
    Logout
      ‚àö should generate logout URL (2 ms)
      ‚àö should use default return URL when not provided (4 ms)
    User Profile Retrieval
      ‚àö should get user profile with access token (2 ms)
    Error Handling & Edge Cases
      ‚àö should handle network errors gracefully (3 ms)
      ‚àö should handle malformed Auth0 responses (3 ms)
      ‚àö should reject invalid email format from Auth0 (5 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/work_orders.crud.test.js
  Work Orders Routes - CRUD
    GET /api/work_orders
      ‚àö should return all work orders successfully (12 ms)
      ‚àö should handle database errors (10 ms)
    GET /api/work_orders/:id
      ‚àö should return work order by ID (11 ms)
      ‚àö should return 404 for non-existent work order (19 ms)
      ‚àö should handle database errors (10 ms)
    POST /api/work_orders
      ‚àö should create a new work order successfully (16 ms)
      ‚àö should handle database errors (9 ms)
    PATCH /api/work_orders/:id
      ‚àö should update a work order successfully (10 ms)
      ‚àö should return 404 for non-existent work order (9 ms)
    DELETE /api/work_orders/:id
      ‚àö should soft delete a work order successfully (10 ms)
      ‚àö should return 404 for non-existent work order (9 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/technicians.crud.test.js
  Technicians Routes - CRUD Operations
    GET /api/technicians
      ‚àö should return all technicians successfully (18 ms)
      ‚àö should handle search and filtering (10 ms)
      ‚àö should handle database errors (11 ms)
    GET /api/technicians/:id
      ‚àö should return a technician by ID (10 ms)
      ‚àö should return 404 for non-existent technician (10 ms)
      ‚àö should handle database errors (14 ms)
    POST /api/technicians
      ‚àö should create a new technician successfully (18 ms)
      ‚àö should handle database errors (12 ms)
    PATCH /api/technicians/:id
      ‚àö should update a technician successfully (13 ms)
      ‚àö should return 404 for non-existent technician (11 ms)
    DELETE /api/technicians/:id
      ‚àö should soft delete a technician successfully (11 ms)
      ‚àö should return 404 for non-existent technician (17 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/customers.crud.test.js
  Customers Routes - CRUD Operations
    GET /api/customers
      ‚àö should return all customers successfully (17 ms)
      ‚àö should handle search and filtering (10 ms)
      ‚àö should handle database errors (12 ms)
    GET /api/customers/:id
      ‚àö should return a customer by ID (12 ms)
      ‚àö should return 404 for non-existent customer (8 ms)
      ‚àö should handle database errors (10 ms)
    POST /api/customers
      ‚àö should create a new customer successfully (15 ms)
      ‚àö should handle database errors (15 ms)
    PATCH /api/customers/:id
      ‚àö should update a customer successfully (9 ms)
      ‚àö should return 404 for non-existent customer (10 ms)
    DELETE /api/customers/:id
      ‚àö should soft delete a customer successfully (9 ms)
      ‚àö should return 404 for non-existent customer (9 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/roles.crud.test.js
  routes/roles.js - CRUD Operations
    GET /api/roles
      ‚àö should return paginated roles with count and timestamp (12 ms)
      ‚àö should return empty array when no roles exist (10 ms)
      ‚àö should handle very large result sets with pagination (17 ms)
    GET /api/roles/:id
      ‚àö should return role when found (9 ms)
      ‚àö should handle non-numeric ID gracefully (10 ms)
    POST /api/roles
      ‚àö should create role successfully and log audit (15 ms)
      ‚àö should handle special characters in role names (8 ms)
    PUT /api/roles/:id
      ‚àö should update role successfully and log audit (10 ms)
      ‚àö should use validatedId from middleware (10 ms)
    DELETE /api/roles/:id
      ‚àö should delete role successfully and log audit (9 ms)
      ‚àö should parse ID as integer (9 ms)
      ‚àö should handle concurrent delete requests gracefully (9 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/auth-middleware-security.test.js
  Authentication Middleware - Security
    Development Token Security
      ‚àö should accept development token when devAuthEnabled is true (13 ms)
      ‚àö development token should have null database ID (10 ms)
      ‚àö should reject development token if devAuthEnabled were false (11 ms)
    Auth0 Token Handling
      ‚àö should accept auth0 token in any environment (10 ms)
    Token Validation
      ‚àö should reject token without provider (10 ms)
      ‚àö should reject token with invalid provider (11 ms)
      ‚àö should reject token without sub claim (10 ms)
      ‚àö should reject expired token (9 ms)
      ‚àö should reject request without token (10 ms)
      ‚àö should reject malformed token (9 ms)
    Role-Based Access Control
      ‚àö admin endpoint should accept admin token (15 ms)
      ‚àö admin endpoint should reject non-admin token (10 ms)
    Environment Configuration Integration
      ‚àö middleware should respect AppConfig.devAuthEnabled (1 ms)
      ‚àö AppConfig should be in test environment (2 ms)
      ‚àö security features should be consistent with environment (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/validators/type-coercion.test.js
  Type Coercion Validators - DEFENSIVE TESTING
    toSafeInteger()
      ‚úÖ Valid inputs
        ‚àö accepts valid integer (1 ms)
        ‚àö accepts integer as string and coerces (1 ms)
        ‚àö accepts minimum value (1 by default) (1 ms)
        ‚àö accepts custom minimum value (1 ms)
        ‚àö accepts value within custom range (1 ms)
        ‚àö accepts null when allowNull is true (1 ms)
        ‚àö accepts undefined when allowNull is true (1 ms)
        ‚àö accepts empty string when allowNull is true (1 ms)
      ‚ùå Invalid inputs - null/undefined/empty
        ‚àö rejects null by default (12 ms)
        ‚àö rejects undefined by default (1 ms)
        ‚àö rejects empty string by default (2 ms)
      ‚ùå Invalid inputs - wrong types
        ‚àö rejects non-numeric string (1 ms)
        ‚àö rejects object (2 ms)
        ‚àö coerces array to first element (parseInt behavior) (1 ms)
        ‚àö rejects boolean true (1 ms)
        ‚àö rejects boolean false (1 ms)
        ‚àö rejects decimal number (coerces to integer) (1 ms)
        ‚àö rejects NaN (1 ms)
        ‚àö rejects Infinity (1 ms)
      ‚ùå Invalid inputs - range violations
        ‚àö rejects negative number (below min) (1 ms)
        ‚àö rejects zero (below default min of 1) (2 ms)
        ‚àö rejects value above custom max (2 ms)
        ‚àö rejects value below custom min (1 ms)
      üîÑ Type coercion edge cases
        ‚àö coerces string "0" to 0 when min allows (1 ms)
        ‚àö coerces numeric string with whitespace (1 ms)
        ‚àö coerces string with leading zeros (1 ms)
        ‚àö handles large safe integers (1 ms)
    toSafeUserId()
      ‚àö accepts valid integer userId (1 ms)
      ‚àö returns null for any string userId (dev token handling) (1 ms)
      ‚àö handles null gracefully (1 ms)
      ‚àö handles undefined gracefully (1 ms)
      ‚àö rejects negative userId (1 ms)
    toSafeString()
      ‚úÖ Valid inputs
        ‚àö accepts valid string (1 ms)
        ‚àö trims whitespace by default (1 ms)
        ‚àö accepts string with minLength constraint (1 ms)
        ‚àö accepts string with maxLength constraint (1 ms)
        ‚àö accepts null when allowNull is true (2 ms)
        ‚àö coerces number to string (1 ms)
        ‚àö preserves whitespace when trim is false (1 ms)
      ‚ùå Invalid inputs
        ‚àö rejects null by default (1 ms)
        ‚àö rejects undefined by default (1 ms)
        ‚àö rejects empty string by default (1 ms)
        ‚àö rejects string below minLength (1 ms)
        ‚àö rejects string above maxLength (2 ms)
        ‚àö rejects whitespace-only string after trim (1 ms)
    toSafeEmail()
      ‚úÖ Valid emails
        ‚àö accepts standard email (13 ms)
        ‚àö normalizes to lowercase (1 ms)
        ‚àö accepts email with subdomains (1 ms)
        ‚àö accepts email with numbers (1 ms)
        ‚àö accepts email with dots (1 ms)
        ‚àö accepts email with hyphens (1 ms)
        ‚àö trims whitespace (1 ms)
        ‚àö accepts null when allowNull is true (1 ms)
      ‚ùå Invalid emails
        ‚àö rejects null by default (1 ms)
        ‚àö rejects email without @ (2 ms)
        ‚àö rejects email without domain (1 ms)
        ‚àö rejects email without TLD (1 ms)
        ‚àö rejects email with spaces (2 ms)
        ‚àö rejects empty string (1 ms)
        ‚àö rejects malformed email (multiple @) (1 ms)
    toSafeBoolean()
      ‚úÖ Valid booleans
        ‚àö accepts true (1 ms)
        ‚àö accepts false (1 ms)
        ‚àö coerces "true" string to true (1 ms)
        ‚àö coerces "false" string to false (1 ms)
        ‚àö coerces 1 to true
        ‚àö coerces 0 to false
      ‚ùå Invalid inputs
        ‚àö returns default value for null (defaultValue parameter) (1 ms)
        ‚àö returns default value for undefined (1 ms)
        ‚àö returns default value for empty string (1 ms)
        ‚àö coerces other strings to true (JS behavior) (1 ms)
    toSafeUuid()
      ‚úÖ Valid UUIDs
        ‚àö accepts valid UUID v4 (1 ms)
        ‚àö accepts UUID with uppercase (1 ms)
        ‚àö accepts null when allowNull is true (1 ms)
      ‚ùå Invalid UUIDs
        ‚àö rejects null by default (2 ms)
        ‚àö rejects non-string (1 ms)
        ‚àö rejects invalid UUID format (1 ms)
        ‚àö rejects UUID with wrong version (v1) (1 ms)
        ‚àö rejects UUID with wrong length (1 ms)
        ‚àö rejects empty string (2 ms)
    toSafePagination()
      ‚úÖ Valid pagination
        ‚àö returns defaults when no query provided (1 ms)
        ‚àö accepts valid page and limit (1 ms)
        ‚àö calculates offset correctly (1 ms)
        ‚àö respects custom limits (1 ms)
      ‚ùå Invalid pagination
        ‚àö rejects negative page (2 ms)
        ‚àö rejects zero page (1 ms)
        ‚àö rejects limit above max (1 ms)
        ‚àö rejects invalid page string (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/schema.test.js
  Schema Routes
    GET /api/schema
      ‚àö should return list of tables (30 ms)
      ‚àö should handle service errors (10 ms)
    GET /api/schema/:tableName
      ‚àö should return table schema (14 ms)
      ‚àö should return 404 for non-existent table (11 ms)
      ‚àö should handle other service errors as 500 (11 ms)
    GET /api/schema/:tableName/options/:column
      ‚àö should return foreign key options (12 ms)
      ‚àö should return 400 for non-foreign-key column (10 ms)
      ‚àö should return 400 for non-existent column (12 ms)
      ‚àö should handle service errors (11 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/config/permissions-loader.test.js
  Permission System - Data-Driven Tests
    Configuration Loading
      ‚àö should load permissions from config file (2 ms)
      ‚àö should cache loaded config (3 ms)
    Role Hierarchy
      ‚àö should have at least 5 roles (1 ms)
      ‚àö should have unique priorities (1 ms)
      ‚àö should have priorities as positive integers (2 ms)
      ‚àö should include standard roles (1 ms)
    Permission Matrix
      ‚àö should have permissions for core resources (13 ms)
      ‚àö should have all CRUD operations for each resource (3 ms)
      ‚àö should only use valid role priorities (3 ms)
    getRolePriority()
      ‚àö should return correct priority for valid roles (2 ms)
      ‚àö should be case-insensitive (2 ms)
      ‚àö should return null for unknown roles (2 ms)
      ‚àö should return null for invalid inputs (1 ms)
    hasPermission()
      ‚àö should allow admin all permissions (15 ms)
      ‚àö should enforce role hierarchy (higher roles inherit lower permissions) (52 ms)
      ‚àö should be case-insensitive for role names (2 ms)
      ‚àö should return false for unknown roles (2 ms)
      ‚àö should return false for unknown resources (1 ms)
      ‚àö should return false for unknown operations (1 ms)
      ‚àö should return false for null/undefined inputs (1 ms)
    hasMinimumRole()
      ‚àö should return true when user role >= required role (3 ms)
      ‚àö should return false when user role < required role (2 ms)
      ‚àö should be case-insensitive (2 ms)
      ‚àö should return false for unknown roles (2 ms)
      ‚àö should return false for null/undefined inputs (2 ms)
    getMinimumRole()
      ‚àö should return minimum role for each permission (10 ms)
      ‚àö should return null for unknown resource/operation (1 ms)
    getRowLevelSecurity()
      ‚àö should return RLS policy for valid role/resource (2 ms)
      ‚àö should return null for resources without RLS (1 ms)
      ‚àö should be case-insensitive for role names (1 ms)
      ‚àö should return null for unknown roles (2 ms)
      ‚àö should return null for unknown resources (1 ms)
      ‚àö should have getRLSRule alias for getRowLevelSecurity (1 ms)
      ‚àö should return deny_all for technician access to contracts (1 ms)
      ‚àö should return "assigned_work_orders_only" for technician work_orders (1 ms)
      ‚àö should validate all RLS rules match expected patterns (3 ms)
    Permission Validation
      ‚àö should ensure client has explicitly granted permissions only (7 ms)
      ‚àö should ensure no permission gaps (all operations defined) (3 ms)
    Data-Driven Behavior
      ‚àö should validate tests work regardless of permission values (3 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/users.relationships.test.js
  Users Routes - Role Relationships
    PUT /api/users/:id/role
      ‚àö should assign role successfully (18 ms)
      ‚àö should handle string role_id by converting to number (14 ms)
      ‚àö should return 400 for invalid role_id format (12 ms)
      ‚àö should return 404 when role not found (10 ms)
      ‚àö should handle database errors during role assignment (12 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/invoices.crud.test.js
  Invoices Routes - CRUD
    ‚àö should get all invoices (17 ms)
    ‚àö should get invoice by ID (10 ms)
    ‚àö should create invoice (15 ms)
    ‚àö should update invoice (10 ms)
    ‚àö should delete invoice (10 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/roles.relationships.test.js
  routes/roles.js - Relationships
    GET /api/roles/:id/users
      ‚àö should return users for given role with pagination (12 ms)
      ‚àö should return empty array when no users have the role (19 ms)
      ‚àö should return 500 when database error occurs (10 ms)
      ‚àö should handle role with many users efficiently (11 ms)
      ‚àö should handle non-numeric role ID gracefully (13 ms)
      ‚àö should handle role ID that does not exist (9 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/technicians.relationships.test.js
  Technicians Routes - Relationships
    ‚àö should be a placeholder for future relationship endpoints (3 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/inventory.crud.test.js
  Inventory Routes - CRUD
    ‚àö should get all inventory items (12 ms)
    ‚àö should get inventory item by ID (9 ms)
    ‚àö should create inventory item (16 ms)
    ‚àö should update inventory item (11 ms)
    ‚àö should delete inventory item (9 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/contracts.crud.test.js
  Contracts Routes - CRUD
    ‚àö should get all contracts (18 ms)
    ‚àö should get contract by ID (10 ms)
    ‚àö should create contract (15 ms)
    ‚àö should update contract (9 ms)
    ‚àö should delete contract (9 ms)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/validators/middleware.test.js
  Validator Middleware - Route Protection
    validateIdParam()
      ‚úÖ Valid IDs
        ‚àö validates numeric ID and calls next() (2 ms)
        ‚àö validates string numeric ID (1 ms)
        ‚àö handles ID value of 1 (minimum) (1 ms)
      ‚ùå Invalid IDs
        ‚àö rejects missing ID with 400 (1 ms)
        ‚àö rejects non-numeric ID (2 ms)
        ‚àö rejects negative ID (1 ms)
        ‚àö rejects zero ID (1 ms)
        ‚àö includes timestamp in error response (1 ms)
    validateIdParams()
      ‚àö validates multiple ID params (1 ms)
      ‚àö rejects if any param is invalid (2 ms)
      ‚àö validates single param in array (2 ms)
    validatePagination()
      ‚úÖ Valid pagination
        ‚àö uses defaults when no query params (11 ms)
        ‚àö validates custom page and limit (2 ms)
        ‚àö accepts page 1 with custom limit (1 ms)
        ‚àö respects maxLimit of 200 (2 ms)
      ‚ùå Invalid pagination
        ‚àö rejects negative page (2 ms)
        ‚àö rejects zero page (2 ms)
        ‚àö rejects non-numeric page (1 ms)
        ‚àö rejects limit above 200 (1 ms)
        ‚àö rejects zero limit (1 ms)
        ‚àö rejects negative limit (2 ms)
        ‚àö includes error details in response (1 ms)
    validateSlugParam()
      ‚úÖ Valid slugs
        ‚àö validates lowercase slug (1 ms)
        ‚àö validates slug with numbers (3 ms)
        ‚àö validates single word slug (2 ms)
      ‚ùå Invalid slugs
        ‚àö rejects slug with uppercase (2 ms)
        ‚àö rejects slug with spaces (2 ms)
        ‚àö rejects slug with special characters (1 ms)
        ‚àö rejects empty slug (1 ms)
    req.validated object
      ‚àö validateIdParam sets req.validated.id (2 ms)
      ‚àö validatePagination sets req.validated.pagination (1 ms)

PASS unit __tests__/unit/models/Role.crud.test.js
  Role Model - CRUD Operations
    findAll()
      ‚àö should return paginated roles ordered by priority (2 ms)
      ‚àö should return empty data array when no roles exist (1 ms)
      ‚àö should handle database errors (11 ms)
    findById()
      ‚àö should return role by ID (1 ms)
      ‚àö should return undefined for non-existent role ID (2 ms)
      ‚àö should handle database errors (3 ms)
      ‚àö should accept string ID (parameterized query handles conversion) (1 ms)
    getByName()
      ‚àö should return role by name (case-sensitive query) (1 ms)
      ‚àö should return undefined for non-existent role name (2 ms)
      ‚àö should handle database errors (1 ms)
      ‚àö should query with exact name provided (no normalization) (1 ms)
    create()
      ‚àö should create new role with normalized name and default priority (1 ms)
      ‚àö should normalize role name to lowercase (2 ms)
      ‚àö should trim whitespace from role name (1 ms)
    update()
      ‚àö should update role name successfully (2 ms)
      ‚àö should normalize updated name to lowercase (1 ms)
      ‚àö should trim whitespace from updated name (1 ms)
      ‚àö should update is_active field without audit fields (2 ms)
      ‚àö should update multiple fields including is_active (1 ms)
    delete()
      ‚àö should delete unprotected role with no assigned users (2 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [ValidationLoader] ‚úÖ Loaded validation rules v2.0.0

      at log (utils/validation-loader.js:30:13)

  console.log
    [ValidationLoader] üìã Loaded validation rules v2.0.0

      at Object.log (validators/body-validators.js:19:11)

  console.log
    [ValidationLoader] üìä Available operations: createUser, updateUser, createRole, updateRole, createCustomer, updateCustomer, createTechnician, updateTechnician, createWorkOrder, updateWorkOrder, createInvoice, updateInvoice, createContract, updateContract, createInventory, updateInventory

      at Object.log (validators/body-validators.js:20:11)

  console.log
    [ValidationLoader] üéØ Policy: {"email":{"tldValidation":"permissive","description":"Accept any TLD format - no fascist restrictions! üöÄ"}}

      at Object.log (validators/body-validators.js:21:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/routes/customers.relationships.test.js
  Customers Routes - Relationships
    ‚àö should be a placeholder for future relationship endpoints (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/middleware/timeout.test.js
  Timeout Middleware
    requestTimeout
      ‚àö should set timeout tracking on request (4 ms)
      ‚àö should trigger timeout after configured duration (2 ms)
      ‚àö should log timeout with context (2 ms)
      ‚àö should not send response if headers already sent (1 ms)
      ‚àö should call custom onTimeout handler (2 ms)
      ‚àö should clear timeout when response finishes (2 ms)
      ‚àö should log very slow requests (2 ms)
      ‚àö should log slow requests (2 ms)
      ‚àö should skip if request already timed out (2 ms)
      ‚àö should handle custom timeout handler errors gracefully (2 ms)
    timeoutHandler
      ‚àö should pass through if request not timed out (2 ms)
      ‚àö should send timeout response if not already sent (2 ms)
      ‚àö should not send response if headers already sent (1 ms)
    Helper Functions
      quickTimeout
        ‚àö should create 5 second timeout middleware (2 ms)
      longTimeout
        ‚àö should create 90 second timeout middleware (2 ms)
      getRequestDuration
        ‚àö should return duration since request start (2 ms)
        ‚àö should return 0 if no startTime (2 ms)
      isTimeoutImminent
        ‚àö should return true when timeout approaching (1 ms)
        ‚àö should return false when plenty of time remaining (2 ms)
        ‚àö should return false if no timeout configured (14 ms)
      getRemainingTime
        ‚àö should return remaining milliseconds (2 ms)
        ‚àö should return 0 if timeout exceeded (1 ms)
        ‚àö should return Infinity if no timeout configured (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/User.crud.test.js
  User Model - CRUD Operations
    findByAuth0Id()
      ‚àö should find user by Auth0 ID with role (2 ms)
      ‚àö should return null when user not found (1 ms)
    findById()
      ‚àö should find user by ID with role (2 ms)
      ‚àö should return null when user not found (1 ms)
    findAll()
      ‚àö should return paginated users with roles (2 ms)
      ‚àö should return empty data array when no users exist (2 ms)
    createFromAuth0()
      ‚àö should create user from Auth0 data with default customer role (1 ms)
      ‚àö should create user with specified role from token (1 ms)
      ‚àö should handle missing optional fields (names) (1 ms)
    findOrCreate()
      ‚àö should return existing user when found (1 ms)
      ‚àö should create new user when not found (2 ms)
    create()
      ‚àö should create user with specified role_id (1 ms)
      ‚àö should default to customer role when role_id not provided (1 ms)
      ‚àö should handle missing optional fields (2 ms)
    update()
      ‚àö should update user with valid fields (1 ms)
      ‚àö should update only provided fields (2 ms)
      ‚àö should filter out non-allowed fields (2 ms)
      ‚àö should ignore undefined values (2 ms)
      ‚àö should update is_active field without audit fields (1 ms)
      ‚àö should update fields normally (1 ms)
    delete()
      ‚àö should permanently delete user from database (2 ms)
      ‚àö should throw error when user not found (14 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/validators/query-validators.test.js
  Query Validators
    validatePagination
      ‚àö should set default pagination (2 ms)
      ‚àö should parse page and limit from query (1 ms)
      ‚àö should use custom limits (2 ms)
      ‚àö should reject invalid page number (1 ms)
      ‚àö should initialize req.validated if not present (1 ms)
    validateSearch
      ‚àö should validate search query (2 ms)
      ‚àö should trim search query (1 ms)
      ‚àö should accept "q" as alias for search (1 ms)
      ‚àö should reject search below minimum length (1 ms)
      ‚àö should reject search above maximum length (2 ms)
      ‚àö should reject empty search when required (2 ms)
      ‚àö should pass through when search not required and not provided (1 ms)
    validateSort
      ‚àö should validate sort with default field (2 ms)
      ‚àö should parse sortBy from query (1 ms)
      ‚àö should parse sortOrder from query (1 ms)
      ‚àö should accept "sort" as alias for sortBy (2 ms)
      ‚àö should accept "order" as alias for sortOrder (1 ms)
      ‚àö should reject invalid sort field (2 ms)
      ‚àö should reject invalid sort order (2 ms)
      ‚àö should use custom default field (1 ms)
      ‚àö should use custom default order (2 ms)
      ‚àö should throw if no allowed fields provided (16 ms)
    validateFilters
      ‚àö should validate integer filter (2 ms)
      ‚àö should validate boolean filter (2 ms)
      ‚àö should validate string filter (2 ms)
      ‚àö should trim string filters (2 ms)
      ‚àö should skip optional filters (2 ms)
      ‚àö should reject string filter not in allowed list (2 ms)
      ‚àö should reject non-string value for string filter (1 ms)
    validateQuery
      ‚àö should validate search query (1 ms)
      ‚àö should accept "q" as search alias (1 ms)
      ‚àö should validate filters (2 ms)
      ‚àö should validate operator-based filters (2 ms)
      ‚àö should validate sort parameters (2 ms)
      ‚àö should reject invalid sortBy (2 ms)
      ‚àö should reject invalid sortOrder (2 ms)
      ‚àö should reject search exceeding max length (2 ms)
      ‚àö should handle empty search gracefully (2 ms)
      ‚àö should initialize req.validated if not present (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/services/user-data.test.js
  UserDataService
    getAllUsers
      ‚àö should return test users in config mode (3 ms)
      ‚àö should query database in production mode (3 ms)
    getUserByAuth0Id
      ‚àö should find test user by auth0_id in config mode (2 ms)
      ‚àö should return null for unknown auth0_id in config mode (2 ms)
      ‚àö should query database by auth0_id in production mode (1 ms)
    findOrCreateUser
      ‚àö should return existing test user in config mode (1 ms)
      ‚àö should call User.findOrCreate in production mode (1 ms)
    isConfigMode
      ‚àö should return true when USE_TEST_AUTH=true and NODE_ENV=development (1 ms)
      ‚àö should return false in production (1 ms)
      ‚àö should return false when USE_TEST_AUTH=false even in development (1 ms)

PASS unit __tests__/unit/models/Role.validation.test.js
  Role Model - Validation
    isProtected()
      ‚àö should return true for admin role (1 ms)
      ‚àö should return true for customer role (1 ms)
      ‚àö should return true for admin role (uppercase) (1 ms)
      ‚àö should return true for customer role (mixed case) (2 ms)
      ‚àö should return false for non-protected roles (1 ms)
      ‚àö should return false for custom roles (1 ms)
      ‚àö should handle empty string (1 ms)
    create() - Validation
      ‚àö should reject null name (12 ms)
      ‚àö should reject undefined name (1 ms)
      ‚àö should reject non-string name (2 ms)
      ‚àö should reject empty string after trim (1 ms)
      ‚àö should reject empty string (2 ms)
      ‚àö should handle duplicate role name error (1 ms)
      ‚àö should handle generic database errors (1 ms)
    update() - Validation
      ‚àö should reject update with null ID (2 ms)
      ‚àö should reject update with null name (1 ms)
      ‚àö should reject update with non-string name (2 ms)
      ‚àö should reject update with empty name after trim (1 ms)
      ‚àö should reject update for non-existent role (2 ms)
      ‚àö should reject update for protected role (admin) (2 ms)
      ‚àö should reject update for protected role (customer) (1 ms)
      ‚àö should handle duplicate name error (2 ms)
      ‚àö should handle update returning no rows (race condition) (1 ms)
      ‚àö should propagate other database errors (1 ms)
    delete() - Validation
      ‚àö should reject delete with null ID (2 ms)
      ‚àö should reject delete with undefined ID (11 ms)
      ‚àö should reject delete for non-existent role (1 ms)
      ‚àö should reject delete for protected role (admin) (1 ms)
      ‚àö should reject delete for protected role (customer) (1 ms)
      ‚àö should reject delete when users are assigned to role (1 ms)
      ‚àö should handle count as integer string (1 ms)
      ‚àö should handle count as integer number (1 ms)
      ‚àö should handle DELETE returning no rows (race condition) (2 ms)
      ‚àö should propagate database errors (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/app-config.test.js
  AppConfig
    App Identity
      ‚àö should have app name set to "Tross" (2 ms)
      ‚àö should have version defined (1 ms)
      ‚àö should have description defined (1 ms)
    Environment Detection
      ‚àö should detect current environment (1 ms)
      ‚àö should have boolean environment flags (2 ms)
      ‚àö should only have one environment flag true (1 ms)
      ‚àö isDevelopment and isProduction should be opposites when not test (2 ms)
    Feature Flags
      ‚àö devAuthEnabled should be true in test/dev, false in prod (1 ms)
      ‚àö healthMonitoringEnabled should be true (1 ms)
      ‚àö verboseLogging should be true in test/dev (1 ms)
      ‚àö swaggerEnabled should be true only in development (1 ms)
    Server Configuration
      ‚àö should have valid port number (1 ms)
      ‚àö should have host defined (1 ms)
      ‚àö should have CORS configuration (1 ms)
      ‚àö CORS origin should be array (1 ms)
    Database Configuration
      ‚àö should have database config (1 ms)
      ‚àö should have connection pool settings (1 ms)
    Redis Configuration
      ‚àö should have redis config (2 ms)
      ‚àö redis db should be valid number (1 ms)
    Auth0 Configuration
      ‚àö should have Auth0 config (2 ms)
      ‚àö Auth0 domain should be valid format (1 ms)
      ‚àö Auth0 audience should be valid URL (1 ms)
    JWT Configuration
      ‚àö should have JWT config (1 ms)
      ‚àö JWT expiry should be valid format (2 ms)
    Health Check Configuration
      ‚àö should have health check config (1 ms)
      ‚àö timeout should be less than check interval (1 ms)
    Rate Limiting Configuration
      ‚àö should have rate limit config (1 ms)
    Security Helpers
      validateDevAuth
        ‚àö should not throw when devAuthEnabled is true (1 ms)
        ‚àö should throw when devAuthEnabled is false (2 ms)
        ‚àö error message should mention security (1 ms)
      getSafeConfig
        ‚àö should return configuration object (1 ms)
        ‚àö should not include sensitive data (2 ms)
        ‚àö should include app identity (2 ms)
        ‚àö should include feature flags (1 ms)
      validate
        ‚àö should not throw in test environment (1 ms)
        ‚àö should have validate method (1 ms)
    Integration
      ‚àö configuration should be internally consistent (1 ms)
      ‚àö app identity should be consistent (1 ms)
      ‚àö all required top-level properties exist (11 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Technician.rls.test.js
  Technician Model - RLS Tests
    _buildRLSFilter()
      ‚àö should return no filter when req is null (2 ms)
      ‚àö should return no filter when rlsPolicy is missing (2 ms)
      ‚àö should return security failsafe (1=0) for unknown policy (1 ms)
      ‚àö should return no filter for all_records policy (2 ms)
      ‚àö should return technician filter for own_record_only policy (1 ms)
      ‚àö should return security failsafe when userId missing for own_record_only (1 ms)
    _applyRLSFilter()
      ‚àö should return existing WHERE unchanged when no RLS policy (1 ms)
      ‚àö should return existing WHERE unchanged for all_records policy (2 ms)
      ‚àö should add RLS filter when no existing WHERE clause (1 ms)
      ‚àö should combine RLS with existing WHERE clause (1 ms)
      ‚àö should adjust parameter placeholders correctly (2 ms)
      ‚àö should handle security failsafe (1=0) clause (1 ms)
    findById() with RLS
      ‚àö should work without RLS context (2 ms)
      ‚àö should apply all_records RLS policy (no filtering) (2 ms)
      ‚àö should apply own_record_only RLS policy (1 ms)
      ‚àö should return null when RLS blocks access (1 ms)
    findAll() with RLS
      ‚àö should work without RLS context (1 ms)
      ‚àö should apply all_records RLS policy (no filtering) (1 ms)
      ‚àö should apply own_record_only RLS policy (2 ms)
      ‚àö should combine RLS with search and filters (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/services/query-builder-service.test.js
  QueryBuilderService
    buildSearchClause
      ‚àö should build ILIKE search clause for single field (1 ms)
      ‚àö should build ILIKE search clause for multiple fields with OR (1 ms)
      ‚àö should handle search term with spaces (trimmed) (1 ms)
      ‚àö should handle special characters safely (parameterized) (1 ms)
      ‚àö should return null clause when search term is empty (1 ms)
      ‚àö should return null clause when search term is whitespace only (1 ms)
      ‚àö should return null clause when no searchable fields provided (1 ms)
      ‚àö should return null clause when searchTerm is undefined (2 ms)
      ‚àö should return null clause when searchTerm is null (1 ms)
    buildFilterClause
      ‚àö should build exact match filter for single field (2 ms)
      ‚àö should build multiple filters with AND (1 ms)
      ‚àö should respect paramOffset for combining clauses (1 ms)
      ‚àö should handle greater than operator (1 ms)
      ‚àö should handle greater than or equal operator (1 ms)
      ‚àö should handle less than operator (1 ms)
      ‚àö should handle less than or equal operator (1 ms)
      ‚àö should handle not equal operator (1 ms)
      ‚àö should handle IN operator with array (1 ms)
      ‚àö should handle IN operator with comma-separated string (1 ms)
      ‚àö should handle multiple operators on same field
      ‚àö should ignore unauthorized fields (SECURITY) (1 ms)
      ‚àö should return null clause when no filters provided (1 ms)
      ‚àö should return null clause when filters is undefined (1 ms)
      ‚àö should return null clause when all fields unauthorized (1 ms)
    buildSortClause
      ‚àö should build valid sort clause (2 ms)
      ‚àö should handle lowercase sort order (1 ms)
      ‚àö should handle DESC order (1 ms)
      ‚àö should use default sort when sortBy invalid (1 ms)
      ‚àö should use default order when sortOrder invalid (1 ms)
      ‚àö should use first sortable field when no default provided
      ‚àö should use id ASC as ultimate fallback
      ‚àö should prevent SQL injection in sort field (only whitelisted) (1 ms)
    combineWhereClauses
      ‚àö should combine multiple clauses with AND (1 ms)
      ‚àö should filter out null clauses (1 ms)
      ‚àö should filter out empty string clauses
      ‚àö should return null when no valid clauses (1 ms)
      ‚àö should return single clause unchanged (1 ms)
      ‚àö should handle empty array (1 ms)
    combineParams
      ‚àö should combine multiple parameter arrays (1 ms)
      ‚àö should flatten nested arrays (1 ms)
      ‚àö should filter out null/undefined values (1 ms)
      ‚àö should handle empty arrays (1 ms)
    buildQuery
      ‚àö should build complete query with search, filters, and sort (2 ms)
      ‚àö should build query with only search (1 ms)
      ‚àö should build query with only filters (1 ms)
      ‚àö should build query with only sort (1 ms)
      ‚àö should build query with no options (defaults only) (1 ms)
      ‚àö should handle complex filters with operators (1 ms)

  console.log
    [Permissions] ‚úÖ Configuration validation passed

      at log (config/permissions-loader.js:133:11)

  console.log
    [Permissions] ‚úÖ Loaded permission config from C:\Users\zarik\OneDrive\Desktop\TrossApp\config\permissions.json

      at log (config/permissions-loader.js:52:13)

  console.log
    [Permissions] üìä Roles: 5

      at log (config/permissions-loader.js:53:13)

  console.log
    [Permissions] üìä Resources: 9

      at log (config/permissions-loader.js:54:13)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/middleware/row-level-security.test.js
  Row-Level Security Middleware
    enforceRLS(resource)
      ‚àö should attach RLS policy to request when policy exists (3 ms)
      ‚àö should attach null policy when no RLS defined (2 ms)
      ‚àö should handle different RLS policies for different resources (1 ms)
      ‚àö should reject request when user has no role (2 ms)
      ‚àö should reject request when user is missing (2 ms)
      ‚àö should call getRLSRule with correct parameters (1 ms)
      ‚àö should handle null policy for roles with no access (1 ms)
      ‚àö should preserve user ID for filtering (1 ms)
      ‚àö should handle dispatcher with all_records policy (11 ms)
    validateRLSApplied(req, result)
      ‚àö should pass when RLS was applied (2 ms)
      ‚àö should throw when RLS was not applied (14 ms)
      ‚àö should pass when no RLS enforcement is required (3 ms)
      ‚àö should pass when RLS policy is null (no filtering required) (2 ms)
      ‚àö should throw when result is null (2 ms)
      ‚àö should throw when result is undefined (2 ms)
      ‚àö should include error context in exception (3 ms)
    Integration with Role Hierarchy
      ‚àö should apply different policies for customer vs dispatcher (2 ms)
      ‚àö should handle work_orders with technician role (2 ms)
      ‚àö should handle contracts with technician role (null access) (1 ms)
    Error Response Format
      ‚àö should return standardized error structure (2 ms)
      ‚àö should include ISO timestamp in error response (1 ms)

PASS unit __tests__/unit/models/User.validation.test.js
  User Model - Validation
    findByAuth0Id() - Validation
      ‚àö should throw error when Auth0 ID is missing (19 ms)
      ‚àö should handle database errors gracefully (1 ms)
    findById() - Validation
      ‚àö should throw error when ID is missing (5 ms)
      ‚àö should handle database errors gracefully (1 ms)
    findAll() - Error Handling
      ‚àö should handle database errors gracefully (1 ms)
    createFromAuth0() - Validation
      ‚àö should throw error when Auth0 ID is missing (1 ms)
      ‚àö should throw error when email is missing (2 ms)
      ‚àö should handle duplicate Auth0 ID constraint violation (3 ms)
      ‚àö should handle duplicate email constraint violation (1 ms)
      ‚àö should handle generic database errors (1 ms)
    findOrCreate() - Validation
      ‚àö should throw error when auth0Data is missing (2 ms)
      ‚àö should propagate errors from findByAuth0Id (2 ms)
      ‚àö should propagate errors from createFromAuth0 (1 ms)
    create() - Validation
      ‚àö should throw error when email is missing (2 ms)
      ‚àö should handle duplicate email constraint violation (1 ms)
      ‚àö should handle generic database errors (1 ms)
    update() - Validation
      ‚àö should throw error when user ID is missing (1 ms)
      ‚àö should throw error when updates is missing or invalid (1 ms)
      ‚àö should throw error when no valid fields to update (1 ms)
      ‚àö should throw error when user not found (2 ms)
      ‚àö should handle duplicate email constraint violation (1 ms)
      ‚àö should handle generic database errors (2 ms)
    delete() - Validation
      ‚àö should throw error when user ID is missing (2 ms)
      ‚àö should throw error when user not found (1 ms)
      ‚àö should handle database errors during deletion (12 ms)

PASS unit __tests__/unit/models/WorkOrder.rls.test.js
  WorkOrder Model - RLS Tests
    _buildRLSFilter()
      ‚àö should return no filter when req is null (2 ms)
      ‚àö should return no filter when rlsPolicy is missing (1 ms)
      ‚àö should return security failsafe (1=0) for unknown policy (2 ms)
      ‚àö should return no filter for all_records policy (1 ms)
      ‚àö should return customer filter for own_work_orders_only policy (2 ms)
      ‚àö should return technician filter for assigned_work_orders_only policy (1 ms)
      ‚àö should return security failsafe when userId missing for own_work_orders_only (2 ms)
      ‚àö should return security failsafe when userId missing for assigned_work_orders_only (1 ms)
    _applyRLSFilter()
      ‚àö should return existing WHERE unchanged when no RLS policy (1 ms)
      ‚àö should return existing WHERE unchanged for all_records policy (1 ms)
      ‚àö should add customer RLS filter when no existing WHERE clause (1 ms)
      ‚àö should add technician RLS filter when no existing WHERE clause (1 ms)
      ‚àö should combine customer RLS with existing WHERE clause (1 ms)
      ‚àö should combine technician RLS with existing WHERE clause (2 ms)
      ‚àö should adjust parameter placeholders correctly (1 ms)
      ‚àö should handle security failsafe (1=0) clause (2 ms)
    findById() with RLS
      ‚àö should work without RLS context (2 ms)
      ‚àö should apply all_records RLS policy (no filtering) (1 ms)
      ‚àö should apply own_work_orders_only RLS policy (customer) (1 ms)
      ‚àö should apply assigned_work_orders_only RLS policy (technician) (2 ms)
      ‚àö should return null when customer RLS blocks access (1 ms)
      ‚àö should return null when technician RLS blocks access (1 ms)
    findAll() with RLS
      ‚àö should work without RLS context (1 ms)
      ‚àö should apply all_records RLS policy (no filtering) (2 ms)
      ‚àö should apply own_work_orders_only RLS policy (customer) (1 ms)
      ‚àö should apply assigned_work_orders_only RLS policy (technician) (2 ms)
      ‚àö should combine customer RLS with search and filters (1 ms)
      ‚àö should combine technician RLS with search and filters (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Customer.rls.test.js
  Customer Model - Row-Level Security
    _buildRLSFilter()
      ‚àö should return own_record_only filter for customer role (2 ms)
      ‚àö should return all_records filter (no clause) for technician+ (2 ms)
      ‚àö should return no filter when req is null (1 ms)
      ‚àö should return no filter when rlsPolicy is null (2 ms)
      ‚àö should return deny-all filter for unknown policy (10 ms)
    _applyRLSFilter()
      ‚àö should combine RLS filter with existing WHERE clause (1 ms)
      ‚àö should handle empty existing WHERE clause (2 ms)
      ‚àö should handle all_records policy with existing WHERE (1 ms)
      ‚àö should not apply RLS when req is null (1 ms)
      ‚àö should correctly number parameters (1 ms)
    findById() with RLS
      ‚àö should apply RLS filter when req provided (1 ms)
      ‚àö should not apply RLS when req not provided (2 ms)
      ‚àö should return null when RLS blocks access (1 ms)
    findAll() with RLS
      ‚àö should apply RLS filter for customer role (1 ms)
      ‚àö should not filter for technician+ (all_records) (1 ms)
      ‚àö should work without RLS when req not provided (1 ms)
      ‚àö should combine RLS with search and filters (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Inventory.crud.test.js
  Inventory Model - CRUD
    ‚àö should find all inventory items (2 ms)
    ‚àö should find by ID (1 ms)
    ‚àö should create (1 ms)
    ‚àö should update (1 ms)
    ‚àö should delete (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/validators/param-validators.test.js
  Param Validators
    validateIdParam
      ‚àö should validate valid ID and attach to req.validated (2 ms)
      ‚àö should validate custom param name (1 ms)
      ‚àö should reject non-numeric ID (1 ms)
      ‚àö should reject ID below minimum (2 ms)
      ‚àö should reject ID above maximum (1 ms)
      ‚àö should coerce string numbers to integers (2 ms)
      ‚àö should coerce floating point to integer (2 ms)
      ‚àö should initialize req.validated if not present (1 ms)
    validateIdParams
      ‚àö should validate multiple ID parameters (1 ms)
      ‚àö should reject if any parameter is invalid (2 ms)
      ‚àö should validate single parameter in array (1 ms)
      ‚àö should initialize req.validated if not present (2 ms)
    validateSlugParam
      ‚àö should validate valid slug (1 ms)
      ‚àö should validate slug with numbers (1 ms)
      ‚àö should validate custom param name (1 ms)
      ‚àö should reject uppercase letters (1 ms)
      ‚àö should reject special characters (12 ms)
      ‚àö should reject empty slug (1 ms)
      ‚àö should reject slug below minimum length (1 ms)
      ‚àö should reject slug above maximum length (2 ms)
      ‚àö should trim whitespace (1 ms)
      ‚àö should reject spaces in slug (1 ms)
      ‚àö should reject underscores in slug (2 ms)
      ‚àö should initialize req.validated if not present (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/WorkOrder.crud.test.js
  WorkOrder Model - CRUD Operations
    findAll()
      ‚àö should return paginated work orders (2 ms)
      ‚àö should return empty array when no work orders exist (1 ms)
    findById()
      ‚àö should return work order by ID (2 ms)
      ‚àö should return null for non-existent work order (1 ms)
    create()
      ‚àö should create a new work order (1 ms)
    update()
      ‚àö should update an existing work order (2 ms)
    delete()
      ‚àö should soft delete a work order (2 ms)

PASS unit __tests__/unit/models/User.relationships.test.js
  User Model - Relationships
    setRole()
      ‚àö should set user role successfully (2 ms)
      ‚àö should throw error when user ID is missing (17 ms)
      ‚àö should throw error when role ID is missing (2 ms)
      ‚àö should throw error when user not found (2 ms)
      ‚àö should handle database errors (1 ms)
    Role Data in Queries
      ‚àö should include role name in findById results (2 ms)
      ‚àö should include role name in findByAuth0Id results (1 ms)
      ‚àö should include role name in findAll results (2 ms)
    Foreign Key Constraints
      ‚àö should handle invalid role_id when creating user (1 ms)
      ‚àö should handle invalid role_id when setting role (2 ms)
    Role Assignment Operations
      ‚àö should successfully change user from client to manager (1 ms)
      ‚àö should successfully promote user to admin (1 ms)
      ‚àö should successfully demote user to client (2 ms)

PASS unit __tests__/unit/models/Invoice.rls.test.js
  Invoice Model - RLS Tests
    _buildRLSFilter()
      ‚àö should return no filter when req is null (2 ms)
      ‚àö should return no filter when rlsPolicy is missing (1 ms)
      ‚àö should return security failsafe (1=0) for null policy (technician) (1 ms)
      ‚àö should return security failsafe (1=0) for unknown policy (1 ms)
      ‚àö should return no filter for all_records policy (1 ms)
      ‚àö should return customer filter for own_invoices_only policy (1 ms)
      ‚àö should return security failsafe when userId missing for own_invoices_only (2 ms)
    _applyRLSFilter()
      ‚àö should return existing WHERE unchanged when no RLS policy (2 ms)
      ‚àö should return existing WHERE unchanged for all_records policy (1 ms)
      ‚àö should add customer RLS filter when no existing WHERE clause (1 ms)
      ‚àö should add null policy failsafe (1=0) when no existing WHERE clause (1 ms)
      ‚àö should combine customer RLS with existing WHERE clause (1 ms)
      ‚àö should combine null policy failsafe with existing WHERE clause (1 ms)
      ‚àö should adjust parameter placeholders correctly (2 ms)
    findById() with RLS
      ‚àö should work without RLS context (1 ms)
      ‚àö should apply all_records RLS policy (no filtering) (2 ms)
      ‚àö should apply own_invoices_only RLS policy (customer) (1 ms)
      ‚àö should apply null policy (technician - no access) (1 ms)
      ‚àö should return null when customer RLS blocks access (2 ms)
    findAll() with RLS
      ‚àö should work without RLS context (2 ms)
      ‚àö should apply all_records RLS policy (no filtering) (1 ms)
      ‚àö should apply own_invoices_only RLS policy (customer) (1 ms)
      ‚àö should apply null policy (technician - no access) (1 ms)
      ‚àö should combine customer RLS with search and filters (1 ms)
      ‚àö should combine null policy with filters (technician blocked) (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/config/timeouts.test.js
  Timeouts Configuration
    TIMEOUTS constants
      ‚àö should define SERVER timeouts (2 ms)
      ‚àö should define REQUEST timeouts (1 ms)
      ‚àö should define DATABASE timeouts (1 ms)
      ‚àö should define DATABASE test timeouts (2 ms)
      ‚àö should define SERVICES timeouts (1 ms)
      ‚àö should define MONITORING thresholds (1 ms)
      ‚àö should be frozen (immutable) (1 ms)
    getTimeoutConfig
      ‚àö should return production config by default (2 ms)
      ‚àö should return test config for test environment (1 ms)
      ‚àö should accept environment parameter (1 ms)
    validateTimeoutHierarchy
      ‚àö should validate successfully with current constants
      ‚àö should enforce timeout hierarchy rules (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/config/constants.test.js
  Constants Service
    ENVIRONMENTS
      ‚àö should have all required environment constants (2 ms)
      ‚àö should have string values for all environments (2 ms)
    AUTH
      ‚àö should have AUTH_MODES with correct values (1 ms)
      ‚àö should have PROVIDERS with correct values (1 ms)
      ‚àö should have JWT config with required properties (1 ms)
      ‚àö should ensure AUTH_MODES and PROVIDERS have matching values (1 ms)
    USER_ROLES
      ‚àö should have all required user roles (1 ms)
      ‚àö should have consistent role naming (lowercase values) (2 ms)
      ‚àö should have unique role values (1 ms)
      ‚àö should contain expected role hierarchy (1 ms)
    HTTP_STATUS
      ‚àö should have all required HTTP status codes (2 ms)
      ‚àö should have numeric values for all status codes (2 ms)
      ‚àö should follow HTTP status code standards (1 ms)
    API_ENDPOINTS
      ‚àö should have all required API endpoints (2 ms)
      ‚àö should have valid endpoint paths (1 ms)
      ‚àö should have consistent endpoint structure (1 ms)
    Constants Integration
      ‚àö should export all main constant groups (1 ms)
      ‚àö should ensure no undefined or null values (2 ms)
      ‚àö should maintain constant immutability (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/services/schema-introspection.test.js
  SchemaIntrospectionService - Business Logic
    getTableSchema
      ‚àö should return enriched schema with all metadata (3 ms)
    getAllTables
      ‚àö should return all public schema tables with display names (1 ms)
    Type Mapping Logic
      ‚àö should map PostgreSQL numeric types correctly (1 ms)
      ‚àö should map PostgreSQL text types correctly (1 ms)
      ‚àö should map PostgreSQL boolean correctly (1 ms)
    UI Type Inference Logic
      ‚àö should infer email input for email columns (1 ms)
      ‚àö should infer url input for url columns (1 ms)
      ‚àö should infer tel input for phone columns (1 ms)
      ‚àö should infer select dropdown for foreign keys (1 ms)
    Label Generation Logic
      ‚àö should convert snake_case to Title Case (2 ms)
      ‚àö should use special labels for known fields (1 ms)
    Readonly Field Logic
      ‚àö should mark system fields as readonly (1 ms)
      ‚àö should mark user fields as editable (1 ms)
    Searchable Field Logic
      ‚àö should mark text fields as searchable (1 ms)
      ‚àö should not mark id and timestamp fields as searchable (1 ms)
    getForeignKeyOptions
      ‚àö should return foreign key dropdown options (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/services/pagination-service.test.js
  PaginationService
    validateParams()
      ‚àö should use defaults when no options provided (2 ms)
      ‚àö should validate page parameter (1 ms)
      ‚àö should validate limit parameter (1 ms)
      ‚àö should enforce max limit (200 by default) (1 ms)
      ‚àö should allow custom max limit (1 ms)
      ‚àö should cap limit at custom max when exceeded (1 ms)
      ‚àö should enforce minimum page of 1 (1 ms)
      ‚àö should enforce minimum page for negative values (1 ms)
      ‚àö should enforce minimum limit of 1 (1 ms)
      ‚àö should calculate correct offset (1 ms)
      ‚àö should handle string inputs (type coercion) (1 ms)
    generateMetadata()
      ‚àö should generate correct metadata for first page (1 ms)
      ‚àö should generate correct metadata for middle page (1 ms)
      ‚àö should generate correct metadata for last page
      ‚àö should handle partial last page (1 ms)
      ‚àö should handle single page (1 ms)
      ‚àö should handle empty results (1 ms)
      ‚àö should handle page beyond total pages gracefully (1 ms)
    buildLimitClause()
      ‚àö should build correct SQL LIMIT/OFFSET clause (1 ms)
      ‚àö should handle zero offset (1 ms)
    paginate() - Complete Workflow
      ‚àö should combine validation and metadata generation (1 ms)
      ‚àö should work with defaults (1 ms)
    DEFAULTS
      ‚àö should export default constants (1 ms)

PASS unit __tests__/unit/models/User.rls.test.js
  User Model - RLS Tests
    _buildRLSFilter()
      ‚àö should return no filter when req is null (2 ms)
      ‚àö should return no filter when rlsPolicy is missing (2 ms)
      ‚àö should return security failsafe (1=0) for unknown policy (1 ms)
      ‚àö should return no filter for all_records policy (2 ms)
      ‚àö should return user filter for own_record_only policy (1 ms)
      ‚àö should return security failsafe when userId missing for own_record_only (1 ms)
    _applyRLSFilter()
      ‚àö should return existing WHERE unchanged when no RLS policy (1 ms)
      ‚àö should return existing WHERE unchanged for all_records policy (1 ms)
      ‚àö should add user RLS filter when no existing WHERE clause (1 ms)
      ‚àö should combine user RLS with existing WHERE clause (1 ms)
      ‚àö should adjust parameter placeholders correctly (2 ms)
    findById() with RLS
      ‚àö should work without RLS context (1 ms)
      ‚àö should apply all_records RLS policy (no filtering) (2 ms)
      ‚àö should apply own_record_only RLS policy (customer) (2 ms)
      ‚àö should return null when customer RLS blocks access (1 ms)
    findAll() with RLS
      ‚àö should work without RLS context (1 ms)
      ‚àö should apply all_records RLS policy (no filtering) (2 ms)
      ‚àö should apply own_record_only RLS policy (customer) (1 ms)
      ‚àö should combine customer RLS with filters (1 ms)

PASS unit __tests__/unit/models/Contract.rls.test.js
  Contract Model - RLS Tests
    _buildRLSFilter()
      ‚àö should return no filter when req is null (2 ms)
      ‚àö should return no filter when rlsPolicy is missing (1 ms)
      ‚àö should return security failsafe (1=0) for null policy (technician) (2 ms)
      ‚àö should return security failsafe (1=0) for unknown policy (1 ms)
      ‚àö should return no filter for all_records policy (1 ms)
      ‚àö should return customer filter for own_contracts_only policy (2 ms)
      ‚àö should return security failsafe when userId missing for own_contracts_only (2 ms)
    _applyRLSFilter()
      ‚àö should return existing WHERE unchanged when no RLS policy (1 ms)
      ‚àö should return existing WHERE unchanged for all_records policy (2 ms)
      ‚àö should add customer RLS filter when no existing WHERE clause (1 ms)
      ‚àö should add null policy failsafe (1=0) when no existing WHERE clause (1 ms)
      ‚àö should combine customer RLS with existing WHERE clause (1 ms)
      ‚àö should combine null policy failsafe with existing WHERE clause (1 ms)
      ‚àö should adjust parameter placeholders correctly (1 ms)
    findById() with RLS
      ‚àö should work without RLS context (2 ms)
      ‚àö should apply all_records RLS policy (no filtering) (1 ms)
      ‚àö should apply own_contracts_only RLS policy (customer) (1 ms)
      ‚àö should apply null policy (technician - no access) (2 ms)
      ‚àö should return null when customer RLS blocks access (1 ms)
    findAll() with RLS
      ‚àö should work without RLS context (2 ms)
      ‚àö should apply all_records RLS policy (no filtering) (1 ms)
      ‚àö should apply own_contracts_only RLS policy (customer) (1 ms)
      ‚àö should apply null policy (technician - no access) (2 ms)
      ‚àö should combine customer RLS with search and filters (1 ms)
      ‚àö should combine null policy with filters (technician blocked) (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/utils/request-helpers.test.js
  utils/request-helpers.js
    getClientIp()
      ‚àö should return req.ip when available (1 ms)
      ‚àö should fallback to req.connection.remoteAddress when req.ip is undefined (1 ms)
      ‚àö should fallback to req.connection.remoteAddress when req.ip is null (1 ms)
      ‚àö should fallback to req.connection.remoteAddress when req.ip is empty string (1 ms)
      ‚àö should return "unknown" when connection is null (1 ms)
      ‚àö should return "unknown" when connection is undefined (1 ms)
      ‚àö should return "unknown" when connection has no remoteAddress (1 ms)
      ‚àö should handle IPv6 addresses (1 ms)
    getUserAgent()
      ‚àö should return user-agent header when present (1 ms)
      ‚àö should return undefined when user-agent header missing (1 ms)
      ‚àö should return undefined when headers object missing (7 ms)
      ‚àö should handle empty user-agent string (1 ms)
    getAuditMetadata()
      ‚àö should return both ip and userAgent (1 ms)
      ‚àö should handle missing user-agent (1 ms)
      ‚àö should use fallback IP when req.ip unavailable (1 ms)
      ‚àö should handle completely missing request data (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/middleware/rate-limit.test.js
  Rate Limit Middleware
    Limiter Exports
      ‚àö should export apiLimiter as function (1 ms)
      ‚àö should export authLimiter as function (1 ms)
      ‚àö should export refreshLimiter as function (2 ms)
      ‚àö should export passwordResetLimiter as function (1 ms)
    Test Environment Bypass
      ‚àö should bypass apiLimiter in test env (2 ms)
      ‚àö should bypass authLimiter in test env (1 ms)
      ‚àö should bypass refreshLimiter in test env (1 ms)
      ‚àö should bypass passwordResetLimiter in test env (1 ms)
    Multiple Calls
      ‚àö should allow unlimited calls in test env (no rate limiting) (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Invoice.crud.test.js
  Invoice Model - CRUD
    ‚àö should find all invoices (2 ms)
    ‚àö should find by ID (1 ms)
    ‚àö should create (1 ms)
    ‚àö should update (2 ms)
    ‚àö should delete (1 ms)

PASS unit __tests__/unit/services/audit-service.queries.test.js
  services/audit-service.js - Query Operations
    getUserAuditTrail()
      ‚àö should return audit trail for specific user (3 ms)
      ‚àö should use custom limit when provided (1 ms)
      ‚àö should order results by created_at DESC (1 ms)
    getSecurityEvents()
      ‚àö should return security events within time window (1 ms)
      ‚àö should use custom hours and limit when provided (2 ms)
      ‚àö should filter by LOGIN_FAILED and UNAUTHORIZED_ACCESS (2 ms)
      ‚àö should order results by created_at DESC (1 ms)
    getResourceAuditTrail()
      ‚àö should return audit trail for specific resource (1 ms)
      ‚àö should use custom limit when provided (1 ms)
    getFailedLoginAttempts()
      ‚àö should return count of failed login attempts (2 ms)
      ‚àö should use custom time window when provided (1 ms)
      ‚àö should convert string count to integer (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/WorkOrder.validation.test.js
  WorkOrder Model - Validation
    Status transitions
      ‚àö should validate status values (1 ms)
    Priority levels
      ‚àö should validate priority values (1 ms)
    Required fields
      ‚àö should require title and customer_id (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Inventory.validation.test.js
  Inventory Model - Validation
    ‚àö should require name and quantity (2 ms)
    ‚àö should validate quantity is non-negative (1 ms)

PASS unit __tests__/unit/models/Customer.crud.test.js
  Customer Model - CRUD Operations
    findAll()
      ‚àö should return paginated customers (3 ms)
      ‚àö should handle empty results (2 ms)
    findById()
      ‚àö should return customer by ID (1 ms)
      ‚àö should return null for non-existent customer (2 ms)
    create()
      ‚àö should create a new customer (2 ms)
    update()
      ‚àö should update a customer (1 ms)
    delete()
      ‚àö should hard delete a customer (1 ms)
      ‚àö should throw error if customer not found (10 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Inventory.relationships.test.js
  Inventory Model - Relationships
    ‚àö should be independent (no foreign keys) (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/validators/validation-logger.test.js
  Validation Logger
    logValidationFailure
      ‚àö should log validation failure at warning level (2 ms)
      ‚àö should stringify object values (2 ms)
      ‚àö should work without context (1 ms)
    logTypeCoercion
      ‚àö should log type coercion in development (1 ms)
      ‚àö should not log in production (1 ms)
      ‚àö should not log in test env (2 ms)
      ‚àö should stringify object values (2 ms)
    logValidationSuccess
      ‚àö should log success at debug level (2 ms)

PASS unit __tests__/unit/models/Technician.crud.test.js
  Technician Model - CRUD Operations
    findAll()
      ‚àö should return paginated technicians (2 ms)
      ‚àö should handle empty results (2 ms)
    findById()
      ‚àö should return technician by ID (1 ms)
      ‚àö should return null for non-existent technician (2 ms)
    create()
      ‚àö should create a new technician (1 ms)
    update()
      ‚àö should update a technician (1 ms)
    delete()
      ‚àö should hard delete a technician (1 ms)
      ‚àö should throw error if technician not found (9 ms)

PASS unit __tests__/unit/models/Role.relationships.test.js
  Role Model - Relationships
    getUsersByRole()
      ‚àö should return all active users for a role with pagination (2 ms)
      ‚àö should return empty array when no users have the role (1 ms)
      ‚àö should order users by first_name and last_name (1 ms)
      ‚àö should only return active users (2 ms)
      ‚àö should handle database errors (7 ms)
      ‚àö should accept string role ID and pagination options (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Invoice.relationships.test.js
  Invoice Model - Relationships
    ‚àö should belong to customer (2 ms)
    ‚àö should optionally link to work_order (1 ms)

PASS unit __tests__/unit/services/audit-service.crud.test.js
  services/audit-service.js - Core Operations
    log()
      ‚àö should log audit entry with all fields (2 ms)
      ‚àö should use default values for optional fields (1 ms)
      ‚àö should stringify oldValues and newValues objects (2 ms)
      ‚àö should handle null values for oldValues and newValues (2 ms)
      ‚àö should log failed actions with error details (1 ms)
      ‚àö should handle undefined values correctly (1 ms)
    cleanupOldLogs()
      ‚àö should delete logs older than specified days (1 ms)
      ‚àö should use default retention of 365 days (1 ms)
      ‚àö should log info when logs are deleted (1 ms)
      ‚àö should not log when no logs deleted (1 ms)
      ‚àö should return 0 when no logs found to delete (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Contract.crud.test.js
  Contract Model - CRUD
    ‚àö should find all contracts (2 ms)
    ‚àö should find by ID (2 ms)
    ‚àö should create (2 ms)
    ‚àö should update (1 ms)
    ‚àö should delete (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/WorkOrder.relationships.test.js
  WorkOrder Model - Relationships
    Customer relationship
      ‚àö should belong to a customer (2 ms)
    Technician relationship
      ‚àö should optionally have an assigned technician (2 ms)
    Invoice relationship
      ‚àö should optionally have an associated invoice (1 ms)

PASS unit __tests__/unit/models/Role.rls.test.js
  Role Model - Row-Level Security
    _buildRLSFilter
      ‚àö should return no filtering for null policy (customer role) (5 ms)
      ‚àö should return no filtering for null policy (technician role) (3 ms)
      ‚àö should return no filtering for null policy (dispatcher role) (4 ms)
      ‚àö should return no filtering for null policy (admin role) (3 ms)
      ‚àö should return no filtering when req is null (3 ms)
      ‚àö should return no filtering when req is undefined (1 ms)
    _applyRLSFilter
      ‚àö should not modify WHERE clause for null policy (2 ms)
      ‚àö should not modify WHERE clause when no existing WHERE (1 ms)
      ‚àö should handle req = null without modification (1 ms)
    findById with RLS
      ‚àö should fetch role without filtering (null policy) (1 ms)
      ‚àö should fetch role without req (backward compatibility) (1 ms)
      ‚àö should return undefined when role not found (1 ms)
    findAll with RLS
      ‚àö should fetch all roles without filtering (null policy) (1 ms)
      ‚àö should fetch all roles without req (backward compatibility) (1 ms)
      ‚àö should work with search and filters (no RLS interference) (13 ms)
    Null policy semantics
      ‚àö should confirm null policy means "no filtering" not "deny all" (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Invoice.validation.test.js
  Invoice Model - Validation
    ‚àö should require customer_id and amount (1 ms)
    ‚àö should validate status values (1 ms)

PASS unit __tests__/unit/models/Inventory.rls.test.js
  Inventory Model - Row-Level Security
    _buildRLSFilter
      ‚àö should return no filtering for null policy (customer role) (2 ms)
      ‚àö should return no filtering for null policy (technician role) (1 ms)
      ‚àö should return no filtering for null policy (dispatcher role) (2 ms)
      ‚àö should return no filtering for null policy (admin role) (1 ms)
      ‚àö should return no filtering when req is null (1 ms)
      ‚àö should return no filtering when req is undefined (1 ms)
    _applyRLSFilter
      ‚àö should not modify WHERE clause for null policy (2 ms)
      ‚àö should not modify WHERE clause when no existing WHERE (1 ms)
      ‚àö should handle req = null without modification (1 ms)
    findById with RLS
      ‚àö should fetch inventory without filtering (null policy) (1 ms)
      ‚àö should fetch inventory without req (backward compatibility) (2 ms)
      ‚àö should return null when inventory not found (1 ms)
    findAll with RLS
      ‚àö should fetch all inventory without filtering (null policy) (1 ms)
      ‚àö should fetch all inventory without req (backward compatibility) (1 ms)
      ‚àö should work with search and filters (no RLS interference) (1 ms)
    Null policy semantics for inventory
      ‚àö should confirm null policy means "no filtering" for management resource (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Contract.validation.test.js
  Contract Model - Validation
    ‚àö should require customer_id (1 ms)
    ‚àö should validate status values (1 ms)

PASS unit __tests__/unit/services/audit-service.validation.test.js
  services/audit-service.js - Validation & Error Handling
    log() - Error Handling
      ‚àö should handle database errors gracefully without throwing (8 ms)
    getUserAuditTrail() - Error Handling
      ‚àö should handle database errors (1 ms)
      ‚àö should return empty array when no logs found (1 ms)
    getSecurityEvents() - Error Handling
      ‚àö should handle database errors (2 ms)
    getResourceAuditTrail() - Error Handling
      ‚àö should handle database errors (2 ms)
      ‚àö should return empty array when no logs found (1 ms)
    getFailedLoginAttempts() - Error Handling
      ‚àö should return 0 on database error (fail open) (2 ms)
      ‚àö should return 0 when no attempts found (1 ms)
    cleanupOldLogs() - Error Handling
      ‚àö should handle database errors (1 ms)

PASS unit __tests__/unit/models/Technician.validation.test.js
  Technician Model - Validation
    License Number Validation
      ‚àö should reject duplicate license_number (8 ms)
      ‚àö should reject null license_number (3 ms)
    Status Validation
      ‚àö should accept valid status values (2 ms)
      ‚àö should reject invalid status values (2 ms)
    Field Constraints
      ‚àö should handle missing optional fields (1 ms)
      ‚àö should accept JSONB fields for skills and certifications (2 ms)
      ‚àö should accept decimal hourly_rate (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (../node_modules/dotenv/lib/main.js:142:11)

PASS unit __tests__/unit/models/Contract.relationships.test.js
  Contract Model - Relationships
    ‚àö should belong to customer (1 ms)

PASS unit __tests__/unit/models/Customer.validation.test.js
  Customer Model - Validation
    Email Validation
      ‚àö should reject duplicate email (9 ms)
      ‚àö should reject null email (3 ms)
    Status Validation
      ‚àö should accept valid status values (2 ms)
      ‚àö should reject invalid status values (1 ms)
    Field Constraints
      ‚àö should handle missing optional fields (2 ms)
      ‚àö should accept JSONB fields for addresses (1 ms)

PASS unit __tests__/unit/models/Technician.relationships.test.js
  Technician Model - Relationships
    ‚àö should be a placeholder for future relationship methods (1 ms)

PASS unit __tests__/unit/models/Customer.relationships.test.js
  Customer Model - Relationships
    ‚àö should be a placeholder for future relationship methods (1 ms)

Test Suites: 98 passed, 98 total
Tests:       1675 passed, 1675 total
Snapshots:   0 total
Time:        68.354 s
Ran all test suites in 2 projects.
